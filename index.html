<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Froot</title>
<meta name="theme-color" content="#0b0d11">
<style>
:root{
  --bg:#090b10;            /* darker backdrop so tint pops */
  --fg:#edf0f7;
  --muted:#a9b0bc;
  --accent:#8a7bf0;
  --line:rgba(160,170,190,.22);
  --glass:rgba(18,22,30,.36);   /* core glass fill */
  --glass-strong:rgba(18,22,30,.48);
  --glow:rgba(138,123,240,.28);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--fg);
  font:500 16px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
  /* faint vertical reflection streaks behind everything */
  background-image:
    radial-gradient(1600px 400px at 15% -10%, rgba(138,123,240,.10), transparent 60%),
    radial-gradient(1200px 500px at 85% -15%, rgba(88,70,210,.08), transparent 65%),
    linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0) 18%, rgba(255,255,255,.015) 40%, rgba(255,255,255,0) 70%);
  background-attachment: fixed;
}
.wrap{position:relative; z-index:2; max-width:980px; margin:0 auto; padding:24px; display:flex; flex-direction:column; gap:16px}
h1{font-size:28px;margin:0 0 6px;letter-spacing:.3px}
p.lead{margin:0;color:#d3d7e0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* ===== Mirror Glass ===== */
.glass{
  position:relative;
  background:var(--glass);
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  backdrop-filter: blur(14px) saturate(125%);
  -webkit-backdrop-filter: blur(14px) saturate(125%);
  box-shadow:
    0 1px 0 rgba(255,255,255,.05) inset,
    0 12px 40px rgba(0,0,0,.40),
    0 0 0 1px rgba(255,255,255,.02) inset;
}
.glass::before{
  /* bevel highlight */
  content:""; pointer-events:none; position:absolute; inset:0; border-radius:18px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0) 30%),
    radial-gradient(400px 80px at 50% 0%, rgba(255,255,255,.18), transparent 70%);
  mix-blend-mode:screen; opacity:.45;
}
.glass-dense{ background:var(--glass-strong); }

/* Controls & inputs */
button,input,select{background:rgba(20,24,32,.55);color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:inherit}
button{cursor:pointer;transition:transform .12s ease,opacity .12s ease, box-shadow .12s ease}
button:active{transform:scale(.98)}
button.primary{background:var(--accent);border-color:var(--accent);color:#0b0d11;font-weight:700; box-shadow:0 0 0 2px rgba(138,123,240,.25)}
button.ghost{background:transparent}
button:disabled{opacity:.55;cursor:not-allowed}
.badge{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#d7dbe4;background:rgba(20,24,32,.45)}
.badge.ok{border-color:#2b9c4a;color:#a9e8b7}
.badge.fail{border-color:#a33f3f;color:#ffb6b6}
.small{font-size:12px;color:#bcc3cf}
.range{width:160px}

/* Grid + list */
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
@media (max-width:960px){.grid{grid-template-columns:1fr}}
.list{display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto}
.item{
  display:flex;gap:8px;align-items:center;justify-content:space-between;
  background:rgba(15,18,26,.55); border:1px solid var(--line); border-radius:14px; padding:10px 12px;
  transition:box-shadow .16s ease, outline .16s ease, background .16s ease
}
.item.active{
  box-shadow:0 0 0 2px var(--glow) inset, 0 0 24px var(--glow);
  background:rgba(18,22,30,.62);
}
.item .meta{display:flex;flex-direction:column;gap:2px;min-width:0}
.item .t{font-weight:600;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:420px}
.item .c{font-size:12px;color:#b6bbc6;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;max-width:420px}

footer{color:var(--muted);font-size:13px;text-align:center;padding:10px}

/* Hero reflection aura */
.hero{
  padding:18px;border-radius:18px;
}
.hero .halo{
  position:absolute; inset:-2px; border-radius:20px; pointer-events:none; mix-blend-mode:screen; opacity:.32;
  background:
    radial-gradient(1000px 160px at 20% -10%, rgba(138,123,240,.20), transparent 60%),
    radial-gradient(800px 160px at 80% -20%, rgba(108,185,255,.18), transparent 60%);
}

/* Tint sits BELOW the glass so color shines through */
.tint{
  position:fixed; inset:0; pointer-events:none; z-index:0;
  background:transparent; opacity:0;
  mix-blend-mode:color; transition:opacity .2s;
}
.wrap{z-index:2; position:relative}

/* chips + whispers */
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer;background:rgba(20,24,32,.45)}
.chip.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--glow) inset}
.toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:rgba(16,20,28,.75);border:1px solid var(--line);color:#edeef6;padding:10px 14px;border-radius:999px;opacity:0;pointer-events:none;transition:opacity .18s ease; z-index:3}
.toast.show{opacity:1}
.whisper{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(16,19,27,.80);border:1px solid var(--line);color:#edeef6;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .2s ease; z-index:3}
.whisper.show{opacity:1}

/* Editor sheet (glass) */
.sheet{
  position:fixed;left:50%;bottom:0;transform:translateX(-50%);
  width:min(680px,92vw); background:rgba(15,18,26,.65);
  border:1px solid var(--line); border-top-left-radius:16px;border-top-right-radius:16px;
  padding:14px 14px 18px; box-shadow:0 -12px 40px rgba(0,0,0,.45);
  backdrop-filter: blur(14px) saturate(120%);
  -webkit-backdrop-filter: blur(14px) saturate(120%);
  opacity:0; pointer-events:none; transition:opacity .15s ease, transform .18s ease; z-index:4;
}
.sheet.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0)}
.sheet h3{margin:0 0 6px;font-size:18px}
.sheet .row{align-items:flex-end}
.sheet .col{display:flex;flex-direction:column;gap:6px;min-width:140px}

/* Links */
a.hush{color:#cbd1dc;text-decoration:none;border-bottom:1px dotted var(--line)}

/* Play container glass rim */
.player-glass{
  border-radius:14px; padding:10px; background:rgba(18,22,30,.45);
  border:1px solid var(--line);
  backdrop-filter: blur(10px) saturate(120%);
  -webkit-backdrop-filter: blur(10px) saturate(120%);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.03), 0 0 24px var(--glow);
}

/* Accessibility niceties */
button:focus, select:focus, input:focus{outline:2px solid rgba(138,123,240,.55); outline-offset:2px}
.stickybar{position:sticky;top:10px;z-index:2}
</style>
</head>
<body>
<!-- Tint layer BELOW glass so color shines through -->
<div class="tint" id="tint"></div>
<div id="toast" class="toast">Copied</div>
<div id="whisper" class="whisper"></div>

<div class="wrap">
  <!-- HERO (glass mirror) -->
  <div class="glass hero">
    <div class="halo"></div>
    <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap">
      <div>
        <h1>Froot</h1>
        <p class="lead">A quiet room to listen with me—one path, one feeling at a time.</p>
      </div>
      <div class="small">No tracking • Official titles • Single file</div>
    </div>

    <div class="row stickybar" aria-label="Player controls" style="gap:8px">
      <button id="btnStart" class="primary">Begin</button>
      <button id="btnPrev" aria-label="Back">Back</button>
      <button id="btnPlayPause" aria-live="polite">Play</button>
      <button id="btnNext" aria-label="Ahead">Ahead</button>
      <span class="badge" id="nowBadge">Idle</span>
      <label class="badge"><input type="checkbox" id="chkLoop"> Circle</label>
      <label class="badge"><input type="checkbox" id="chkMute"> Silence</label>
      <select id="toneSel" aria-label="Ritual">
        <option value="off">Ritual: Off</option>
        <option value="128">Ritual: Ground (128)</option>
        <option value="160">Ritual: Lift (160)</option>
      </select>
      <label class="badge">Color <input id="tintRange" class="range" type="range" min="0" max="100" value="0" aria-label="Color"></label>
      <label class="badge">Volume <input id="gainRange" class="range" type="range" min="0" max="100" value="35" aria-label="Volume"></label>
      <button id="btnExport" class="badge">Export IDs</button>
      <label class="badge"><input type="file" id="fileImport" accept="application/json" class="hidden"><span id="btnImport" style="cursor:pointer">Import IDs</span></label>
      <button id="btnShare" class="badge">Share</button>
    </div>
    <div class="small">Ritual is optional. “Ground” is 128 Hz. “Lift” is 160 Hz. Use none, one, or both—your body decides.</div>
  </div>

  <!-- Illumina overlays (glass) -->
  <div class="glass">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <strong>Illumina</strong>
        <span class="badge" id="cycleDayBadge">Day –/42</span>
        <span class="badge" id="weekBadge">Week –</span>
        <span class="badge" id="themeBadge">Theme: —</span>
        <span class="badge" id="intentBadge">Intention: —</span>
      </div>
      <div class="row" style="gap:8px">
        <label class="small">Cycle Start <input type="date" id="cycleStart"></label>
        <input id="weekTheme" class="small" placeholder="Week theme (e.g., Soft Courage)" style="min-width:200px">
        <input id="weekIntent" class="small" placeholder="Week intention (one action)" style="min-width:220px">
        <button id="saveIllumina" class="ghost">Save</button>
        <button id="btnToday" class="ghost">Today</button>
      </div>
    </div>
  </div>

  <!-- Filter chips (glass) -->
  <div class="glass">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="chips" id="anchorChips">
        <div class="chip active" data-anchor="all">All</div>
        <div class="chip" data-anchor="marina">Marina</div>
        <div class="chip" data-anchor="sabrina">Sabrina</div>
        <div class="chip" data-anchor="sigrid">Sigrid</div>
        <div class="chip" data-anchor="swift">Swift</div>
        <div class="chip" data-anchor="ariana">Ariana</div>
        <div class="chip" data-anchor="doechii">Doechii</div>
        <div class="chip" id="chipDay" data-anchor="day">Day Mode</div>
      </div>
      <div class="small">“Sequence” is a feeling, not a law.</div>
    </div>
  </div>

  <!-- Self-test (glass) -->
  <div class="glass" id="spec">
    <div class="row" style="gap:12px;align-items:center">
      <strong>Checks</strong>
      <span id="c_queue" class="badge">Queue</span>
      <span id="c_api" class="badge">YouTube</span>
      <span id="c_play" class="badge">Play/Pause</span>
      <span id="c_nav" class="badge">Back/Ahead</span>
      <span id="c_loop" class="badge">Circle</span>
      <span id="c_audio" class="badge">Audio</span>
      <span id="c_tone" class="badge">Ritual</span>
      <span id="c_store" class="badge">Storage</span>
      <button id="btnSelfTest">Self-Test</button>
      <span id="receipt" class="small" aria-live="polite"></span>
    </div>
  </div>

  <!-- Player + Queue -->
  <div class="grid">
    <div class="glass player-glass">
      <div id="player" style="aspect-ratio:16/9; background:rgba(10,12,16,.6); border-radius:10px;"></div>
    </div>
    <div class="glass">
      <div class="row" style="justify-content:space-between">
        <div class="small">Sequence</div>
        <div class="small"><span id="countBadge">0</span> items</div>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>

  <footer>
    Froot • <span class="small">Videos via official channels • No tracking •
      <a class="hush" href="#" onclick="
        localStorage.removeItem('froot_idx_v1');
        localStorage.removeItem('froot_ids_v1');
        localStorage.removeItem('froot_tone_v1');
        localStorage.removeItem('froot_tint_v1');
        localStorage.removeItem('froot_cycle_v1');
        localStorage.removeItem('froot_anchor_map_v1');
        localStorage.removeItem('froot_meta_v1');
        location.reload()">Reset</a>
    </span>
  </footer>
</div>

<!-- Editor Sheet -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
  <h3 id="sheetTitle">Edit Song</h3>
  <div class="row" style="justify-content:space-between">
    <div class="col" style="flex:1">
      <label>Anchor
        <select id="edAnchor">
          <option value="">—</option>
          <option value="marina">Marina</option>
          <option value="sabrina">Sabrina</option>
          <option value="sigrid">Sigrid</option>
          <option value="swift">Swift</option>
          <option value="ariana">Ariana</option>
          <option value="doechii">Doechii</option>
        </select>
      </label>
    </div>
    <div class="col">
      <label>Day (1–42)
        <input id="edDay" type="number" min="1" max="42" placeholder="—">
      </label>
    </div>
    <div class="col">
      <label>Default Ritual
        <select id="edTone">
          <option value="">—</option>
          <option value="off">Off</option>
          <option value="128">Ground (128)</option>
          <option value="160">Lift (160)</option>
        </select>
      </label>
    </div>
    <div class="col">
      <label>Default Color
        <input id="edTint" type="number" min="0" max="100" placeholder="0–100">
      </label>
    </div>
  </div>
  <div class="row" style="justify-content:flex-end;margin-top:12px">
    <button id="btnSheetCancel" class="ghost">Cancel</button>
    <button id="btnSheetSave" class="primary">Save</button>
  </div>
</div>

<script>
/* ---------- State & keys ---------- */
let YTready=false, player=null, queue=[], i=0, loop=false, isMuted=false;
let ctx=null, osc=null, gain=null, tone="off", dayMode=false;
const el=(id)=>document.getElementById(id);
const nowBadge=el("nowBadge"), listEl=el("list"), tintEl=el("tint");
const storeKey="froot_ids_v1";
const indexKey="froot_idx_v1";
const toneKey="froot_tone_v1";
const tintKey="froot_tint_v1";
const cycleKey="froot_cycle_v1";
const anchorMapKey="froot_anchor_map_v1";
const metaKey="froot_meta_v1";

/* IDs */
const PRELOAD_IDS=[
  'WZzcY7ASQno','cIriwVhRPVA','kLbn61Z4LDI','8xg3vE8Ie_E','eB6txyhHFG4','phtcAd8j6Ro',
  'gDr7aTfBffU','w5x93pXSmRM','eVli-tstM5E','zLSUp53y-HQ','ffxKSjUwKdU','8qnOpJfFfpU',
  'ZT_skmohD-c','E7lr7pU9fYA','cF1Na4AIecM','b1kbLwvqugk','fLFvbwrWLQY','29mk5rz3m7Q',
  'F1JTlnHGa90','Cr-SqRWImmI','YcSP1ZUf1eQ','b7QlX3yR2xs','tcYodQoapMg','L94niPkteGg',
  's6AHxF0s764','aQMKAZpcynA','Gla5AzlHnS4'
];

/* Seeded anchors (editable) */
const SEED_ANCHORS={
  marina:  ['WZzcY7ASQno','gDr7aTfBffU','ZT_skmohD-c','F1JTlnHGa90','Cr-SqRWImmI','s6AHxF0s764','aQMKAZpcynA'],
  sigrid:  ['cIriwVhRPVA','w5x93pXSmRM','E7lr7pU9fYA'],
  sabrina: ['kLbn61Z4LDI','eVli-tstM5E','cF1Na4AIecM','YcSP1ZUf1eQ','Gla5AzlHnS4'],
  swift:   ['8xg3vE8Ie_E','zLSUp53y-HQ','b1kbLwvqugk','b7QlX3yR2xs'],
  ariana:  ['eB6txyhHFG4','ffxKSjUwKdU','fLFvbwrWLQY','tcYodQoapMg'],
  doechii: ['phtcAd8j6Ro','8qnOpJfFfpU','29mk5rz3m7Q','L94niPkteGg']
};

/* Whispers */
const WHISPERS={marina:"Breathe here.",sabrina:"Follow the spark.",sigrid:"Call your brave voice.",ariana:"Let light in.",swift:"Name it, then sing it.",doechii:"Flip the script."};

/* Metadata store: id -> {anchor?, day?, tone?, tint?} */
let meta={};
function loadMeta(){ try{ meta=JSON.parse(localStorage.getItem(metaKey)||"{}"); }catch(_){ meta={}; } }
function saveMeta(){ try{ localStorage.setItem(metaKey, JSON.stringify(meta)); }catch(_){} }

/* Anchor map (compat) */
let anchorMap={};
function loadAnchorMap(){ try{ anchorMap=JSON.parse(localStorage.getItem(anchorMapKey)||"{}"); }catch(_){ anchorMap={}; } }
function saveAnchorMap(){ try{ localStorage.setItem(anchorMapKey, JSON.stringify(anchorMap)); }catch(_){} }

/* ---------- Storage helpers ---------- */
function saveIDs(){ try{ localStorage.setItem(storeKey, JSON.stringify(queue.map(q=>q.id))); }catch(_){} }
function saveIndex(){ try{ localStorage.setItem(indexKey, String(i)); }catch(_){} }
function loadIndex(len){ try{ const v=parseInt(localStorage.getItem(indexKey)||"0",10); if(Number.isFinite(v)&&v>=0&&v<len){ i=v; } }catch(_){} }
function saveTone(){ try{ localStorage.setItem(toneKey, tone); }catch(_){} }
function loadTone(){ try{ return localStorage.getItem(toneKey)||"off"; }catch(_){ return "off"; } }
function saveTint(val){ try{ localStorage.setItem(tintKey, String(val)); }catch(_){} }
function loadTint(){ try{ return parseInt(localStorage.getItem(tintKey)||"0",10); }catch(_){ return 0; } }
function saveCycle(obj){ try{ localStorage.setItem(cycleKey, JSON.stringify(obj)); }catch(_){} }
function loadCycle(){ try{ return JSON.parse(localStorage.getItem(cycleKey)||"{}"); }catch(_){ return {}; } }

/* ---------- Boot ---------- */
async function load(){
  loadMeta(); loadAnchorMap();
  const idsStored=JSON.parse(localStorage.getItem(storeKey)||"[]");
  const ids = Array.isArray(idsStored)&&idsStored.length>0 ? idsStored : PRELOAD_IDS.slice();
  queue = ids.map(id=>({id, title:"", channel:""}));

  // seed anchors if missing
  for(const [a,arr] of Object.entries(SEED_ANCHORS)){
    for(const id of arr){
      if(!anchorMap[id]) anchorMap[id]=a;
      if(!meta[id]) meta[id]={anchor:a};
    }
  }
  saveAnchorMap(); saveMeta();

  loadIndex(queue.length);
  for(const item of queue){ refreshMeta(item).catch(()=>{}); }
  saveIDs(); render();

  // Apply saved ritual & color
  const t = loadTone(); tone=t; el("toneSel").value=t; if(t!=="off"){ ensureAudio(); setTone(t); }
  const tv = loadTint(); el("tintRange").value=tv; setTint(tv);

  // Cycle overlays
  const cyc = loadCycle();
  if(cyc.start){ el("cycleStart").value = cyc.start; }
  if(cyc.theme){ el("weekTheme").value = cyc.theme; }
  if(cyc.intent){ el("weekIntent").value = cyc.intent; }
  renderCycleBadges();
}

/* ---------- Metadata ---------- */
async function refreshMeta(item){
  const url="https://www.youtube.com/oembed?format=json&url="+encodeURIComponent("https://www.youtube.com/watch?v="+item.id);
  const r=await fetch(url,{mode:"cors"}); if(!r.ok) throw 0;
  const j=await r.json(); item.title=j.title||""; item.channel=j.author_name||""; render();
}

/* ---------- UI render ---------- */
function render(){
  listEl.innerHTML=""; el("countBadge").textContent=String(queue.length);
  queue.forEach((q,idx)=>{
    const m=meta[q.id]||{};
    const div=document.createElement("div"); div.className="item"+(idx===i?" active":"");
    const left=document.createElement("div"); left.className="meta";
    const t=document.createElement("div"); t.className="t"; t.textContent=q.title?q.title:q.id;
    const c=document.createElement("div"); c.className="c"; c.textContent=q.channel?q.channel:"";
    const tag=document.createElement("div"); tag.className="small"; let label=[];
    if(m.anchor){ label.push(m.anchor[0].toUpperCase()+m.anchor.slice(1)); }
    if(m.day){ label.push("Day "+m.day); }
    tag.textContent=label.join(" • "); tag.style.opacity=.85;
    left.append(t,c,tag);

    const right=document.createElement("div"); right.className="row";
    const up=document.createElement("button"); up.textContent="↑";
    const down=document.createElement("button"); down.textContent="↓";
    const play=document.createElement("button"); play.textContent="Play";
    const edit=document.createElement("button"); edit.textContent="Edit";
    const del=document.createElement("button"); del.textContent="Del";
    up.onclick=()=>{ if(idx>0){ [queue[idx-1],queue[idx]]=[queue[idx],queue[idx-1]]; if(i===idx)i=idx-1; else if(i===idx-1)i=idx; saveIDs(); saveIndex(); render(); } };
    down.onclick=()=>{ if(idx<queue.length-1){ [queue[idx+1],queue[idx]]=[queue[idx],queue[idx+1]]; if(i===idx)i=idx+1; else if(i===idx+1)i=idx; saveIDs(); saveIndex(); render(); } };
    play.onclick=()=>{ i=idx; saveIndex(); loadCurrent(true); };
    edit.onclick=()=>openEditor(q.id, q.title||q.id);
    del.onclick=()=>{ queue.splice(idx,1); if(i>=queue.length)i=queue.length-1; if(i<0)i=0; saveIDs(); saveIndex(); render(); };
    right.append(up,down,play,edit,del); div.append(left,right); listEl.append(div);
  });
  updateNowBadge();
}

/* ---------- Cycle badges ---------- */
function renderCycleBadges(){
  const cyc=loadCycle();
  const startStr=cyc.start;
  const dayEl=el("cycleDayBadge"), weekEl=el("weekBadge"), themeEl=el("themeBadge"), intentEl=el("intentBadge");
  if(startStr){
    const start=new Date(startStr+"T00:00:00"), now=new Date();
    const diff=Math.floor((now-start)/(1000*60*60*24));
    let day=((diff%42)+42)%42; day=day+1; const week=Math.ceil(day/7);
    dayEl.textContent="Day "+day+"/42"; weekEl.textContent="Week "+week;
  }else{ dayEl.textContent="Day –/42"; weekEl.textContent="Week –"; }
  themeEl.textContent="Theme: "+(cyc.theme||"—");
  intentEl.textContent="Intention: "+(cyc.intent||"—");
}

/* ---------- Audio / Ritual ---------- */
function ensureAudio(){ if(!ctx){ ctx=new (window.AudioContext||window.webkitAudioContext)(); }
  if(!gain){ gain=ctx.createGain(); gain.gain.value=0.35; gain.connect(ctx.destination); }
  if(!osc){ osc=ctx.createOscillator(); osc.type="sine"; osc.frequency.value=128; osc.connect(gain); osc.start(); } }
function setTone(sel){
  tone=sel; try{ localStorage.setItem(toneKey,tone);}catch(_){}
  if(sel==="off"){ if(gain) gain.gain.value=0; return; }
  ensureAudio(); if(osc){ osc.frequency.value=(sel==="128"?128:160); }
  if(gain){ const v=Number(el("gainRange").value)/100; gain.gain.value=v; }
}
function setGain(){ if(gain){ const v=Number(el("gainRange").value)/100; gain.gain.value=(tone==="off"?0:v); } }
function setMute(m){ isMuted=m; if(player){ if(m) player.mute(); else player.unMute(); } }
function setTint(v){ const o=Number(v)/100; tintEl.style.opacity=o; tintEl.style.background="hsl(260 80% 60% / 1)"; try{ localStorage.setItem(tintKey,String(v)); }catch(_){ } }

/* ---------- YouTube ---------- */
function loadYouTubeAPI(){ if(window.YT&&window.YT.Player){ onYouTubeIframeAPIReady(); return; }
  const s=document.createElement("script"); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s); }
window.onYouTubeIframeAPIReady=function(){
  YTready=true;
  player=new YT.Player("player",{
    width:"100%",height:"100%",
    playerVars:{autoplay:0,controls:1,rel:0,modestbranding:1,iv_load_policy:3,enablejsapi:1},
    events:{ onReady:()=>{}, onStateChange:(e)=>{ if(e.data===YT.PlayerState.ENDED){ next(); } if(e.data===YT.PlayerState.PLAYING){ syncMetaFromPlayer(); onTrackStartBehavior(); } syncPlayLabel(); } }
  });
};
function syncMetaFromPlayer(){ const d=player?player.getVideoData():null; const cur=queue[i];
  if(cur&&d){ if(d.title) cur.title=d.title; if(d.author) cur.channel=d.author; render(); } }
function syncPlayLabel(){ if(!player) return; const s=player.getPlayerState(); el("btnPlayPause").textContent=(s===1)?"Pause":"Play"; }

/* ---------- Playback ---------- */
function updateNowBadge(){ nowBadge.textContent= queue[i] ? (queue[i].title||queue[i].id) : "Idle"; }
function loadCurrent(autoplay){
  const cur=queue[i]; if(!cur) return; saveIndex();
  if(player&&player.loadVideoById){
    player.loadVideoById(cur.id);
    if(!autoplay){ player.pauseVideo(); }
    setTimeout(syncPlayLabel,150);
  }
  updateNowBadge();
}
function next(){ if(queue.length===0) return; if(i<queue.length-1){ i++; } else if(loop){ i=0; } else { return; } saveIndex(); loadCurrent(true); }
function prev(){ if(queue.length===0) return; if(i>0){ i--; } else if(loop){ i=queue.length-1; } saveIndex(); loadCurrent(true); }

/* ---------- Import/Export/Share ---------- */
function exportIDs(){
  const ids=queue.map(q=>q.id);
  const blob=new Blob([JSON.stringify(ids,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="froot_ids.json";
  document.body.appendChild(a); a.click(); a.remove();
}
function importIDs(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const ids=JSON.parse(r.result);
      if(Array.isArray(ids)){
        queue = ids.map(id=>({id:String(id), title:"", channel:""}));
        if(i>=queue.length) i = queue.length?queue.length-1:0;
        saveIDs(); saveIndex(); render();
        queue.forEach(item=>refreshMeta(item).catch(()=>{}));
      }
    }catch(_){}
  };
  r.readAsText(file);
}
function copyShare(){ try{ navigator.clipboard.writeText(location.href).then(()=>flashToast("Link copied")); }catch(_){ flashToast("Copy failed"); } }
function flashToast(msg){ const t=el("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); }

/* ---------- Anchors, Day mode, whispers ---------- */
function reorderByAnchor(anchor){
  if(anchor==="all"){ render(); return; }
  if(anchor==="day"){
    dayMode=true;
    queue.sort((a,b)=>{
      const da=(meta[a.id]||{}).day||999, db=(meta[b.id]||{}).day||999;
      return da-db;
    });
  }else{
    dayMode=false;
    const idsTop=[], idsRest=[];
    for(const q of queue){
      const m=meta[q.id]||{}; const a = m.anchor || anchorMap[q.id] || "";
      if(a===anchor) idsTop.push(q); else idsRest.push(q);
    }
    queue = idsTop.concat(idsRest);
  }
  const curId=(queue[i]||{}).id; const newIdx=queue.findIndex(x=>x.id===curId); if(newIdx>=0) i=newIdx;
  saveIDs(); saveIndex(); render();
}
function onTrackStartBehavior(){
  const id=queue[i]?.id; if(!id) return;
  const m=meta[id]||{};
  if(m.tone){ el("toneSel").value=m.tone; setTone(m.tone); }
  if(typeof m.tint!=="undefined"){ el("tintRange").value=String(m.tint); setTint(m.tint); }
  const a=m.anchor || anchorMap[id] || ""; const line={marina:"Breathe here.",sabrina:"Follow the spark.",sigrid:"Call your brave voice.",ariana:"Let light in.",swift:"Name it, then sing it.",doechii:"Flip the script."}[a]||"";
  if(line){ const w=el("whisper"); w.textContent=line; w.classList.add("show"); setTimeout(()=>w.classList.remove("show"),1300); }
}

/* ---------- Self-Test ---------- */
function mark(elm, ok){ elm.classList.remove('ok','fail'); elm.classList.add(ok?'ok':'fail'); }
function receiptLine(){ const ids=['c_queue','c_api','c_play','c_nav','c_loop','c_audio','c_tone','c_store'];
  const ok=ids.every(id=>document.getElementById(id).classList.contains('ok'));
  el('receipt').textContent= ok ? 'All green' : 'Needs fixes: ' + ids.filter(id=>!document.getElementById(id).classList.contains('ok')).map(s=>document.getElementById(s).textContent).join(', ');
}
function waitForState(targets, timeout=4000){
  return new Promise((res)=>{
    const start=performance.now();
    (function tick(){
      const s=player?player.getPlayerState():null;
      if(s!=null && targets.includes(s)) return res(true);
      if(performance.now()-start>timeout) return res(false);
      requestAnimationFrame(tick);
    })();
  });
}
async function runSelfTest(){
  try{
    mark(el('c_queue'), Array.isArray(queue)&&queue.length>0);
    const apiReady=!!(window.YT&&window.YT.Player&&player); let apiLoadOk=false;
    if(apiReady&&queue[i]&&queue[i].id){ try{ player.cueVideoById(queue[i].id); apiLoadOk=true; }catch(_){ apiLoadOk=false; } }
    mark(el('c_api'), apiReady&&apiLoadOk);
    let playOk=false; if(apiReady){ player.playVideo(); const played=await waitForState([1,3]); player.pauseVideo(); const paused=await waitForState([2,5,0]); playOk=played&&paused; }
    mark(el('c_play'), playOk);
    const before=i; next(); const movedNext=(i!==before); prev(); const movedPrev=(i===before); mark(el('c_nav'), movedNext&&movedPrev);
    const oldIdx=i, oldLoop=loop; i=queue.length?queue.length-1:0; loop=true; next(); const wrapped=(i===0&&queue.length>0); mark(el('c_loop'), wrapped); i=oldIdx; loop=oldLoop;
    let audioOk=false; try{ await (ctx?ctx.resume():Promise.resolve()); ensureAudio(); audioOk=!!(ctx&&gain&&osc); }catch(_){} mark(el('c_audio'), audioOk);
    const toneWas=tone; setTone('128'); const t128ok=(osc&&Math.abs(osc.frequency.value-128)<0.5); setTone('160'); const t160ok=(osc&&Math.abs(osc.frequency.value-160)<0.5); setTone(toneWas); mark(el('c_tone'), t128ok&&t160ok);
    let storeOk=false; try{ const snap=JSON.stringify(queue.map(q=>q.id)); localStorage.setItem(storeKey,snap); const back=localStorage.getItem(storeKey); storeOk=(back===snap); }catch(_){}
    mark(el('c_store'), storeOk); syncPlayLabel(); receiptLine();
  }catch(_){ ['c_queue','c_api','c_play','c_nav','c_loop','c_audio','c_tone','c_store'].forEach(id=>mark(el(id),false)); receiptLine(); }
}

/* ---------- Editor ---------- */
let editingId=null;
function openEditor(id, title){
  editingId=id; const m=meta[id]||{};
  el("edAnchor").value = m.anchor || anchorMap[id] || "";
  el("edDay").value = m.day || "";
  el("edTone").value = (typeof m.tone!=="undefined" ? m.tone : "");
  el("edTint").value = (typeof m.tint!=="undefined" ? m.tint : "");
  el("sheetTitle").textContent = "Edit — " + (title||id);
  el("sheet").classList.add("show");
}
function closeEditor(){ el("sheet").classList.remove("show"); }
function saveEditor(){
  if(!editingId) return;
  const a=el("edAnchor").value||"";
  const dayVal=el("edDay").value.trim();
  const d=dayVal?Math.max(1,Math.min(42,parseInt(dayVal,10))):undefined;
  const t=el("edTone").value || undefined;
  const tintVal=el("edTint").value.trim();
  const ti = tintVal==="" ? undefined : Math.max(0,Math.min(100,parseInt(tintVal,10)));
  meta[editingId]=Object.assign({}, meta[editingId]||{}, (a?{anchor:a}:{}) , (d?{day:d}:{}) , (typeof t!=="undefined"?{tone:t}:{}) , (typeof ti!=="undefined"?{tint:ti}:{}) );
  if(a){ anchorMap[editingId]=a; saveAnchorMap(); }
  saveMeta(); render(); closeEditor();
}

/* ---------- Boot & events ---------- */
document.addEventListener("DOMContentLoaded",()=>{
  loadYouTubeAPI(); load();

  el("btnStart").onclick=async ()=>{ try{ await (ctx?ctx.resume():Promise.resolve()); }catch(_){} setTone(el("toneSel").value); loadCurrent(false); };
  el("btnPrev").onclick=prev;
  el("btnNext").onclick=next;
  el("btnPlayPause").onclick=()=>{ if(!player) return; const s=player.getPlayerState(); if(s===1){ player.pauseVideo(); } else { player.playVideo(); } setTimeout(syncPlayLabel,150); };
  el("chkLoop").onchange=(e)=>{ loop=e.target.checked; };
  el("chkMute").onchange=(e)=>{ setMute(e.target.checked); };
  el("toneSel").onchange=(e)=>{ setTone(e.target.value); };
  el("gainRange").oninput=setGain;
  el("tintRange").oninput=(e)=>setTint(e.target.value);
  el("btnExport").onclick=exportIDs;
  el("btnImport").onclick=()=>el("fileImport").click();
  el("fileImport").onchange=(e)=>{ if(e.target.files&&e.target.files[0]) importIDs(e.target.files[0]); };
  el("btnSelfTest").onclick=runSelfTest;
  el("btnShare").onclick=copyShare;

  el("saveIllumina").onclick=()=>{ const start=el("cycleStart").value; const theme=el("weekTheme").value.trim(); const intent=el("weekIntent").value.trim(); localStorage.setItem(cycleKey, JSON.stringify({start,theme,intent})); renderCycleBadges(); const t=document.getElementById('toast'); t.textContent='Saved'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); };
  el("btnToday").onclick=()=>{
    const cyc=loadCycle(); if(!cyc.start){ const w=el("whisper"); w.textContent="Set Cycle Start date first"; w.classList.add("show"); setTimeout(()=>w.classList.remove("show"),1300); return; }
    const start=new Date(cyc.start+"T00:00:00"); const now=new Date(); const diff=Math.floor((now-start)/(1000*60*60*24)); let day=((diff%42)+42)%42; day=day+1;
    const idx = queue.findIndex(q=>(meta[q.id]||{}).day===day);
    if(idx>=0){ i=idx; saveIndex(); loadCurrent(true); const w=el("whisper"); w.textContent="Day "+day; w.classList.add("show"); setTimeout(()=>w.classList.remove("show"),1300); }
    else{ const w=el("whisper"); w.textContent="No song set for Day "+day; w.classList.add("show"); setTimeout(()=>w.classList.remove("show"),1300); }
  };

  el("anchorChips").addEventListener("click",(e)=>{
    const target=e.target.closest(".chip"); if(!target) return;
    document.querySelectorAll(".chip").forEach(ch=>ch.classList.remove("active"));
    target.classList.add("active");
    reorderByAnchor(target.dataset.anchor);
  });

  el("btnSheetCancel").onclick=closeEditor;
  el("btnSheetSave").onclick=saveEditor;

  window.addEventListener("beforeunload", saveIndex);
});
</script>
</body>
</html>
