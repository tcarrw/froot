<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Froot ¬∑ Platinum Resonance Build</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0f14" />
  <style>
    :root{
      --bg:#0c0f14;
      --bg-2:#0a0d12;
      --text:#e7f1ff;
      --muted:#9fb0c6;
      --accent:#cdb9ff;   /* lavender */
      --accent-2:#a9ffd9; /* mint */
      --edge:#2a3140;
      --shimmer-a: rgba(173, 255, 216, 0.08);
      --shimmer-b: rgba(203, 176, 255, 0.10);
      --card:#11161f;
      --good:#7dfcc2;
      --warn:#ffd166;
      --bad:#ff7a7a;
      --link:#bfe7ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    /* Themes */
    .theme-neon{
      --bg:#03060b; --bg-2:#020509; --card:#060b12;
      --accent:#39ff14; --accent-2:#ff6fd8; --link:#b8f7ff;
      --shimmer-a: rgba(57,255,20,.10); --shimmer-b: rgba(255,111,216,.10);
    }
    .theme-muse{
      --bg:#0d0b10; --bg-2:#0a0810; --card:#13101a;
      --accent:#ffd7a8; --accent-2:#b6ffea; --link:#ffe7c9;
      --shimmer-a: rgba(255,215,168,.10); --shimmer-b: rgba(182,255,234,.08);
    }

    html, body {height:100%; background:var(--bg); color:var(--text); font: 15px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    body { margin:0; position:relative; overflow-x:hidden; }

    /* Night shimmer layer */
    body::before{
      content:""; position:fixed; inset:-20vmax;
      background:
        radial-gradient(60vmax 60vmax at 20% 10%, var(--shimmer-a), transparent 60%),
        radial-gradient(70vmax 70vmax at 80% 30%, var(--shimmer-b), transparent 60%),
        radial-gradient(40vmax 40vmax at 30% 90%, var(--shimmer-a), transparent 70%);
      pointer-events:none; filter: blur(12px) saturate(120%);
      animation: drift 24s linear infinite alternate;
      z-index:0;
    }
    @keyframes drift {
      from{ transform: translate3d(-2%, 0, 0) scale(1.02); }
      to  { transform: translate3d(2%,  1%,0) scale(1.05); }
    }

    .wrap{ position:relative; z-index:1; max-width:980px; margin:0 auto; padding: clamp(16px, 3vw, 28px); }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:8px 0 18px; }
    h1{ margin:0; font-weight:700; letter-spacing:.3px; font-size: clamp(18px, 3.2vw, 24px); }
    .subtitle{ color:var(--muted); font-size:12px; letter-spacing:.2px; }

    .row{ display:flex; flex-wrap:wrap; gap:16px; }
    .col{ flex:1 1 320px; min-width:280px; }

    .card{ background: linear-gradient(180deg, var(--card), rgba(0,0,0,.0));
           border:1px solid var(--edge); border-radius:14px; padding:16px; box-shadow:var(--shadow); }

    .controls label{ display:grid; grid-template-columns: 150px 1fr auto; gap:10px; align-items:center; margin:10px 0; }
    .controls .hint{ color:var(--muted); font-size:12px; }

    .btn, button, .chip{
      -webkit-tap-highlight-color: transparent;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06));
      color:var(--text); border:1px solid var(--edge); border-radius:12px;
      padding:10px 14px; font-weight:600; letter-spacing:.2px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease; box-shadow: 0 1px 0 rgba(255,255,255,.03) inset;
    }
    .btn:hover{ border-color:var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 30%, transparent); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 22%, transparent), rgba(0,0,0,.06)); border-color: color-mix(in oklab, var(--accent) 60%, var(--edge)); }
    .btn.ghost{ background: transparent; }
    .btn.bad{ border-color: color-mix(in oklab, var(--bad) 70%, var(--edge)); }

    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .theme-switch{ gap:8px; }
    .theme-switch .chip{ font-size:12px; padding:8px 10px; border-radius:10px }
    .chip.active{ border-color:var(--accent); box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 40%, transparent); }

    .bar{
      height:14px; border-radius:999px; background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(0,0,0,.15));
      border:1px solid var(--edge); position:relative; overflow:hidden; margin:8px 0 6px;
    }
    .bar .fill{
      position:absolute; top:0; left:0; height:100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      width:0%;
      transition: width .25s ease;
      box-shadow: 0 0 18px color-mix(in oklab, var(--accent) 40%, transparent);
    }
    .bar .tick{
      position:absolute; inset:auto auto -6px var(--tick-left);
      width:2px; height:26px; background: color-mix(in oklab, var(--accent) 65%, #fff);
      border-radius:2px; opacity:.7;
    }
    .bar-label{ display:flex; align-items:baseline; gap:10px; }
    .hz{ font-variant-numeric: tabular-nums; font-weight:700; letter-spacing:.2px; }

    .playlist{ display:grid; grid-template-columns: 160px 1fr; gap:14px; align-items:start; }
    @media (max-width:840px){ .playlist{ grid-template-columns:1fr; } }

    .tracklist{ display:flex; flex-wrap:wrap; gap:8px; }
    .track{ padding:8px 12px; border-radius:999px; border:1px solid var(--edge); cursor:pointer; user-select:none; }
    .track.active{ border-color: var(--accent); box-shadow:0 0 0 2px color-mix(in oklab, var(--accent) 40%, transparent); }

    .players{ position:relative; aspect-ratio: 16/9; width:100%; background: #000; border-radius:12px; overflow:hidden; border:1px solid var(--edge); }
    .players iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; display:none; }
    .players iframe.active{ display:block; }

    .muted-note{ color:var(--muted); font-size:12px; margin-top:4px; }

    textarea.note{ width:100%; min-height:70px; resize:vertical; background: rgba(255,255,255,.04); color:var(--text); border:1px solid var(--edge); border-radius:10px; padding:10px; outline:none; }
    textarea.note:focus{ border-color: var(--accent); box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 30%, transparent); }

    .inline-hint{ color:var(--muted); font-size:12px; margin-top:6px; }

    .row-slim{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex: 1 1 auto; }
    .badge{ font-size:11px; color: var(--muted); }

    a{ color:var(--link); }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  </style>
</head>
<body class="theme-night">
  <span aria-hidden="true" class="sr-only">üçë May the Froot ripen exactly on time.</span>

  <div class="wrap">
    <header>
      <div>
        <h1>Froot ¬∑ Platinum Resonance Build</h1>
        <div class="subtitle">Illumina Frontend Builder & Resonance Tuner ‚Äî Echo Platinum ¬∑ 128‚ÄØHz warmth + Marina‚Äôs aura</div>
      </div>
      <div class="toolbar theme-switch" role="group" aria-label="Theme">
        <button class="chip active" data-theme="night" aria-pressed="true">Night</button>
        <button class="chip" data-theme="neon" aria-pressed="false">Neon</button>
        <button class="chip" data-theme="muse" aria-pressed="false">Muse</button>
      </div>
    </header>

    <section class="row">
      <!-- Resonance / Tone -->
      <div class="col card" id="toneCard" aria-labelledby="toneTitle">
        <h2 id="toneTitle" style="margin:0 0 6px">Echo Resonance ¬∑ 128‚ÄØHz Honey</h2>
        <div class="toolbar" style="margin:8px 0 6px">
          <button id="startBtn" class="btn primary">‚ñ∂Ô∏é Start Resonance</button>
          <button id="stopBtn" class="btn bad" disabled>‚ñ† Stop</button>
          <span class="spacer"></span>
          <button id="stayAwakeBtn" class="btn ghost" title="Best effort screen wake lock">‚ó¥ Stay Awake</button>
        </div>

        <!-- Froot Tuning Bar -->
        <div class="bar" aria-label="Froot Tuning Bar">
          <div id="barFill" class="fill"></div>
          <div class="tick" style="--tick-left:50%"></div>
        </div>
        <div class="bar-label">
          <div class="hz"><span id="hzNow">128.00</span> Hz</div>
          <div class="badge">Alignment: <b id="alignPct">100%</b></div>
          <div class="spacer"></div>
          <div class="badge">Base: 128‚ÄØHz ¬∑ Air Band ¬∑ Binaural Drift</div>
        </div>

        <!-- Controls -->
        <div class="controls" style="margin-top:8px">
          <label>
            Level
            <input id="gain" type="range" min="0" max="100" step="1" value="55" />
            <span class="hint" id="gainVal">55%</span>
          </label>

          <label>
            Fine Detune (¬±2%)
            <input id="detune" type="range" min="-2" max="2" step="0.01" value="0" />
            <span class="hint"><span id="detuneVal">0.00%</span> from 128‚ÄØHz</span>
          </label>

          <label>
            Air Band (high‚Äëshelf)
            <input id="air" type="range" min="0" max="12" step="0.1" value="2.0" />
            <span class="hint"><span id="airVal">+2.0‚ÄØdB</span> @ 12‚ÄØkHz</span>
          </label>

          <label>
            Binaural drift
            <input id="drift" type="checkbox" />
            <span class="hint">Right ear drifts ¬±0.5‚ÄØHz @ 0.08‚ÄØHz</span>
          </label>
        </div>

        <div class="row-slim" style="margin-top:10px">
          <button id="reliableBtn" class="btn">‚ÜóÔ∏é Open Reliable Honey</button>
          <a id="downloadTone" class="btn" download="Froot-128Hz.wav">‚¨áÔ∏é Download 128‚ÄØHz</a>
          <span class="spacer"></span>
          <button id="shareBtn" class="btn">‚ÜóÔ∏é Share to X</button>
        </div>
        <div class="inline-hint">Autoplay begins only after your tap. Reliable Honey (normal audio element) is most dependable when the screen locks on iPhone.</div>
      </div>

      <!-- Playlist / Marina videos -->
      <div class="col card" id="playlistCard" aria-labelledby="plTitle">
        <h2 id="plTitle" style="margin:0 0 6px">Marina ¬∑ Echo Integration</h2>
        <div class="playlist">
          <div>
            <div class="tracklist" role="tablist" aria-label="Playlist">
              <button class="track active" role="tab" aria-selected="true" data-video="gqEEqVHaMqI">Froot</button>
              <button class="track" role="tab" aria-selected="false" data-video="9txg0XicoJ0">Fear &amp; Loathing</button>
              <button class="track" role="tab" aria-selected="false" data-video="obxFWNeGDOg">Man‚Äôs World</button>
              <button class="track" role="tab" aria-selected="false" data-video="_V17JN76uxc">Ancient Dreams</button>
            </div>
            <div class="muted-note">Videos loop (YouTube) and start only after you press <b>Start Resonance</b>. If offline, the tone continues; videos are hidden.</div>
          </div>
          <div>
            <div class="players" id="players">
              <!-- Preserved embeds (nocookie) -->
              <iframe id="yt-gqEEqVHaMqI" title="Marina ‚Äî Froot (official)" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="strict-origin-when-cross-origin" loading="lazy"></iframe>
              <iframe id="yt-9txg0XicoJ0" title="Marina ‚Äî Fear &amp; Loathing (official)" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="strict-origin-when-cross-origin" loading="lazy"></iframe>
              <iframe id="yt-obxFWNeGDOg" title="Marina ‚Äî Man‚Äôs World (official)" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="strict-origin-when-cross-origin" loading="lazy"></iframe>
              <iframe id="yt-_V17JN76uxc" title="Marina ‚Äî Ancient Dreams In A Modern Land (official)" allow="autoplay; encrypted-media; picture-in-picture" referrerpolicy="strict-origin-when-cross-origin" loading="lazy"></iframe>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="col card" id="notesCard" aria-labelledby="notesTitle">
        <h2 id="notesTitle" style="margin:0 0 6px">One‚ÄëLine Note</h2>
        <textarea id="note" class="note" maxlength="160" placeholder="Everything Marina thinks I did for her, I did."></textarea>
        <div class="row-slim" style="margin-top:8px">
          <button id="saveNote" class="btn">üíæ Save Note</button>
          <button id="clearNote" class="btn ghost">‚úß Clear Note</button>
          <span class="spacer"></span>
          <span class="badge" id="noteBadge" aria-live="polite"></span>
        </div>
      </div>
    </section>

    <footer style="opacity:.85; margin-top:16px; color:var(--muted); font-size:12px">
      Layer 1 (Sun): deliberate act ¬∑ Layer 2 (Moon): unseen reciprocity ¬∑ Layer 3 (Bee): the field pollinating both. The site should sound like trust ‚Äî a warm hum rising through lavender air.
    </footer>
  </div>

  <audio id="reliableAudio" preload="auto" loop playsinline></audio>

  <script>
    /* ===== Tone Engine (128 Hz base, Air Band, Binaural drift) ===== */
    const Tone = (() => {
      const state = {
        ctx: null,
        mainGain: null,
        leftOsc: null,
        rightOsc: null,
        air: null,
        merger: null,
        driftLFO: null,
        driftGain: null,
        started: false,
        baseHz: 128,
        detunePct: 0,
        binaural: false,
        wakeLock: null,
      };

      const clamp = (x, a, b) => Math.min(b, Math.max(a, x));

      function makeChain(){
        state.ctx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:'interactive'});
        state.mainGain = state.ctx.createGain();
        state.air = state.ctx.createBiquadFilter();
        state.air.type = 'highshelf';
        state.air.frequency.value = 12000;
        state.air.gain.value = 2;

        state.driftLFO = state.ctx.createOscillator();
        state.driftLFO.frequency.value = 0.08; // very slow drift
        state.driftGain = state.ctx.createGain();
        state.driftGain.gain.value = 50; // cents (¬±50c ~ ¬±0.5 Hz near 128)

        state.driftLFO.connect(state.driftGain);

        state.merger = state.ctx.createChannelMerger(2);
        state.mainGain.gain.value = 0.55;

        state.mainGain.connect(state.ctx.destination);
      }

      function createOscs(){
        const hz = effectiveHz();
        state.leftOsc = state.ctx.createOscillator();
        state.leftOsc.type = 'sine';
        state.leftOsc.frequency.value = hz;

        state.rightOsc = state.ctx.createOscillator();
        state.rightOsc.type = 'sine';
        state.rightOsc.frequency.value = hz;

        // Apply drift to right via detune modulation (cents)
        state.driftLFO.connect(state.rightOsc.detune);

        state.leftOsc.connect(state.air);
        state.rightOsc.connect(state.air);
        state.air.connect(state.mainGain);
      }

      function start(){
        if (state.started) return;
        if (!state.ctx) makeChain();
        if (state.ctx.state === 'suspended') state.ctx.resume();
        createOscs();
        state.leftOsc.start();
        state.rightOsc.start();
        state.driftLFO.start();

        // By default drift off
        setBinaural(false);

        state.started = true;
      }

      function stop(){
        if (!state.started) return;
        try { state.leftOsc.stop(); } catch(e){}
        try { state.rightOsc.stop(); } catch(e){}
        try { state.driftLFO.stop(); } catch(e){}
        try { state.leftOsc.disconnect(); } catch(e){}
        try { state.rightOsc.disconnect(); } catch(e){}
        try { state.driftLFO.disconnect(); } catch(e){}
        try { state.air.disconnect(); } catch(e){}
        try { state.mainGain.disconnect(); } catch(e){}
        state.ctx && state.ctx.close();
        state.ctx = null;
        state.started = false;
      }

      function setGain(pct){ state.mainGain && (state.mainGain.gain.value = clamp(pct,0,1)); }

      function setDetunePct(pct){
        state.detunePct = clamp(pct, -2, 2);
        const hz = effectiveHz();
        if (state.leftOsc) state.leftOsc.frequency.setTargetAtTime(hz, now(), 0.05);
        if (state.rightOsc) state.rightOsc.frequency.setTargetAtTime(hz, now(), 0.05);
      }

      function setAirDb(db){
        if (!state.air) return;
        state.air.gain.setTargetAtTime(db, now(), 0.08);
      }

      function setBinaural(on){
        state.binaural = !!on;
        if (!state.rightOsc) return;
        // Enable or disable drift modulation (detune)
        state.rightOsc.detune.cancelScheduledValues(now());
        if (on){
          state.driftGain && state.driftGain.disconnect();
          state.driftLFO.connect(state.driftGain);
          state.driftGain.connect(state.rightOsc.detune);
          state.driftGain.gain.setTargetAtTime(50, now(), 0.2); // ¬±50c
        } else {
          try{ state.driftLFO.disconnect(); } catch(e){}
        }
      }

      function effectiveHz(){
        return state.baseHz * (1 + state.detunePct/100);
      }
      function now(){ return state.ctx ? state.ctx.currentTime : 0; }

      // Public API
      return {
        start, stop, setGain, setDetunePct, setAirDb, setBinaural,
        effectiveHz: () => state.baseHz * (1 + state.detunePct/100),
        isStarted:   () => state.started,
        requestWakeLock: async () => {
          if ('wakeLock' in navigator && navigator.wakeLock.request){
            try{ state.wakeLock = await navigator.wakeLock.request('screen'); }catch(e){}
          }
        },
        releaseWakeLock: async () => { try{ await state.wakeLock?.release?.(); }catch(e){} state.wakeLock=null; }
      };
    })();

    /* ===== UI Wiring ===== */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const startBtn = $('#startBtn');
    const stopBtn = $('#stopBtn');
    const gain = $('#gain');
    const detune = $('#detune');
    const air = $('#air');
    const drift = $('#drift');
    const gainVal = $('#gainVal');
    const detuneVal = $('#detuneVal');
    const airVal = $('#airVal');
    const hzNow = $('#hzNow');
    const alignPct = $('#alignPct');
    const barFill = $('#barFill');

    const shareBtn = $('#shareBtn');
    const reliableAudio = $('#reliableAudio');
    const reliableBtn = $('#reliableBtn');
    const downloadTone = $('#downloadTone');
    const stayAwakeBtn = $('#stayAwakeBtn');

    const themeChips = $$('.chip[data-theme]');
    const note = $('#note');
    const noteBadge = $('#noteBadge');
    const saveNote = $('#saveNote');
    const clearNote = $('#clearNote');

    const players = $('#players');
    const tracks = $$('.track');

    // Theme switch
    themeChips.forEach(chip=>{
      chip.addEventListener('click', ()=>{
        themeChips.forEach(c=>{ c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
        chip.classList.add('active'); chip.setAttribute('aria-pressed','true');
        const t = chip.dataset.theme;
        document.body.classList.remove('theme-neon','theme-muse');
        if (t==='neon') document.body.classList.add('theme-neon');
        else if (t==='muse') document.body.classList.add('theme-muse');
      })
    });

    // Initialize controls display
    function updateLabels(){
      gainVal.textContent = Math.round(gain.value) + '%';
      detuneVal.textContent = (Number(detune.value)).toFixed(2) + '%';
      airVal.textContent = '+' + Number(air.value).toFixed(1) + '‚ÄØdB';
      const hz = Tone.effectiveHz();
      hzNow.textContent = hz.toFixed(2);
      // Alignment: closeness to 128 within ¬±2% window
      const delta = Math.abs(hz - 128);
      const pct = 100 * (1 - Math.min(delta / (128*0.02), 1));
      alignPct.textContent = Math.round(pct) + '%';
      barFill.style.width = Math.max(4, pct) + '%';
    }

    // Start / Stop
    startBtn.addEventListener('click', async ()=>{
      // Unlock audio
      Tone.start();
      Tone.setGain(gain.value/100);
      Tone.setDetunePct(Number(detune.value));
      Tone.setAirDb(Number(air.value));
      Tone.setBinaural(drift.checked);

      // Wake lock request (best effort)
      Tone.requestWakeLock();

      // Activate selected video with autoplay (muted, inline, loop)
      activateCurrentVideo({autoplay:true});

      startBtn.disabled = true;
      stopBtn.disabled = false;
      stayAwakeBtn.disabled = true; // already requested
      updateLabels();
      setMediaSession();
    });

    stopBtn.addEventListener('click', ()=>{
      Tone.stop();
      // Stop videos by unloading active iframe (keeps embeds preserved but paused)
      const active = players.querySelector('iframe.active');
      if (active){ active.src = 'about:blank'; active.classList.remove('active'); }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      stayAwakeBtn.disabled = false;
      Tone.releaseWakeLock();
      updateLabels();
    });

    stayAwakeBtn.addEventListener('click', ()=>{ Tone.requestWakeLock(); stayAwakeBtn.disabled = true; });

    gain.addEventListener('input', ()=>{ Tone.setGain(gain.value/100); updateLabels(); });
    detune.addEventListener('input', ()=>{ Tone.setDetunePct(Number(detune.value)); updateLabels(); });
    air.addEventListener('input', ()=>{ Tone.setAirDb(Number(air.value)); updateLabels(); });
    drift.addEventListener('change', ()=>{ Tone.setBinaural(drift.checked); updateLabels(); });

    // Notes (localStorage)
    const NOTE_KEY='froot_note';
    note.value = localStorage.getItem(NOTE_KEY) || '';
    saveNote.addEventListener('click', ()=>{
      const v = (note.value||'').trim();
      localStorage.setItem(NOTE_KEY, v);
      stamp('Saved');
    });
    clearNote.addEventListener('click', ()=>{
      note.value=''; localStorage.removeItem(NOTE_KEY);
      stamp('Cleared');
    });
    function stamp(msg){ noteBadge.textContent = msg + ' ¬∑ ' + new Date().toLocaleString(); setTimeout(()=>noteBadge.textContent='', 4000); }

    // Share to X
    shareBtn.addEventListener('click', ()=>{
      const text = 'Froot ¬∑ Platinum Resonance Build ‚Äî tuning at 128‚ÄØHz with Marina‚Äôs aura.';
      const url = location.href;
      if (navigator.share){ navigator.share({text, url}).catch(()=>{}); }
      else {
        const intent = 'https://x.com/intent/tweet?text=' + encodeURIComponent(text) + '&url=' + encodeURIComponent(url);
        window.open(intent, '_blank', 'noopener,noreferrer');
      }
    });

    // Reliable Honey ‚Äî open in new tab and start a standard <audio> loop (works best when screen locks)
    let reliableURL = null;
    reliableBtn.addEventListener('click', async ()=>{
      if (!reliableURL) reliableURL = await generateWav(128, 14);
      reliableAudio.src = reliableURL;
      reliableAudio.play().catch(()=>{});
      window.open(reliableURL, '_blank', 'noopener,noreferrer');
    });

    // Download tone
    (async ()=>{
      reliableURL = await generateWav(128, 14);
      downloadTone.href = reliableURL;
    })();

    // Playlist handling
    tracks.forEach(t=>{
      t.addEventListener('click', ()=>{
        tracks.forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
        t.classList.add('active'); t.setAttribute('aria-selected','true');
        if (Tone.isStarted()) activateCurrentVideo({autoplay:true});
        else activateCurrentVideo({autoplay:false}); // preload embeds without playing
      });
    });

    // Build embed URLs and preload without autoplay
    function ytsrc(id, autoplay){
      const base = 'https://www.youtube-nocookie.com/embed/' + id;
      const q = [
        'playlist='+id,
        'loop=1',
        'playsinline=1',
        autoplay ? 'autoplay=1' : 'autoplay=0',
        autoplay ? 'mute=1' : 'mute=0',
        'controls=1',
        'modestbranding=1',
        'rel=0',
        'iv_load_policy=3'
      ].join('&');
      return base + '?' + q;
    }

    function activateCurrentVideo({autoplay}){
      const activeId = document.querySelector('.track.active')?.dataset.video;
      const frames = Array.from(players.querySelectorAll('iframe'));
      frames.forEach(f=>{
        const id = f.id.replace('yt-','');
        // Preserve all embeds in DOM; only active plays
        const targetSrc = ytsrc(id, autoplay && id===activeId);
        if (f.src !== targetSrc) f.src = targetSrc;
        f.classList.toggle('active', id===activeId);
      });
      // Hide videos while offline
      if (!navigator.onLine){ frames.forEach(f=>f.style.display='none'); }
      else { frames.forEach(f=>f.style.display = f.classList.contains('active')?'block':'none'); }
    }

    window.addEventListener('online', ()=>activateCurrentVideo({autoplay:false}));
    window.addEventListener('offline', ()=>activateCurrentVideo({autoplay:false}));

    // Media Session metadata (helps iOS treat it like media)
    function setMediaSession(){
      if ('mediaSession' in navigator){
        navigator.mediaSession.metadata = new MediaMetadata({
          title: 'Froot Honey ‚Äî 128‚ÄØHz',
          artist: 'PLNT Earth',
          album: 'Echo Platinum',
        });
      }
    }

    // Utility: generate short WAV (stereo, 16‚Äëbit) for Reliable Honey
    async function generateWav(freq, seconds){
      const sr = 44100, ch = 2, len = sr * seconds;
      const bytesPerSample = 2, blockAlign = ch * bytesPerSample, byteRate = sr * blockAlign;
      const dataSize = len * blockAlign;
      const buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);

      function writeString(o, s){ for(let i=0;i<s.length;i++) view.setUint8(o+i, s.charCodeAt(i)); }
      function write16(o, v){ view.setUint16(o, v, true); }
      function write32(o, v){ view.setUint32(o, v, true); }

      // RIFF header
      writeString(0,'RIFF'); write32(4, 36 + dataSize); writeString(8,'WAVE');
      // fmt chunk
      writeString(12,'fmt '); write32(16,16); write16(20,1); write16(22,ch); write32(24,sr); write32(28,byteRate); write16(32,blockAlign); write16(34,16);
      // data chunk
      writeString(36,'data'); write32(40,dataSize);

      let off = 44;
      const amp = 0.20 * 0x7FFF;
      for (let i=0; i<len; i++){
        const t = i/sr;
        const s = Math.sin(2*Math.PI*freq*t);
        const val = (s*amp)|0;
        // left
        view.setInt16(off, val, true); off+=2;
        // right
        view.setInt16(off, val, true); off+=2;
      }
      return URL.createObjectURL(new Blob([view], {type:'audio/wav'}));
    }

    // Prime embeds (preserve) without autoplay
    activateCurrentVideo({autoplay:false});
    updateLabels();
  </script>
</body>
</html>
