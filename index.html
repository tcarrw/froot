<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Froot · Marina Color-Breath (Reliable Honey)</title>
<meta name="description" content="Froot — Marina color-breath with a reliable 128 Hz Honey tone that keeps playing when the screen turns off. Reliable Mode (audio element) + Studio Mode (optional FX). True dark theme." />
<meta name="theme-color" content="#0b0d11" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#0b0d11">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0b0d11; --ink:#ecf1f9; --muted:#aeb4c4; --ring:#1a2236; --card:#0f1427;
    --aqua:#b5f0ea; --honey:#ffd37a; --rose:#ff9bb0; --emerald:#8be0b7; --violet:#c9a7ff; --gold:#f6d28b; --peach:#ffb38a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#0b0d11;color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  /* Always-on true dark */
  @media (prefers-color-scheme: light){ html,body{background:#0b0d11;color:var(--ink)} }
  a{color:inherit;text-decoration:none}
  .wrap{max-width:920px;margin:0 auto;padding:16px 16px 80px}

  header{padding:12px 16px 0}
  .brand{display:flex;align-items:center;gap:10px}
  .glyph{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#1b2337,#0f1220);display:grid;place-items:center;box-shadow:inset 0 0 0 1px #222b46}
  .glyph span{font-size:16px}
  h1{font-size:18px;margin:0 0 6px 0}
  .tag{font-size:12px;color:#c9d1e2}

  .ribbon{
    margin:10px 0 8px;display:flex;gap:8px;overflow:auto;padding-bottom:2px;
    -webkit-overflow-scrolling:touch;scrollbar-width:none
  }
  .ribbon::-webkit-scrollbar{display:none}
  .chip{
    white-space:nowrap;font-size:13px;padding:8px 12px;border-radius:999px;flex:0 0 auto;
    background:#121a34;border:1px solid #2a3457;color:#e5ebfb
  }
  .chip[data-hi="1"]{border-color:#75421f;background:#23140a}

  .card{
    background:linear-gradient(180deg,#0f1427 0%, #0b0f1e 100%);border:1px solid var(--ring);
    border-radius:14px;padding:14px;box-shadow:0 10px 28px #0007;margin:12px 0;position:relative
  }
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:740px){ .grid{grid-template-columns:repeat(3,1fr)} }

  .pill,button{
    appearance:none;border:1px solid #2a3457;background:#121a34;color:var(--ink);
    padding:10px 14px;border-radius:999px;font-weight:600;letter-spacing:.2px
  }
  button:active{transform:translateY(1px)}
  .on{background:linear-gradient(90deg,#3a2a12,#241707);border-color:#5e3f1d;box-shadow:0 0 0 1px #523410 inset, 0 0 20px #2b1a08}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#121a34;border:1px solid #2a3457;font-size:13px}
  label{font-size:13px;color:var(--muted)}
  input[type="range"]{width:100%}
  .note{font-size:14px;color:#cfd6ea}
  .soft{color:#b0b6c8}
  .footer{opacity:.9;text-align:center;font-size:12px;color:#aab1c6;margin-top:10px}

  .meter{height:8px;background:#0e1326;border:1px solid #1f2744;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--honey),var(--rose),var(--aqua));transition:width .35s ease}

  .fruit{
    display:flex;flex-direction:column;gap:8px;border:1px solid var(--ring);border-radius:12px;
    padding:12px;background:linear-gradient(180deg,#111633 0%, #0c0f22 100%);box-shadow:0 8px 22px #0007
  }
  .fruit .title{display:flex;align-items:center;gap:8px;font-weight:700}
  .fruit .desc{font-size:13px;color:#cfd6ea}
</style>
</head>
<body>
  <header class="wrap" aria-label="Site header">
    <div class="brand">
      <div class="glyph"><span>🌙</span></div>
      <div>
        <h1>Froot · <span style="text-shadow:0 0 14px #ffd37a77">Marina Color-Breath</span></h1>
        <div class="tag">Reliable 128 Hz Honey (keeps playing when the screen turns off) · optional Studio FX</div>
      </div>
    </div>

    <nav class="ribbon" aria-label="Sites">
      <a class="chip" href="https://mirrorhoney.plnt.earth/">MirrorHoney</a>
      <a class="chip" href="https://earth.plnt.earth/">Earth</a>
      <a class="chip" href="https://honey.plnt.earth/">Honey</a>
      <a class="chip" href="https://mask.plnt.earth/">Mask</a>
      <a class="chip" href="https://voice.plnt.earth/">Voice</a>
      <a class="chip" href="https://jar.plnt.earth/">Jar</a>
      <a class="chip" data-hi="1" href="https://froot.plnt.earth/">Froot</a>
      <a class="chip" href="https://tunes.plnt.earth/">Tunes</a>
      <a class="chip" href="https://bridge.plnt.earth/">Bridge</a>
    </nav>
  </header>

  <main class="wrap" id="main">
    <!-- Reliable Mode (Audio Element) -->
    <section class="card" aria-label="Reliable Honey">
      <div class="row" style="justify-content:space-between;gap:10px">
        <div class="badge">🍯 Reliable Honey — 128 Hz</div>
        <div class="badge">Status: <strong id="statusText">Off</strong></div>
      </div>

      <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
        <button id="startBtn" class="pill">▶︎ Start Honey</button>
        <button id="stopBtn"  class="pill">■ Stop</button>
        <button id="newTabBtn" class="pill">↗︎ Open in New Tab</button>
        <a id="downloadLink" class="pill" download="honey-128hz.wav" href="#">⬇︎ Download Tone</a>
      </div>

      <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
        <label for="volume">Level</label>
        <input id="volume" type="range" min="0" max="100" value="60" step="1" />
        <label for="detune">Fine Detune (±2%)</label>
        <input id="detune" type="range" min="-2" max="2" value="0" step="0.01" />
      </div>

      <div class="meter" style="margin-top:10px"><div class="bar" id="meterBar"></div></div>

      <p class="note" style="margin-top:10px">
        <b>Reliable Mode</b> uses a normal audio element and is the most dependable way to keep the tone playing when the screen turns off.  
        To try with Apple Music, start Honey, then test starting your music app — iOS decides mixing.  
        The <b>Open in New Tab</b> option can help treat the tone like simple media playback.
      </p>

      <!-- Hidden audio element (created WAV on the fly) -->
      <audio id="honeyEl" preload="auto" loop playsinline></audio>
    </section>

    <!-- Studio Mode (optional FX in foreground) -->
    <section class="card" aria-label="Studio FX">
      <div class="row" style="justify-content:space-between;gap:10px">
        <div class="badge">🎛️ Studio Mode (Optional)</div>
        <div class="badge">Foreground-only FX</div>
      </div>

      <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
        <button id="studioBtn" class="pill" aria-pressed="false">○ Studio: Off</button>
        <button id="museBtn" class="pill" aria-pressed="false">○ Muse: Off</button>
        <button id="chorusBtn" class="pill" aria-pressed="false">○ Chorus: Off</button>
      </div>

      <p class="note">
        Studio adds a gentle flutter (Muse) and micro-detune chorus while the page is visible. If the screen locks, the page automatically keeps the **Reliable** tone and quietly suspends these extras.
      </p>
    </section>

    <!-- Froot palette -->
    <section class="card" aria-label="Froot palette">
      <div class="badge">🎨 Pick a Froot (simple voicing)</div>
      <div class="grid" style="margin-top:10px">
        <div class="fruit" data-froot="peach">
          <div class="title" style="color:var(--peach)">🍑 Peach — Ease</div>
          <div class="desc">Slightly slower (softer). PlaybackRate ≈ −0.5%.</div>
          <button class="pill set-froot">Use Peach</button>
        </div>
        <div class="fruit" data-froot="nectar">
          <div class="title" style="color:var(--honey)">🍯 Nectar — Magnet</div>
          <div class="desc">Tiny high lift feel (faster). PlaybackRate ≈ +0.4%.</div>
          <button class="pill set-froot">Use Nectar</button>
        </div>
        <div class="fruit" data-froot="emerald">
          <div class="title" style="color:var(--emerald)">💚 Emerald — Calm Power</div>
          <div class="desc">Centered breath (neutral). PlaybackRate ≈ 0%.</div>
          <button class="pill set-froot">Use Emerald</button>
        </div>
        <div class="fruit" data-froot="violet">
          <div class="title" style="color:var(--violet)">🔮 Violet — Mystery</div>
          <div class="desc">Dream shimmer (enable Muse + small chorus).</div>
          <button class="pill set-froot">Use Violet</button>
        </div>
        <div class="fruit" data-froot="gold">
          <div class="title" style="color:var(--gold)">🌼 Gold — Radiance</div>
          <div class="desc">Open/bright (slightly faster, no flutter).</div>
          <button class="pill set-froot">Use Gold</button>
        </div>
      </div>
    </section>

    <!-- How to use -->
    <section class="card" aria-label="How to use">
      <div class="badge">📝 How to use Froot</div>
      <p class="note">
        1) Tap <b>Start Honey</b> (unlocks audio on iPhone). 2) Nudge detune until your exhale feels effortless.  
        3) Choose a Froot voicing. If you want shimmer, enable Studio and tap Muse/Chorus.  
        If you need background/lock-screen playback, keep **Studio Off** and use Reliable Honey.
      </p>
      <p class="soft">
        Tools: <a href="https://jar.plnt.earth/">Jar</a> · <a href="https://tunes.plnt.earth/">Tunes</a> · Reflection at <a href="https://mirrorhoney.plnt.earth/">MirrorHoney</a>.
      </p>
    </section>

    <div class="footer">True dark theme · zero-network tone · background-friendly · clean buttons.</div>
  </main>

<script>
(() => {
  // Elements
  const statusText = document.getElementById('statusText');
  const startBtn   = document.getElementById('startBtn');
  const stopBtn    = document.getElementById('stopBtn');
  const newTabBtn  = document.getElementById('newTabBtn');
  const downloadLink = document.getElementById('downloadLink');
  const vol        = document.getElementById('volume');
  const det        = document.getElementById('detune');
  const meterBar   = document.getElementById('meterBar');
  const honeyEl    = document.getElementById('honeyEl');

  const studioBtn  = document.getElementById('studioBtn');
  const museBtn    = document.getElementById('museBtn');
  const chorusBtn  = document.getElementById('chorusBtn');
  const frootBtns  = [...document.querySelectorAll('.set-froot')];

  // State
  let on=false, studio=false, muse=false, chorus=false;
  let toneBlob=null, toneURL=null, tabURL=null;
  let ctx=null, srcNode=null, gain=null, panL=null, panR=null, splitter=null, merger=null, lfo=null, lfoGain=null;

  function setBadge(v){ statusText.textContent = v ? 'On' : 'Off'; startBtn.classList.toggle('on', v); }
  function setToggle(btn, v, onLabel, offLabel){
    btn.textContent = v ? onLabel : offLabel;
    btn.setAttribute('aria-pressed', v ? 'true' : 'false');
    btn.classList.toggle('on', v);
  }

  // Build a tiny mono WAV (128 Hz sine, 2s, 48k)
  function makeHoneyWav(sr=48000, seconds=2, freq=128){
    const length = Math.floor(sr*seconds);
    const data = new Int16Array(length);
    const amp = 0.25 * 0x7FFF; // safe headroom
    for(let i=0;i<length;i++){
      data[i] = Math.round(amp * Math.sin(2*Math.PI*freq*(i/sr)));
    }
    // WAV header (PCM 16-bit mono)
    const header = new ArrayBuffer(44);
    const dv=new DataView(header);
    const writeStr=(o,s)=>{ for(let i=0;i<s.length;i++) dv.setUint8(o+i, s.charCodeAt(i)); };
    const byteRate = sr*2, blockAlign=2, dataSize=data.length*2, chunkSize=36+dataSize;
    writeStr(0,"RIFF"); dv.setUint32(4, chunkSize, true); writeStr(8,"WAVE");
    writeStr(12,"fmt "); dv.setUint32(16,16,true); dv.setUint16(20,1,true); dv.setUint16(22,1,true);
    dv.setUint32(24,sr,true); dv.setUint32(28,byteRate,true); dv.setUint16(32,blockAlign,true); dv.setUint16(34,16,true);
    writeStr(36,"data"); dv.setUint32(40,dataSize,true);
    const pcm = new Int16Array(header.byteLength + dataSize);
    // copy header bytes + data
    new Uint8Array(pcm.buffer).set(new Uint8Array(header),0);
    new Int16Array(pcm.buffer,44).set(data);
    return new Blob([pcm],{type:"audio/wav"});
  }

  function ensureTone(){
    if(!toneBlob){
      toneBlob = makeHoneyWav();
      toneURL = URL.createObjectURL(toneBlob);
      honeyEl.src = toneURL;
      downloadLink.href = toneURL; // allow save
    }
  }

  function level(){ return Math.min(1, Math.max(0, vol.value/100)); }
  function applyLevel(){ honeyEl.volume = level(); meterBar.style.width = Math.round(honeyEl.volume*100) + '%'; }
  function applyDetune(){
    const pct = parseFloat(det.value)||0; // ±2%
    honeyEl.playbackRate = 1 + (pct/100); // 0.98..1.02
  }

  async function start(){
    ensureTone();
    try{
      honeyEl.currentTime = 0;
      applyDetune();
      applyLevel();
      await honeyEl.play();
      on = true; setBadge(true);
      if(studio){ enableStudio(); }
    }catch(_){}
  }

  function stop(){
    try{ honeyEl.pause(); }catch(_){}
    on = false; setBadge(false);
    disableStudio();
  }

  newTabBtn.addEventListener('click', ()=>{
    ensureTone();
    // open simple player in new tab for system-level playback UX
    const html = `
      <!doctype html><meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Honey 128 Hz</title>
      <style>html,body{margin:0;height:100%;background:#000;color:#fff;display:grid;place-items:center;font:16px system-ui}</style>
      <audio id="a" src="${toneURL}" loop controls autoplay playsinline style="width:90%"></audio>
      <p style="opacity:.8">Honey — 128 Hz · This tab can keep playing when the screen turns off.</p>
    `;
    const blob = new Blob([html],{type:"text/html"});
    tabURL = URL.createObjectURL(blob);
    window.open(tabURL,"_blank","noopener");
  });

  // Studio Mode (WebAudio FX) — foreground only
  function enableStudio(){
    if(ctx || !on) return;
    try{
      ctx = new (window.AudioContext || window.webkitAudioContext)({latencyHint:'playback'});
      srcNode = ctx.createMediaElementSource(honeyEl);
      // split L/R -> small detune pan
      splitter = ctx.createChannelSplitter(2);
      merger   = ctx.createChannelMerger(2);
      panL = new StereoPannerNode(ctx,{pan:-0.35});
      panR = new StereoPannerNode(ctx,{pan: 0.35});
      // LFO for Muse (modulate playbackRate via playbackRate shim: we modulate element.playbackRate gently)
      lfo = ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.15;
      lfoGain = ctx.createGain(); lfoGain.gain.value = 0; // depth → we’ll map to playbackRate ticks
      lfo.connect(lfoGain);
      // Wire graph: src -> splitter -> panL/panR -> merger -> ctx.destination (mirror element output)
      srcNode.connect(splitter);
      splitter.connect(panL,0); splitter.connect(panR,1);
      panL.connect(merger,0,0); panR.connect(merger,0,1);
      merger.connect(ctx.destination);
      lfo.start();

      // Chorus: we simulate by nudging element rate slightly over time; small, infrequent ticks
      if(chorus){ applyChorus(true); }
      if(muse){ applyMuse(true); }
    }catch(_){}
  }

  function disableStudio(){
    if(!ctx) return;
    try{
      lfo && lfo.stop();
    }catch(_){}
    try{
      ctx.close();
    }catch(_){}
    ctx = srcNode = splitter = merger = panL = panR = lfo = lfoGain = null;
  }

  function applyMuse(enable){
    if(!enable){ if(lfoGain) lfoGain.gain.value = 0; return; }
    if(!lfoGain) return;
    lfoGain.gain.value = 1; // we’ll translate this to small playbackRate wiggles
  }

  // Minimal chorus/muse by gently wiggling playbackRate (keeps element path primary)
  let wiggleTimer=null;
  function startWiggle(){
    stopWiggle();
    wiggleTimer = setInterval(()=>{
      if(!on) return;
      const base = 1 + (parseFloat(det.value)||0)/100;
      let wiggle = 0;
      if(chorus) wiggle += (Math.random()*0.0008 - 0.0004); // ±0.04%
      if(muse)   wiggle += Math.sin(Date.now()/6000)*0.0008; // ±0.08% slow
      honeyEl.playbackRate = base + wiggle;
    }, 250);
  }
  function stopWiggle(){ if(wiggleTimer){ clearInterval(wiggleTimer); wiggleTimer=null; } }

  function applyChorus(enable){ /* handled in wiggle */ }

  // Visibility: if hidden, keep Reliable path only
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ disableStudio(); }
    else if(studio && on){ enableStudio(); }
  });

  // UI bindings
  startBtn.addEventListener('click', start);
  stopBtn .addEventListener('click', stop);
  vol.addEventListener('input', applyLevel);
  det.addEventListener('input', applyDetune);

  setToggle(studioBtn,false,'● Studio: On','○ Studio: Off');
  setToggle(museBtn,false,'● Muse: On','○ Muse: Off');
  setToggle(chorusBtn,false,'● Chorus: On','○ Chorus: Off');

  studioBtn.addEventListener('click', ()=>{
    studio=!studio;
    setToggle(studioBtn,studio,'● Studio: On','○ Studio: Off');
    if(studio && on){ enableStudio(); startWiggle(); }
    else{ disableStudio(); stopWiggle(); applyDetune(); }
  });
  museBtn.addEventListener('click', ()=>{
    muse=!muse; setToggle(museBtn,muse,'● Muse: On','○ Muse: Off');
    if(studio && on){ applyMuse(muse); startWiggle(); } else if(!muse){ stopWiggle(); applyDetune(); }
  });
  chorusBtn.addEventListener('click', ()=>{
    chorus=!chorus; setToggle(chorusBtn,chorus,'● Chorus: On','○ Chorus: Off');
    if(studio && on){ startWiggle(); } else if(!chorus){ stopWiggle(); applyDetune(); }
  });

  // Init UI
  setBadge(false);
  meterBar.style.width = vol.value + '%';
})();
</script>
</body>
</html>
