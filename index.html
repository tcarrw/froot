<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Keep iOS media bar dark -->
  <meta name="theme-color" content="#0b0d11" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#0b0d11">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Froot ‚Äî Marina Reflection Edition ¬∑ Weeks + Honey + FX</title>
  <meta name="description" content="A Marina-inspired color-sense studio with Week/Day practice, Bee notes, Muse skin (night), Honey 128 Hz background, Export/Share/BLE, aurora & butterfly FX, Trickster micro-wander, Pro ‚Üî Goddess modes, and a Liminal Bridge to Jar." />
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0d11; --panel:#121620; --edge:#1e2430; --ink:#e7edf7; --muted:#a9b4c7;
      --ring:#2c3444; --glow:#66e1ff;

      /* Palettes */
      --blue-1:#0b2e40; --blue-2:#2cc2ff;
      --froot-1:#103018; --froot-2:#a4ff65;
      --imm-1:#1b1030;  --imm-2:#b38bff;
      --ad-1:#2b1016;   --ad-2:#ff6a9e;
      --hh-1:#0f1e33;   --hh-2:#86c9ff;
      --accent:#a4ff65;

      /* Muse grain */
      --grain: radial-gradient(circle at 20% 20%, rgba(255,255,255,.05), transparent 35%),
               radial-gradient(circle at 80% 0%, rgba(255,255,255,.04), transparent 40%),
               radial-gradient(circle at 40% 80%, rgba(0,0,0,.08), transparent 45%);

      /* Honey visuals */
      --honey-a:#120e07; --honey-b:#3a2a0f; --honey-c:#d7aa3b; --honey-d:#f7d77a;
    }

    /* Crisp, iOS-friendly typography */
    html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;-webkit-text-size-adjust:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.55 ui-sans-serif, system-ui, -apple-system, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      font-variant-ligatures:common-ligatures contextual; font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    button[disabled]{opacity:.5; cursor:not-allowed}

    /* Layout */
    .wrap{max-width:1080px;margin:0 auto;padding:28px 18px 84px;position:relative;z-index:2}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:12px}
    h1{margin:0;font-size:1.6rem;letter-spacing:.2px}
    .tag{color:var(--muted);font-size:.95rem}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid var(--edge);
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.03)),var(--panel);
      color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;
      transition:box-shadow .2s ease, border-color .2s ease, filter .12s ease;
    }
    button:hover{border-color:var(--ring);box-shadow:0 0 0 2px rgba(102,225,255,.12)}
    button:active{filter:brightness(1.05)}
    .primary{border-color:#28452e;background:linear-gradient(180deg,rgba(164,255,101,.08),rgba(0,0,0,.02))}
    .ghost{opacity:.92}

    .note{font-size:.95rem;color:var(--muted);margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04)),var(--panel);
      border:1px solid var(--edge);border-radius:18px;padding:18px
    }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    .module{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:stretch}
    @media (max-width:920px){ .module{grid-template-columns:1fr} }

    .swatch{
      position:relative;border-radius:14px;border:1px solid var(--edge);overflow:hidden;isolation:isolate;min-height:180px;
      background:linear-gradient(135deg, var(--c1), var(--c2));
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02), 0 10px 30px -12px rgba(0,0,0,.5);
    }
    .swatch::after{content:"";position:absolute;inset:-40%;border-radius:50%;background:radial-gradient(closest-side, rgba(255,255,255,.15), transparent 60%);opacity:.0;transform:scale(.9);transition:opacity .4s ease, transform .4s ease;pointer-events:none}
    .swatch.pulse::after{opacity:.65;transform:scale(1)}
    .label{font-size:.9rem;color:var(--muted);margin:2px 0 8px}

    .controls{display:flex;flex-wrap:wrap;gap:10px}
    .tiny{font-size:.92rem;color:var(--muted)}
    .titleline{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .titleline h3{margin:0;font-size:1.05rem;letter-spacing:.2px}
    .huebar{height:6px;border-radius:999px;background:linear-gradient(90deg, var(--c1), var(--c2));box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 0 18px -6px rgba(0,0,0,.6)}
    .input, textarea{width:100%;background:#0c1018;border:1px solid var(--edge);color:var(--ink);border-radius:12px;padding:11px 12px;min-height:44px}
    textarea{min-height:90px;resize:vertical}

    .map{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
    @media (max-width:920px){ .map{grid-template-columns:repeat(2,1fr)} }
    .chip{
      border:1px solid var(--edge);border-radius:14px;padding:10px;background:linear-gradient(135deg,var(--c1),var(--c2));
      color:#0a0d12;font-weight:700;display:flex;align-items:center;justify-content:center;min-height:68px
    }
    .chip .cap{background:#f5f7fb;color:#0a0d12;border-radius:999px;padding:2px 8px;font-size:.82rem;font-weight:750;margin-left:8px}

    .legend{display:flex;flex-wrap:wrap;gap:10px}
    .legend .pill{border:1px solid var(--edge);border-radius:999px;padding:6px 10px;font-size:.85rem;color:var(--muted)}
    .foot{margin-top:24px;color:var(--muted);font-size:.9rem}
    hr{border:none;height:1px;background:linear-gradient(90deg,transparent,#232b36,transparent);margin:20px 0}
    :focus-visible{outline:2px solid var(--glow);outline-offset:2px}

    /* Week/Day Picker */
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .seg button{padding:8px 12px;border-radius:999px;font-size:.9rem}
    .seg .sel{border-color:#3a5f44;background:linear-gradient(180deg,rgba(164,255,101,.10),rgba(0,0,0,.02))}
    .modebadge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--edge);border-radius:999px;padding:6px 10px;font-size:.9rem;color:var(--muted)}
    .dim{opacity:.35; filter:saturate(.7)}

    /* Muse Skin (night) */
    body.muse::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;background:var(--grain);mix-blend-mode:overlay;opacity:.34;filter:contrast(105%) saturate(102%) blur(.2px)}
    .muse .card{
      border:1px solid transparent;border-radius:24px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.05)) padding-box,
        linear-gradient(120deg, rgba(164,255,101,.35), rgba(134,201,255,.35), rgba(179,139,255,.35)) border-box;
    }
    .muse h1, .muse h3{font-variant-caps:small-caps;letter-spacing:.08em}
    .muse .swatch{border-radius:28px;-webkit-mask-image:radial-gradient(120% 100% at 60% 40%, #000 70%, transparent 100%);mask-image:radial-gradient(120% 100% at 60% 40%, #000 70%, transparent 100%)}
    .muse .swatch.pulse::after{opacity:.78;transform:scale(1.02);background:conic-gradient(from 0deg, rgba(255,255,255,.18), transparent 40%, rgba(255,255,255,.12), transparent 75%);animation:shimmer 6s cubic-bezier(.22,.61,.36,1) infinite}
    @keyframes shimmer {0%{transform:rotate(0) scale(1.02)} 100%{transform:rotate(360deg) scale(1.02)}}

    /* Honey Mode visuals */
    body.honey{
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(247,215,122,.12), transparent 60%),
        radial-gradient(900px 600px at 100% 10%, rgba(215,170,59,.12), transparent 65%),
        linear-gradient(180deg, var(--honey-a), var(--bg));
    }
    .honey .honeycomb{position:fixed;inset:-200px;z-index:1;opacity:.12;pointer-events:none;background-image:
      repeating-linear-gradient(60deg, rgba(255,206,84,.25) 0 2px, transparent 2px 40px),
      repeating-linear-gradient(120deg, rgba(255,206,84,.25) 0 2px, transparent 2px 40px),
      repeating-linear-gradient(0deg, rgba(255,206,84,.15) 0 2px, transparent 2px 35px);
      filter:blur(0.4px) contrast(105%) saturate(105%);animation:honeyFloat 24s linear infinite}
    @keyframes honeyFloat { 0%{transform:translateY(0)} 100%{transform:translateY(40px)} }

    /* Aurora background */
    .aurora{
      position:fixed; inset:-10% -10% -10% -10%; z-index:0; pointer-events:none; opacity:.55;
      background:
        radial-gradient(60% 80% at 10% 20%, rgba(44,194,255,.12), transparent 60%),
        radial-gradient(70% 70% at 80% 10%, rgba(164,255,101,.10), transparent 60%),
        radial-gradient(90% 90% at 50% 120%, rgba(179,139,255,.10), transparent 60%);
      animation:auroraShift 30s linear infinite; filter: blur(18px) saturate(110%);
    }
    @keyframes auroraShift{ 0%{transform:translate3d(0,0,0) rotate(0)} 50%{transform:translate3d(0,-2%,0) rotate(180deg)} 100%{transform:translate3d(0,0,0) rotate(360deg)} }

    /* Princess of Power banner */
    .princess{ position:sticky; top:8px; z-index:3; margin:0 auto 10px; max-width:1080px; display:none; place-items:center; height:40px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08)) padding-box,
        linear-gradient(120deg, rgba(255,211,163,.7), rgba(255,111,186,.6), rgba(134,201,255,.6)) border-box;
      border:1px solid transparent; border-radius:999px; color:#ffe; font-weight:700; letter-spacing:.12em; font-size:.86rem; text-transform:uppercase; box-shadow:0 6px 24px -12px rgba(0,0,0,.6); overflow:hidden}
    .princess .spark{position:absolute; inset:0; pointer-events:none; background:
      radial-gradient(3px 3px at 10% 50%, rgba(255,255,255,.9) 0 40%, transparent 41%),
      radial-gradient(2px 2px at 30% 20%, rgba(255,255,255,.8) 0 45%, transparent 46%),
      radial-gradient(2px 2px at 60% 70%, rgba(255,255,255,.75) 0 45%, transparent 46%),
      radial-gradient(3px 3px at 80% 30%, rgba(255,255,255,.9) 0 40%, transparent 41%); opacity:.6; animation:twinkle 6s ease-in-out infinite}
    @keyframes twinkle{0%,100%{opacity:.3} 50%{opacity:.85}}

    /* Butterfly canvas overlay */
    .fx-canvas{position:fixed; inset:0; z-index:1; pointer-events:none; opacity:.65}

    /* Saver mode reduces motion */
    @media (prefers-reduced-motion: reduce){
      .aurora{animation:none}
      .honey .honeycomb{animation:none}
      .muse .swatch.pulse::after{animation:none}
    }

    /* ===== Breath Phase HUD (overlay inside active swatch) ===== */
    .fbrHUD{ position:absolute; inset:8%; border-radius:50%; pointer-events:none; }
    .fbrHUD .fbrArc{ position:absolute; inset:-6px; border-radius:50%;
      background: conic-gradient(var(--fbr-color, #22d) 0deg var(--fbr-arc, 0deg), transparent var(--fbr-arc, 0deg) 360deg);
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.18));
    }
    .fbrHUD .fbrEdge{ position:absolute; inset:-6px; border-radius:50%; box-shadow:0 0 0 0 rgba(255,255,255,0); }
    .fbrHUD .fbrLabel{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size: clamp(22px, 4.8vw, 40px);
      letter-spacing:.10em; text-shadow:0 1px 2px rgba(0,0,0,.18); mix-blend-mode:hard-light; font-variant-caps:all-small-caps;
    }
    .fbrHUD .fbrEdge.flash{ animation: fbrEdgeFlash 180ms ease-out; }
    @keyframes fbrEdgeFlash{ from{ box-shadow:0 0 0 14px rgba(255,255,255,.92);} to{ box-shadow:0 0 0 0 rgba(255,255,255,0);} }
    .fbr-in   .fbrHUD{ --fbr-color:#2ecc71; }
    .fbr-hold .fbrHUD{ --fbr-color:#f1c40f; }
    .fbr-out  .fbrHUD{ --fbr-color:#e74c3c; }
    .fbr-in   .fbrLabel{ color:#2ecc71; }
    .fbr-hold .fbrLabel{ color:#f1c40f; }
    .fbr-out  .fbrLabel{ color:#e74c3c; }

    /* ===== Quickbar (always-on-top) ===== */
    .quickbar{
      position:fixed; top:10px; right:10px; z-index:9999;
      display:flex; gap:8px; align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.15));
      border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px 10px;
      box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px);
    }
    .qbtn{
      appearance:none; cursor:pointer;
      border:1px solid rgba(255,255,255,.14); border-radius:10px;
      background:rgba(255,255,255,.06); color:#fff; font-weight:800;
      padding:8px 10px; min-width:40px;
    }
    .qbtn.on{ border-color:#3a5f44; background:linear-gradient(180deg, rgba(164,255,101,.18), rgba(0,0,0,.06)); }
    .qbtn.warn{ border-color:#6b2a2a; background:linear-gradient(180deg, rgba(255,86,86,.20), rgba(0,0,0,.06)); }
    .qsep{ width:1px; height:24px; background:rgba(255,255,255,.12); margin:0 2px; }

    /* Bee (b + a) */
    .bee{margin:12px 0 0;border:1px solid rgba(255,255,255,.16);border-radius:16px;padding:14px;background:linear-gradient(180deg, rgba(255,206,84,.10), rgba(0,0,0,.03)) padding-box,linear-gradient(120deg, rgba(255,206,84,.35), rgba(255,111,186,.30), rgba(134,201,255,.30)) border-box;position:relative}
    .bee-head{display:flex;align-items:center;gap:8px;font-weight:800;letter-spacing:.2px}
    .bee-soft{color:var(--muted);font-weight:600}
    .bee p{margin:8px 0 10px}
    .bee-tools{display:flex;gap:8px;flex-wrap:wrap}
    .bee-btn{appearance:none;border:1px solid rgba(255,255,255,.14);border-radius:10px;background:rgba(255,255,255,.06);color:#fff;font-weight:800;padding:8px 10px;cursor:pointer}
    .bee-btn:hover{border-color:rgba(255,255,255,.22);box-shadow:0 0 0 2px rgba(255,206,84,.18)}
    .bee.editing{outline:2px dashed rgba(255,206,84,.4);outline-offset:2px}
    #bee-text[contenteditable="true"]{caret-color:#ffd166}
    .bee-footer{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:9999;display:none;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:linear-gradient(180deg, rgba(255,206,84,.14), rgba(0,0,0,.14)) padding-box,linear-gradient(120deg, rgba(255,206,84,.6), rgba(255,111,186,.45), rgba(134,201,255,.45)) border-box;border:1px solid transparent;color:#fff;font-weight:700;box-shadow:0 12px 28px rgba(0,0,0,.35);backdrop-filter:blur(6px);max-width:90vw;text-align:center}
    .bee-footer.on{display:inline-flex}

    /* Liminal Bridge */
    .bridge-chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.16);border-radius:999px;background:rgba(255,255,255,.06);cursor:pointer}
    .bridge-modal{position:fixed;inset:0;z-index:10020;display:none;align-items:center;justify-content:center;background:rgba(10,12,16,.55);backdrop-filter:blur(6px)}
    .bridge-modal.on{display:flex}
    .bridge-card{width:min(520px,92vw);border:1px solid rgba(255,255,255,.16);border-radius:16px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08)) padding-box,linear-gradient(120deg, rgba(164,255,101,.45), rgba(134,201,255,.40), rgba(255,209,102,.35)) border-box;color:#e7edf7}
    .bridge-title{margin:0 0 6px;font-size:18px;letter-spacing:.2px}
    .bridge-text{margin:6px 0 12px;color:#a9b4c7}
    .bridge-actions{display:flex;gap:10px;flex-wrap:wrap}
    .bridge-btn{appearance:none;border:1px solid rgba(255,255,255,.16);border-radius:12px;background:rgba(255,255,255,.06);color:#fff;font-weight:800;padding:10px 12px;cursor:pointer}
    .bridge-btn.primary{border-color:#28452e;background:linear-gradient(180deg, rgba(164,255,101,.22), rgba(0,0,0,.08))}

    /* ===== Mode toggles (Pro / Goddess) ===== */
    body.mode-pro .aurora{ opacity:.40; filter: blur(16px) saturate(100%); }
    body.mode-pro .card{ filter:saturate(96%) contrast(102%) }
    body.mode-pro .muse .card{ border-radius:18px }

    body.mode-goddess .aurora{ opacity:.70; filter: blur(18px) saturate(115%) }
    body.mode-goddess .card{ filter:saturate(108%) contrast(104%) }

    /* ===== First Light Guide (onboarding) ===== */
    .firstlight{position:fixed;inset:0;z-index:10010;display:none;align-items:center;justify-content:center;background:rgba(10,12,16,.65);backdrop-filter:blur(8px)}
    .firstlight.on{display:flex}
    .fl-card{width:min(620px,94vw);border-radius:16px;border:1px solid rgba(255,255,255,.16);padding:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.12)) padding-box,
                 linear-gradient(120deg, rgba(164,255,101,.45), rgba(134,201,255,.40), rgba(255,209,102,.35)) border-box;
      color:#e7edf7;box-shadow:0 18px 50px rgba(0,0,0,.45)}
    .fl-title{margin:0 0 6px;font-size:18px;letter-spacing:.2px}
    .fl-text{margin:6px 0 12px;color:#a9b4c7}
    .fl-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .fl-btn{appearance:none;border:1px solid rgba(255,255,255,.16);border-radius:12px;background:rgba(255,255,255,.06);color:#fff;font-weight:800;padding:10px 12px;cursor:pointer}
    .fl-btn.primary{border-color:#28452e;background:linear-gradient(180deg, rgba(164,255,101,.22), rgba(0,0,0,.08))}
    .fl-remember{margin-right:auto;display:flex;align-items:center;gap:6px;color:#a9b4c7;font-size:.9rem}
    .fl-step{display:none}
    .fl-step.on{display:block}

    /* Highlight the target module when we ‚ÄúJust begin‚Äù */
    .focus-pulse{animation:focusPulse 1.6s ease-out 1}
    @keyframes focusPulse{
      0%{ box-shadow:0 0 0 0 rgba(164,255,101,.0) }
      50%{ box-shadow:0 0 0 6px rgba(164,255,101,.25) }
      100%{ box-shadow:0 0 0 0 rgba(164,255,101,.0) }
    }
  </style>
</head>
<body>
  <!-- Quickbar -->
  <div class="quickbar" role="toolbar" aria-label="Quick controls">
    <button id="qb-mute" class="qbtn" type="button" title="Mute / Unmute" onclick="toggleMute()">üîä</button>
    <div class="qsep" aria-hidden="true"></div>
    <button id="qb-honey" class="qbtn" type="button" title="Toggle Honey 128 Hz" onclick="toggleHoneyFromQuick()">üçØ</button>
    <button id="qb-loop" class="qbtn" type="button" title="Toggle Loop" onclick="document.getElementById('loopToggle').click()">üîÅ</button>
    <button id="qb-trick" class="qbtn" type="button" title="Toggle Trickster (gentle drift)" onclick="toggleTrickster()">üÉè</button>
    <button id="qb-mode" class="qbtn" type="button" title="Toggle Mode: Pro ‚Üî Goddess" onclick="toggleMode()">üëë</button>
    <button id="qb-help" class="qbtn" type="button" title="What is this?" onclick="openFirstLight()">‚ùì</button>
  </div>

  <!-- Background FX layers -->
  <div class="aurora" aria-hidden="true"></div>
  <div class="honeycomb" aria-hidden="true"></div>
  <canvas id="fx-butterflies" class="fx-canvas" aria-hidden="true"></canvas>

  <!-- Princess banner -->
  <div id="princessBanner" class="princess" role="status" aria-live="polite">
    <span style="margin-right:8px">üëë</span> PRINCESS OF POWER
    <div class="spark"></div>
  </div>

  <div class="wrap">
    <header>
      <div>
        <h1>Froot ‚Äî <span style="opacity:.9">Marina Reflection Edition</span></h1>
        <div class="tag">Breathe with color. One week, one hue; one day, one ritual. The tone leads, the orb whispers <em>In / Hold / Out</em>, and you leave a single word like a breadcrumb back to yourself.</div>
      </div>
      <div class="actions">
        <button class="ghost" type="button" onclick="toggleMuse()">Muse</button>
        <button class="ghost" type="button" onclick="toggleHoney()">Honey</button>
        <button class="ghost" type="button" onclick="toggleButterfly()">Butterfly</button>
        <button class="ghost" type="button" onclick="togglePrincess()">Princess</button>
        <button class="ghost" type="button" onclick="toggleSaver()">Saver</button>
        <button class="ghost" type="button" onclick="openBridge()">Bridge</button>
        <button class="primary" type="button" onclick="exportMap()">Export</button>
        <button class="ghost" type="button" onclick="shareMap()">Share</button>
        <button class="ghost" type="button" onclick="bleSend()">Bluetooth</button>
        <button class="ghost" type="button" onclick="resetMap()">Reset</button>
        <button class="ghost" type="button" onclick="window.print()">Print</button>
      </div>
    </header>

    <!-- üêù Bee Note (b) -->
    <section id="bee" class="bee" role="note" aria-live="polite">
      <div class="bee-head"><span>üêù</span><span><strong>Bee Note to Marina</strong></span> <span class="bee-soft">You are safe, guided, and loved.</span></div>
      <p id="bee-text">Hi Marina ‚Äî we‚Äôll go slowly. Choose your week and day, listen softly, and let one word arrive. If anything feels loud, we pause. I‚Äôm right here.</p>
      <div class="bee-tools">
        <button type="button" class="bee-btn" onclick="beeEdit()">Edit</button>
        <button type="button" class="bee-btn" onclick="beeSave()">Save</button>
        <button type="button" class="bee-btn" onclick="beeReset()">Reset</button>
        <button type="button" class="bee-btn" onclick="openFirstLight()">‚ùì Guide</button>
        <button type="button" class="bee-btn" onclick="openBridge()">üåâ Bridge</button>
      </div>
    </section>

    <!-- Week/Day Controls -->
    <section class="card">
      <div class="row">
        <div class="label">Practice Rhythm</div>
        <div class="seg" id="weekSeg"></div>
        <div class="seg" id="daySeg" style="margin-top:6px"></div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap">
          <span id="modeBadge" class="modebadge">üéØ Mode: Signal</span>
          <div id="varGroup" class="modebadge" style="display:none">
            <span>Œîfreq</span>
            <input id="varSlider" type="range" min="-50" max="50" value="0" step="1" style="width:160px;vertical-align:middle" oninput="onVarChange(this.value)">
            <span id="varOut">0 Hz</span>
          </div>

          <!-- Loop toggle -->
          <label class="modebadge" style="cursor:pointer">
            <input id="loopToggle" type="checkbox" onchange="setLoop(this.checked)" style="margin-right:8px">
            üîÅ Loop tone (hands-free)
          </label>

          <!-- Loop auto‚Äëstop -->
          <label class="modebadge" style="cursor:pointer">
            ‚è±Ô∏è Auto‚Äëstop:
            <select id="loopTimer" onchange="setLoopTimer(this.value)" style="margin-left:6px">
              <option value="0">Off</option>
              <option value="5">5m</option>
              <option value="10">10m</option>
              <option value="20" selected>20m</option>
              <option value="30">30m</option>
              <option value="45">45m</option>
              <option value="60">60m</option>
            </select>
            <span id="loopCountdown" style="margin-left:8px; opacity:.85"></span>
          </label>
        </div>
        <div class="tiny">W1‚ÄìW5 focus on one color each week. W6 integrates your map. Day 1 Signal ‚Ä¢ Days 2‚Äì5 Variation (Œîfreq) ‚Ä¢ Day 6 Quiet Walk ‚Ä¢ Day 7 Integration.</div>
      </div>
    </section>

    <!-- Honey controls -->
    <section class="card" id="honey-controls" style="display:none">
      <div class="row">
        <div class="label">üçØ Honey ‚Äî 128‚ÄØHz Background Bed</div>
        <div class="controls">
          <button type="button" onclick="honeyStart()">Play 128‚ÄØHz</button>
          <button type="button" onclick="honeyStop()">Stop</button>
          <label class="label" style="margin-left:6px">Volume
            <input id="honeyVol" type="range" min="0" max="100" value="28" oninput="honeyVolume(this.value)" style="width:160px;vertical-align:middle">
          </label>
        </div>
        <div class="tiny">Use gently, like lamplight. Honey and the tone both honor the mute button (üîä) in the corner.</div>
      </div>
    </section>

    <!-- Intro -->
    <section class="card">
      <div class="row">
        <div>
          <div class="label">Welcome</div>
          <p style="margin:.2rem 0 0">
            Each session is a small ceremony: choose your <strong>Week</strong>, your <strong>Day</strong>, then the color offers a single tone. You may turn on <strong>Loop</strong> for hands‚Äëfree breathwork (the orb will clearly mark <em>IN ‚Üí HOLD ‚Üí OUT</em>). When the minute is done, leave just <strong>one word</strong> ‚Äî the flavor of what you heard.
          </p>
          <div class="note">On Days 2‚Äì5, a Œîfreq slider lets you nudge the note; the tone will <em>glide</em> without clicks when looping. Day 6 is a quiet walk: no tone. Week 6 gathers every color into a single page of you.</div>
        </div>
        <div>
          <div class="legend" style="margin-top:8px">
            <span class="pill">üîÅ Loop for hands‚Äëfree</span>
            <span class="pill">üçØ Honey = warm bed @ 128‚ÄØHz</span>
            <span class="pill">üÉè Trickster = gentle drift</span>
            <span class="pill">üåâ Bridge = Practice ‚áÑ Reflect</span>
            <span class="pill">üîä Mute = instant hush</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Modules -->
    <div class="grid" id="modules">
      <!-- BLUE -->
      <section class="card module" style="--c1:var(--blue-1);--c2:var(--blue-2)" data-key="blue" data-week="1" data-freq="329.63">
        <div>
          <div class="titleline"><h3>BLUE ‚Äî Ocean Neon</h3><div class="huebar" aria-hidden="true"></div></div>
          <div class="swatch" id="swatch-blue" role="img" aria-label="Blue gradient pulse"></div>
        </div>
        <div>
          <div class="label">Tasting Ritual</div>
          <div class="controls" style="margin-bottom:10px">
            <button id="play-blue" type="button" onclick="playTone('blue')">Hear Tone</button>
            <button id="stop-blue" type="button" onclick="stopTone()">Stop</button>
          </div>
          <div class="tiny"><em>E4 ‚âà 329.63‚ÄØHz ‚Äî chrome tide at midnight.</em></div>
          <ol class="ritual">
            <li>Select <strong>W1</strong> and today‚Äôs <strong>Day</strong> above.</li>
            <li>Tap <strong>Hear Tone</strong>. Switch on <strong>üîÅ Loop</strong> if you want a continuous note while you breathe.</li>
            <li>Match the orb‚Äôs phases: <strong>IN</strong> (slow), <strong>HOLD</strong> (still), <strong>OUT</strong> (longer). A ring and a tiny flash mark each switch.</li>
            <li>On Days 2‚Äì5, adjust <strong>Œîfreq</strong> to taste; the pitch <em>glides</em> to avoid clicks.</li>
            <li>Optionally layer <strong>üçØ Honey</strong> for warmth, or use the corner <strong>üîä Mute</strong> for instant silence.</li>
            <li>Type one word below ‚Äî the blue you tasted ‚Äî then move on with your day.</li>
          </ol>
          <div class="aside">If anything feels off, stop. Soft volume is wise; headphones are kinder than speakers.</div>
          <div style="margin-top:10px">
            <div class="label">Name the color you hear</div>
            <input class="input" id="word-blue" maxlength="24" placeholder="e.g., tide / neon / hush" oninput="saveWord('blue', this.value)" />
          </div>
        </div>
      </section>

      <!-- FROOT -->
      <section class="card module" style="--c1:var(--froot-1);--c2:var(--froot-2)" data-key="froot" data-week="2" data-freq="554.37">
        <div>
          <div class="titleline"><h3>FROOT ‚Äî Electric Lime</h3><div class="huebar" aria-hidden="true"></div></div>
          <div class="swatch" id="swatch-froot" role="img" aria-label="Electric lime gradient pulse"></div>
        </div>
        <div>
          <div class="label">Tasting Ritual</div>
          <div class="controls" style="margin-bottom:10px">
            <button id="play-froot" type="button" onclick="playTone('froot')">Hear Tone</button>
            <button id="stop-froot" type="button" onclick="stopTone()">Stop</button>
          </div>
          <div class="tiny"><em>C‚ôØ5 ‚âà 554.37‚ÄØHz ‚Äî laser citrus on the tongue.</em></div>
          <ol class="ritual">
            <li>Confirm <strong>W2</strong> and your <strong>Day</strong>.</li>
            <li>Tap <strong>Hear Tone</strong>. For walking or journaling, enable <strong>üîÅ Loop</strong> and set an <strong>Auto‚Äëstop</strong> timer.</li>
            <li>Breathe with the orb‚Äôs cues; the word ‚ÄúIN / HOLD / OUT‚Äù appears right in the glow.</li>
            <li>Days 2‚Äì5: nudge <strong>Œîfreq</strong>. The sound eases to the new pitch (no crackle).</li>
            <li>Layer <strong>üçØ Honey</strong> if you like a low, steady bed. Use <strong>üîä</strong> anytime.</li>
            <li>Offer one word ‚Äî the lime‚Äôs aftertaste.</li>
          </ol>
          <div class="aside">Quiet Walk (Day‚ÄØ6) disables the active week‚Äôs tone ‚Äî let color ride along in silence.</div>
          <div style="margin-top:10px">
            <div class="label">Name the color you hear</div>
            <input class="input" id="word-froot" maxlength="24" placeholder="e.g., zest / spark / sugar" oninput="saveWord('froot', this.value)" />
          </div>
        </div>
      </section>

      <!-- IMMORTAL -->
      <section class="card module" style="--c1:var(--imm-1);--c2:var(--imm-2)" data-key="immortal" data-week="3" data-freq="220">
        <div>
          <div class="titleline"><h3>IMMORTAL ‚Äî Violet Dusk</h3><div class="huebar" aria-hidden="true"></div></div>
          <div class="swatch" id="swatch-immortal" role="img" aria-label="Violet dusk gradient pulse"></div>
        </div>
        <div>
          <div class="label">Tasting Ritual</div>
          <div class="controls" style="margin-bottom:10px">
            <button id="play-immortal" type="button" onclick="playTone('immortal')">Hear Tone</button>
            <button id="stop-immortal" type="button" onclick="stopTone()">Stop</button>
          </div>
          <div class="tiny"><em>A3 = 220‚ÄØHz ‚Äî violet glass, candle smoke.</em></div>
          <ol class="ritual">
            <li>Choose <strong>W3</strong>, choose the <strong>Day</strong>.</li>
            <li>Press <strong>Hear Tone</strong>. Turn on <strong>üîÅ Loop</strong> for sustained stillness (background‚Äësafe on iPhone).</li>
            <li>Let the orb lead the breath. When the ring flashes, switch phases.</li>
            <li>On Variation days, slide <strong>Œîfreq</strong> as mood requires; the pitch glides cleanly.</li>
            <li>Add <strong>üçØ Honey</strong> if you want warmth beneath the dusk.</li>
            <li>Write a single word ‚Äî a violet you can return to later.</li>
          </ol>
          <div class="aside">If you feel light‚Äëheaded, pause. This practice is gentler than ambition.</div>
          <div style="margin-top:10px">
            <div class="label">Name the color you hear</div>
            <input class="input" id="word-immortal" maxlength="24" placeholder="e.g., veil / echo / dusk" oninput="saveWord('immortal', this.value)" />
          </div>
        </div>
      </section>

      <!-- ANCIENT -->
      <section class="card module" style="--c1:var(--ad-1);--c2:var(--ad-2)" data-key="ancient" data-week="4" data-freq="349.23">
        <div>
          <div class="titleline"><h3>ANCIENT DREAMS ‚Äî Rose Aurora</h3><div class="huebar" aria-hidden="true"></div></div>
          <div class="swatch" id="swatch-ancient" role="img" aria-label="Rose aurora gradient pulse"></div>
        </div>
        <div>
          <div class="label">Tasting Ritual</div>
          <div class="controls" style="margin-bottom:10px">
            <button id="play-ancient" type="button" onclick="playTone('ancient')">Hear Tone</button>
            <button id="stop-ancient" type="button" onclick="stopTone()">Stop</button>
          </div>
          <div class="tiny"><em>F4 ‚âà 349.23‚ÄØHz ‚Äî rose dawn, bronze halo.</em></div>
          <ol class="ritual">
            <li>Set <strong>W4</strong> and your <strong>Day</strong>.</li>
            <li>Begin with <strong>Hear Tone</strong>. For writing or stretching, enable <strong>üîÅ Loop</strong> and, if helpful, a 10‚Äì20‚ÄØmin <strong>Auto‚Äëstop</strong>.</li>
            <li>Follow <strong>IN ‚Üí HOLD ‚Üí OUT</strong>. The orb‚Äôs edge flashes exactly when to change.</li>
            <li>Days 2‚Äì5: explore with <strong>Œîfreq</strong>. The sound transitions smoothly to guard against crackle.</li>
            <li>Layer <strong>üçØ Honey</strong> as a low hum underneath. Use <strong>üîä</strong> for instant hush.</li>
            <li>Capture one word ‚Äî the rose that arrived.</li>
          </ol>
          <div class="aside">Quiet Walk on Day‚ÄØ6 is part of the music ‚Äî the breath becomes the instrument.</div>
          <div style="margin-top:10px">
            <div class="label">Name the color you hear</div>
            <input class="input" id="word-ancient" maxlength="24" placeholder="e.g., blush / halo / myrrh" oninput="saveWord('ancient', this.value)" />
          </div>
        </div>
      </section>

      <!-- HEAVEN -->
      <section class="card module" style="--c1:var(--hh-1);--c2:var(--hh-2)" data-key="heaven" data-week="5" data-freq="587.33">
        <div>
          <div class="titleline"><h3>HANDMADE HEAVEN ‚Äî Sky Bloom</h3><div class="huebar" aria-hidden="true"></div></div>
          <div class="swatch" id="swatch-heaven" role="img" aria-label="Sky bloom gradient pulse"></div>
        </div>
        <div>
          <div class="label">Tasting Ritual</div>
          <div class="controls" style="margin-bottom:10px">
            <button id="play-heaven" type="button" onclick="playTone('heaven')">Hear Tone</button>
            <button id="stop-heaven" type="button" onclick="stopTone()">Stop</button>
          </div>
          <div class="tiny"><em>D5 ‚âà 587.33‚ÄØHz ‚Äî cold sunshine, bluebell air.</em></div>
          <ol class="ritual">
            <li>Choose <strong>W5</strong> and your <strong>Day</strong>.</li>
            <li>Tap <strong>Hear Tone</strong>. For a steady field of sky, switch on <strong>üîÅ Loop</strong>.</li>
            <li>Let breath and word arrive together. The orb keeps the time.</li>
            <li>On Variation days, shift <strong>Œîfreq</strong> by feel; the note glides, click‚Äëfree.</li>
            <li>Honey (üçØ) adds warmth; <strong>üîä</strong> mutes instantly.</li>
            <li>Offer one word ‚Äî the weather inside.</li>
          </ol>
          <div class="aside">Week‚ÄØ6 gathers all five words; export or share from the top when you‚Äôre ready.</div>
          <div style="margin-top:10px">
            <div class="label">Name the color you hear</div>
            <input class="input" id="word-heaven" maxlength="24" placeholder="e.g., wing / hush / bell" oninput="saveWord('heaven', this.value)" />
          </div>
        </div>
      </section>
    </div>

    <!-- Integration Journal -->
    <section class="card" id="journal">
      <div class="titleline"><h3>Week Journal ‚Äî Integration</h3><div class="huebar" style="--c1:#3a3f4a;--c2:#778199" aria-hidden="true"></div></div>
      <div class="row">
        <div><div class="label">Week Note</div><textarea id="j_note" placeholder="One short reflection from this week."></textarea></div>
        <div><div class="label">Resonance Poem (3 lines)</div><textarea id="j_poem" placeholder="Line 1&#10;Line 2&#10;Line 3"></textarea></div>
      </div>
      <div class="foot">Your map and words live on your device only. On Week‚ÄØ6, the Princess banner graces your export.</div>
    </section>

    <!-- Map -->
    <section class="card" id="map-card">
      <div class="titleline"><h3>Your Synesthesia Map</h3><div class="huebar" style="--c1:#3a3f4a;--c2:#778199" aria-hidden="true"></div></div>
      <div class="map" id="map"></div>
      <div class="foot">Export, share, or send via BLE when you want to carry your colors elsewhere. <button class="bridge-chip" type="button" onclick="openBridge()">üåâ Bridge</button></div>
    </section>

    <footer class="note">Last touch: if the world feels loud, tap üîä to hush; tap üîÅ to return to the small steady thing that is your breath. ‚Äî <b>üêù</b></footer>
  </div>

  <!-- Hidden audio element that keeps iOS audio session alive while locked -->
  <audio id="bgPipe" preload="auto" playsinline style="position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0"></audio>

  <!-- Bee footer whisper (a) -->
  <div id="bee-footer" class="bee-footer" role="status" aria-live="polite"><span>üêù</span>&nbsp;<span id="bee-footer-text">Here is slow and safe.</span></div>

  <!-- üåâ Liminal Bridge modal -->
  <div id="bridgeModal" class="bridge-modal" role="dialog" aria-modal="true" aria-labelledby="bridgeTitle">
    <div class="bridge-card">
      <h3 id="bridgeTitle" class="bridge-title">Liminal Bridge</h3>
      <p class="bridge-text">Two lights, one path: <b>Practice</b> here in Froot (tone, breath, word) or <b>Reflect</b> in Jar (School, Rooms, Egg). Audio will pause as we cross. We‚Äôll keep the warmth on the other side. ‚Äî <b>üêù</b></p>
      <div class="bridge-actions">
        <button class="bridge-btn" type="button" onclick="bridgeTo('jar.school')">‚Ü© Go to Jar ¬∑ School</button>
        <button class="bridge-btn" type="button" onclick="bridgeTo('jar.rooms')">‚Ü© Go to Jar ¬∑ Rooms</button>
        <button class="bridge-btn" type="button" onclick="bridgeTo('jar.egg')">‚Ü© Egg Map</button>
        <button class="bridge-btn primary" type="button" onclick="closeBridge()">Stay in Froot</button>
      </div>
    </div>
  </div>

  <!-- ‚ùì First Light Guide (3 steps, Bee voice) -->
  <div id="firstLight" class="firstlight" role="dialog" aria-modal="true" aria-labelledby="fl1title">
    <div class="fl-card">

      <!-- Step 1 -->
      <div id="flStep1" class="fl-step on">
        <h3 id="fl1title" class="fl-title">Welcome to Froot</h3>
        <p class="fl-text">One week, one hue; one minute to breathe; one word to keep. I‚Äôll guide you. ‚Äî <b>üêù</b></p>
        <div class="fl-actions">
          <label class="fl-remember"><input id="flRemember1" type="checkbox" checked> Don‚Äôt show this again</label>
          <button class="fl-btn" type="button" onclick="flGo(2)">Tell me more</button>
          <button class="fl-btn primary" type="button" onclick="flBegin()">Just begin (W1 ¬∑ Blue)</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div id="flStep2" class="fl-step">
        <h3 class="fl-title">How the 42‚Äëday spiral works</h3>
        <p class="fl-text">
          Six weeks hold the arc. Day 1 is <b>Signal</b>. Days 2‚Äì5 are <b>Variation</b> (you can nudge Œîfreq). Day 6 is <b>Quiet Walk</b> (no tone). Day 7 is <b>Integration</b>. In Week 6 we gather your words into a map.
        </p>
        <div class="fl-actions">
          <label class="fl-remember"><input id="flRemember2" type="checkbox" checked> Don‚Äôt show this again</label>
          <button class="fl-btn" type="button" onclick="flGo(1)">Back</button>
          <button class="fl-btn" type="button" onclick="flGo(3)">Next</button>
        </div>
      </div>

      <!-- Step 3 -->
      <div id="flStep3" class="fl-step">
        <h3 class="fl-title">Jar, Egg, and your Map</h3>
        <p class="fl-text">
          <b>Froot</b> is practice (tone, breath, word). <b>Jar</b> is reflection (School &amp; Rooms). The <b>Egg</b> is the origin story that made this studio.
          Your Map stays on your device; export whenever you wish. Curious? I can take you to the Egg.
        </p>
        <p class="fl-text" style="font-size:.9rem;opacity:.95">
          Symbols: ‚ÄúPrincess of Power‚Äù marks integration/celebration. The ‚ÄúLady in Red‚Äù is our Trickster cameo ‚Äî
          a gentle invitation to step just outside the loop, safely.
        </p>
        <div class="fl-actions">
          <label class="fl-remember"><input id="flRemember3" type="checkbox" checked> Don‚Äôt show this again</label>
          <button class="fl-btn" type="button" onclick="flGo(2)">Back</button>
          <button class="fl-btn" type="button" onclick="bridgeTo('jar.egg')">Visit Egg Map</button>
          <button class="fl-btn primary" type="button" onclick="flBegin()">Start practicing</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    /* ===== Cross-host helpers (Froot ‚áÑ Jar) ===== */
    function jarBaseURL(){
      var h = location.hostname;
      if(h==='localhost'||h==='127.0.0.1') return '';
      var p=h.split('.'); if(p.length>=2){ p[0]='jar'; return location.protocol+'//'+p.join('.'); }
      return '';
    }
    function openBridge(){ try{ stopTone(); }catch(_){} try{ honeyStop(); }catch(_){ } document.getElementById('bridgeModal').classList.add('on'); }
    function closeBridge(){ document.getElementById('bridgeModal').classList.remove('on'); }
    function bridgeTo(dest){
      try{ stopTone(); }catch(_){}
      try{ honeyStop(); }catch(_){}
      var base = jarBaseURL()||'';
      var url = '/school.html';
      if(dest==='jar.rooms') url='/school-rooms.html';
      if(dest==='jar.egg') url='/marina-egg.html';
      try{ location.href = base + url; }catch(_){ location.assign(base+url); }
    }

    /* ===== Bee (b + a) ===== */
    var BEE_NOTE_KEY='froot_bee_note_v1', beeTimer=0;
    function beeDefaultText(){
      return "Hi Marina ‚Äî we‚Äôll go slowly. Choose your week and day, listen softly, and let one word arrive. If anything feels loud, we pause. You are safe, guided, and loved.";
    }
    (function beeInit(){
      var t=document.getElementById('bee-text');
      try{ var saved=localStorage.getItem(BEE_NOTE_KEY)||""; if(saved.trim()) t.textContent=saved; else t.textContent=beeDefaultText(); }catch(_){ t.textContent=beeDefaultText(); }
      beeWhisper("Here is slow and safe.", 3800);
    })();
    function beeEdit(){
      var box=document.getElementById('bee'), t=document.getElementById('bee-text');
      box.classList.add('editing'); t.setAttribute('contenteditable','true'); t.focus();
      try{ var s=window.getSelection(), r=document.createRange(); r.selectNodeContents(t); r.collapse(false); s.removeAllRanges(); s.addRange(r);}catch(_){}
    }
    function beeSave(){
      var box=document.getElementById('bee'), t=document.getElementById('bee-text');
      t.setAttribute('contenteditable','false'); box.classList.remove('editing');
      var val=(t.textContent||"").trim(); try{ localStorage.setItem(BEE_NOTE_KEY, val); }catch(_){}
      beeWhisper("Saved with love. Thank you.", 2600);
    }
    function beeReset(){
      var box=document.getElementById('bee'), t=document.getElementById('bee-text');
      t.textContent=beeDefaultText(); t.setAttribute('contenteditable','false'); box.classList.remove('editing');
      try{ localStorage.setItem(BEE_NOTE_KEY, t.textContent); }catch(_){}
      beeWhisper("Back to the gentle original.", 2600);
    }
    function beeWhisper(text, ms){
      var el=document.getElementById('bee-footer'), tx=document.getElementById('bee-footer-text');
      if(!el||!tx) return; tx.textContent=text; el.classList.add('on');
      if(beeTimer){ clearTimeout(beeTimer); beeTimer=0; }
      if(ms && ms>0){ beeTimer=setTimeout(function(){ el.classList.remove('on'); }, ms); }
    }

    /* ===== Prefs (Muse default ON, others OFF) ===== */
    var PREFS_KEY="froot_prefs_v3";
    function loadPrefs(){ try{var r=localStorage.getItem(PREFS_KEY); if(r) return JSON.parse(r)}catch(e){} return {muse:true,honey:false,butterfly:false,princess:false,saver:false} }
    function savePrefs(){
      try{
        localStorage.setItem(PREFS_KEY, JSON.stringify({
          muse:document.body.classList.contains('muse'),
          honey:document.body.classList.contains('honey'),
          butterfly:document.body.classList.contains('fx-on'),
          princess:document.body.classList.contains('princess-on'),
          saver:document.body.classList.contains('saver')
        }));
      }catch(e){}
    }
    var prefs = loadPrefs();
    if(prefs.muse) document.body.classList.add("muse");
    if(prefs.honey) document.body.classList.add("honey");
    if(prefs.butterfly) document.body.classList.add("fx-on");
    if(prefs.princess) document.body.classList.add("princess-on");
    if(prefs.saver) document.body.classList.add("saver");

    /* ===== Week/Day schedule ===== */
    var SCHEDULE_KEY="froot_schedule_v1";
    function loadSched(){ try{var r=localStorage.getItem(SCHEDULE_KEY); if(r) return JSON.parse(r)}catch(e){} return {week:1, day:1} }
    function saveSched(){ try{ localStorage.setItem(SCHEDULE_KEY, JSON.stringify(schedule)) }catch(e){} }
    var schedule = loadSched(); // week:1-6, day:1-7

    var WEEK_KEYS = {1:"blue",2:"froot",3:"immortal",4:"ancient",5:"heaven",6:"integration"};
    var VAR_KEY="froot_variation_v1";
    function loadVar(){ try{var r=localStorage.getItem(VAR_KEY); if(r) return JSON.parse(r)}catch(e){} return {blue:0,froot:0,immortal:0,ancient:0,heaven:0} }
    function saveVar(){ try{ localStorage.setItem(VAR_KEY, JSON.stringify(variation)) }catch(e){} }
    var variation = loadVar(); // per-color ŒîHz

    /* ===== Map & Journal state ===== */
    var FROOT_KEY="froot_marina_map_v1";
    function loadMap(){ try{var raw=localStorage.getItem(FROOT_KEY); if(raw){return JSON.parse(raw)} }catch(e){} return {blue:"",froot:"",immortal:"",ancient:"",heaven:""} }
    var mapData=loadMap();
    function persist(){ try{localStorage.setItem(FROOT_KEY, JSON.stringify(mapData))}catch(e){} renderMap(); hydrateInputs() }
    function saveWord(key,val){ mapData[key]=(val||"").trim(); persist() }
    function resetMap(){ mapData={blue:"",froot:"",immortal:"",ancient:"",heaven:""}; stopTone(); honeyStop(); persist(); beeWhisper("Cleared. We can begin again.", 2400); }

    var J_KEY="froot_journal_v1";
    function loadJournal(){ try{var r=localStorage.getItem(J_KEY); if(r) return JSON.parse(r)}catch(e){} return {} }
    function saveJournal(){ try{ localStorage.setItem(J_KEY, JSON.stringify(journal)) }catch(e){} }
    var journal = loadJournal(); // {1:{note:'',poem:''}, ...}

    function hydrateJournal(){
      var w = schedule.week;
      var j = journal[w] || {note:"",poem:""};
      var n = document.getElementById("j_note"), p = document.getElementById("j_poem");
      if(n) n.value = j.note || "";
      if(p) p.value = j.poem || "";
    }

    function renderWeekSeg(){
      var host = document.getElementById('weekSeg'); host.innerHTML="";
      for(var i=1;i<=6;i++){
        var b=document.createElement('button'); b.textContent="W"+i;
        if(i===schedule.week) b.classList.add("sel");
        (function(ii){ b.onclick=function(){ schedule.week=ii; saveSched(); applyScheduleUI(); } })(i);
        host.appendChild(b);
      }
    }
    function renderDaySeg(){
      var host = document.getElementById('daySeg'); host.innerHTML="";
      for(var i=1;i<=7;i++){
        var b=document.createElement('button'); b.textContent="Day "+i;
        if(i===schedule.day) b.classList.add("sel");
        (function(ii){ b.onclick=function(){ schedule.day=ii; saveSched(); applyScheduleUI(); } })(i);
        host.appendChild(b);
      }
    }

    function modeFor(schedule){
      if(schedule.week===6) return {icon:"üß≠", name:"Integration"};
      if(schedule.day===1) return {icon:"üéØ", name:"Signal"};
      if(schedule.day>=2 && schedule.day<=5) return {icon:"üéöÔ∏è", name:"Variation"};
      if(schedule.day===6) return {icon:"üö∂", name:"Quiet Walk"};
      return {icon:"üìú", name:"Integration"};
    }

    function applyScheduleUI(){
      renderWeekSeg(); renderDaySeg(); hydrateJournal();

      var mode = modeFor(schedule);
      var badge = document.getElementById('modeBadge');
      if(badge) badge.textContent = mode.icon + " Mode: " + mode.name;

      var activeKey = WEEK_KEYS[schedule.week];
      var cards = document.querySelectorAll('.module');
      cards.forEach(function(card){
        var wk = Number(card.getAttribute('data-week'));
        var k  = card.getAttribute('data-key');
        var dim = (wk !== schedule.week);
        card.style.opacity = dim ? 0.45 : 1;
        var play = document.getElementById('play-'+k);
        var stop = document.getElementById('stop-'+k);
        if(play){ play.disabled = dim; }
        if(stop){ stop.disabled = dim; }
      });

      var varGroup = document.getElementById('varGroup');
      var slider = document.getElementById('varSlider');
      var out = document.getElementById('varOut');
      if(schedule.week<=5 && schedule.day>=2 && schedule.day<=5){
        varGroup.style.display="inline-flex";
        var k = WEEK_KEYS[schedule.week];
        slider.value = (variation[k]||0);
        out.textContent = ((variation[k]||0) >=0 ? "+" : "") + (variation[k]||0) + " Hz";
      } else {
        varGroup.style.display="none";
      }

      var quiet = (schedule.day===6);
      if(activeKey && quiet){
        var pb = document.getElementById('play-'+activeKey);
        if(pb) pb.disabled = true;
      }

      var journalCard = document.getElementById('journal');
      journalCard.querySelector('h3').textContent = "Week Journal ‚Äî " + (schedule.week===6 ? "Integration" : "Notes");
    }

    function onVarChange(val){
      var k = WEEK_KEYS[schedule.week];
      if(!k || schedule.week>5) return;
      variation[k] = Math.max(-50, Math.min(50, Number(val)||0));
      var out=document.getElementById('varOut'); if(out) out.textContent = (variation[k]>=0?"+":"") + variation[k] + " Hz";
      saveVar();
      smoothSetLoopFreqIfActive();
    }

    /* ===== Render map & hydrate inputs ===== */
    function hydrateInputs(){
      [["blue","word-blue"],["froot","word-froot"],["immortal","word-immortal"],["ancient","word-ancient"],["heaven","word-heaven"]]
      .forEach(function(p){ var el=document.getElementById(p[1]); if(el){ el.value = mapData[p[0]] || "" } })
    }
    function renderMap(){
      var host=document.getElementById("map"); if(!host) return; host.innerHTML="";
      var seeds = getSeeds();
      for(var k in seeds){
        var s=seeds[k], word=(mapData[k]||"").trim();
        var chip=document.createElement("div"); chip.className="chip";
        chip.style.setProperty("--c1", getComputedStyle(document.documentElement).getPropertyValue(s.c1.replace("var(","").replace(")","")).trim());
        chip.style.setProperty("--c2", getComputedStyle(document.documentElement).getPropertyValue(s.c2.replace("var(","").replace(")","")).trim());
        chip.textContent=s.name.split(" ‚Äî ")[0];
        if(word){ var cap=document.createElement("span"); cap.className="cap"; cap.textContent=word; chip.appendChild(cap) }
        host.appendChild(chip);
      }
    }

    /* ===== Seeds (modules) ===== */
    function getSeeds(){
      return {
        blue:{name:"Blue ‚Äî Ocean Neon", c1:"var(--blue-1)", c2:"var(--blue-2)", freq:329.63, id:"blue"},
        froot:{name:"Froot ‚Äî Electric Lime", c1:"var(--froot-1)", c2:"var(--froot-2)", freq:554.37, id:"froot"},
        immortal:{name:"Immortal ‚Äî Violet Dusk", c1:"var(--imm-1)", c2:"var(--imm-2)", freq:220.00, id:"immortal"},
        ancient:{name:"Ancient Dreams ‚Äî Rose Aurora", c1:"var(--ad-1)", c2:"var(--ad-2)", freq:349.23, id:"ancient"},
        heaven:{name:"Handmade Heaven ‚Äî Sky Bloom", c1:"var(--hh-1)", c2:"var(--hh-2)", freq:587.33, id:"heaven"}
      };
    }

    /* ===== Background audio + output strategy (iOS-safe) ===== */
    var ctx=null, master=null, comp=null, dc=null;
    var toneOsc=null, toneGain=null, pulseTimer=null, activeKeyPlaying=null;
    var honeyOsc=null, honeyGain=null;
    var retriggerGuard=false;

    // Pipe-only output for iOS lock screen (prevents chop)
    var bgDest=null, bgAudio=null, usePipeOutput=false;

    // Mute
    var isMuted = false, MASTER_GAIN_TARGET = 0.85, MUTE_KEY='froot_mute_v1';

    // Loop + LFO (breathing)
    var loopMode=false;
    var lfoOsc=null, lfoGain=null;
    var loopTimerMin=20, loopTimerId=null, loopStopDeadline=0, loopCountdownTick=0;

    function isIOS(){
      var ua = navigator.userAgent || '';
      return /iP(hone|ad|od)/.test(ua) || (navigator.platform && /iP(hone|ad|od)/.test(navigator.platform));
    }

    function ensureCtx(){
      if(!ctx){
        ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "interactive" });

        master = ctx.createGain(); master.gain.value = MASTER_GAIN_TARGET; // headroom
        comp = ctx.createDynamicsCompressor();
        comp.threshold.value = -18; comp.knee.value = 12; comp.ratio.value = 2;
        comp.attack.value    = 0.010; comp.release.value = 0.300;
        dc = ctx.createBiquadFilter(); dc.type = "highpass"; dc.frequency.value = 18;

        usePipeOutput = isIOS();
        if(usePipeOutput){
          bgDest = ctx.createMediaStreamDestination();
          bgAudio = document.getElementById('bgPipe');
          try{ bgAudio.setAttribute('playsinline',''); bgAudio.srcObject = bgDest.stream; bgAudio.loop = true; }catch(_){}
          master.connect(comp); comp.connect(dc); dc.connect(bgDest);
        } else {
          master.connect(comp); comp.connect(dc); dc.connect(ctx.destination);
        }

        try{ isMuted = JSON.parse(localStorage.getItem(MUTE_KEY)||'false'); }catch(_){}
        applyMuteImmediate(isMuted);
        refreshQuickbar();
      }
      return ctx;
    }
    function resumeCtx(){
      if(ctx && ctx.state==='suspended'){ ctx.resume() }
      if(usePipeOutput && bgAudio && bgAudio.paused){ bgAudio.play().catch(function(){}) }
    }

    function applyMuteImmediate(mute){
      if(!master || !ctx) return;
      var now = ctx.currentTime;
      try{
        master.gain.cancelScheduledValues(now);
        master.gain.setValueAtTime(master.gain.value, now);
        master.gain.linearRampToValueAtTime(mute? 0.0001 : MASTER_GAIN_TARGET, now + 0.06);
      }catch(_){}
      var b = document.getElementById('qb-mute');
      if(b){ b.classList.toggle('warn', mute); b.textContent = mute ? 'üîá' : 'üîä'; }
    }
    function toggleMute(){
      ensureCtx();
      isMuted = !isMuted;
      try{ localStorage.setItem(MUTE_KEY, JSON.stringify(isMuted)); }catch(_){}
      applyMuteImmediate(isMuted);
    }
    function refreshQuickbar(){
      var hb = document.getElementById('qb-honey'); if(hb){ hb.classList.toggle('on', document.body.classList.contains('honey')); }
      var lb = document.getElementById('qb-loop'); if(lb){ lb.classList.toggle('on', !!document.getElementById('loopToggle')?.checked); }
      var mb = document.getElementById('qb-mute'); if(mb){ mb.classList.toggle('warn', isMuted); mb.textContent = isMuted ? 'üîá' : 'üîä'; }
      var tb = document.getElementById('qb-trick'); if(tb && typeof tricksterOn!=='undefined'){ tb.classList.toggle('on', !!tricksterOn); }
      var md = document.getElementById('qb-mode'); if(md){ md.textContent = (mode==='goddess' ? 'üëë' : '‚öôÔ∏è'); md.title = 'Mode: '+(mode==='goddess'?'Goddess':'Pro')+' (tap to switch)'; }
    }
    function toggleHoneyFromQuick(){ toggleHoney(); refreshQuickbar(); }

    /* ===== iOS-tuned crackle-safe audio ===== */
    function killToneFast(now){
      if(!toneOsc || !toneGain){ return; }
      try{
        var end = now + 0.10;
        toneGain.gain.cancelScheduledValues(now);
        toneGain.gain.setValueAtTime(toneGain.gain.value, now);
        toneGain.gain.linearRampToValueAtTime(0.0005, end);
        toneOsc.stop(end);
      }catch(_){}
      setTimeout(function(){
        try{ toneOsc.disconnect(); }catch(_){}
        try{ toneGain.disconnect(); }catch(_){}
        toneOsc=null; toneGain=null;
      }, 140);
    }

    function effectiveFreq(base, key){
      if(schedule.week<=5 && schedule.day>=2 && schedule.day<=5){
        var delta = variation[key] || 0;
        var f = base + delta;
        if(f < 20) f = 20; if(f > 18000) f = 18000;
        return f;
      }
      return base;
    }

    /* ===== Loop toggle + persistence ===== */
    function setLoop(on){
      ensureCtx();
      loopMode = !!on;
      try{ localStorage.setItem("froot_loop_v1", JSON.stringify({on:loopMode})) }catch(e){}
      if(loopMode && activeKeyPlaying){ stopTone(); setTimeout(function(){ playTone(activeKeyPlaying); }, 120); }
      resetLoopCountdown();
      refreshQuickbar();
    }

    /* ===== Breath Phase HUD ===== */
    var breathUI=(function(){
      var host=null,hud=null,arc=null,edge=null,label=null,raf=0,t0=0,dur=1000;
      function currentHost(){ var wkKey=WEEK_KEYS[schedule.week]; var id="swatch-"+(wkKey==="immortal"?"immortal":wkKey); return document.getElementById(id); }
      function attach(){
        var h=currentHost(); if(!h) return;
        if(host!==h){ host=h; }
        if(host.querySelector('.fbrHUD')){
          hud=host.querySelector('.fbrHUD'); arc=hud.querySelector('.fbrArc'); edge=hud.querySelector('.fbrEdge'); label=hud.querySelector('.fbrLabel'); return;
        }
        host.insertAdjacentHTML('beforeend','<div class="fbrHUD"><div class="fbrArc" style="--fbr-arc:0deg"></div><div class="fbrEdge"></div><div class="fbrLabel">READY</div></div>');
        hud=host.querySelector('.fbrHUD'); arc=hud.querySelector('.fbrArc'); edge=hud.querySelector('.fbrEdge'); label=hud.querySelector('.fbrLabel');
      }
      function progress(now){ var p=Math.min(1,(now-t0)/dur); arc.style.setProperty('--fbr-arc',(p*360)+'deg'); if(p<1){ raf=requestAnimationFrame(progress); } }
      function flash(){ edge.classList.remove('flash'); void edge.offsetWidth; edge.classList.add('flash'); }
      function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms||12); }catch(_){ } }
      function setPhase(name, ms){
        if(!hud){ attach(); } if(!hud) return;
        host.classList.remove('fbr-in','fbr-hold','fbr-out');
        host.classList.add(name==='hold'?'fbr-hold':(name==='out'?'fbr-out':'fbr-in'));
        label.textContent=(name==='hold'?'HOLD':(name==='out'?'OUT':'IN'));
        cancelAnimationFrame(raf); t0=performance.now(); dur=Math.max(200,(ms|0)||1000);
        arc.style.setProperty('--fbr-arc','0deg'); raf=requestAnimationFrame(progress);
        flash(); vibrate(10);
      }
      function ready(){ if(!hud){ attach(); } if(!hud) return; label.textContent='READY'; arc.style.setProperty('--fbr-arc','0deg'); host && host.classList.remove('fbr-in','fbr-hold','fbr-out'); }
      return {setPhase,ready,attach};
    })();
    function setBreathPhaseUI(phaseName, durationMs){ breathUI.setPhase(phaseName, durationMs); }

    /* ===== Guided-breath driver (4‚Äì7‚Äì8 default) ===== */
    var breathDriver=(function(){
      var cfg={in:4000, hold:7000, out:8000}, tid=null, running=false, seq=['in','hold','out'], idx=0;
      function step(){ var name=seq[idx]; var ms=cfg[name]||1000; setBreathPhaseUI(name,ms); syncLFOToPhase(name,ms); tid=setTimeout(function(){ idx=(idx+1)%seq.length; step(); },ms); }
      function start(){ if(running) return; running=true; idx=0; breathUI.attach(); step(); }
      function stop(){ running=false; clearTimeout(tid); tid=null; try{ breathUI.ready(); }catch(_){ } }
      function setPattern(msIn, msHold, msOut){ cfg.in=msIn|0; cfg.hold=msHold|0; cfg.out=msOut|0; if(running){ stop(); start(); } }
      return { start, stop, setPattern };
    })();
    function setPatternPreset(pin,phold,pout){ breathDriver.setPattern(pin*1000, phold*1000, pout*1000); }

    /* ===== LFO sync to breath phases ===== */
    function syncLFOToPhase(name, ms){
      if(!ctx || !toneGain || !lfoOsc || !lfoGain) return;
      var now=ctx.currentTime;
      var depth=(name==='in')?0.055:(name==='hold'?0.00:0.025);
      var base =(name==='in')?0.20 :(name==='hold'?0.18:0.16);
      var rate =(name==='in')?0.14 :(name==='hold'?0.06:0.10);
      try{
        lfoGain.gain.cancelScheduledValues(now); lfoGain.gain.setValueAtTime(lfoGain.gain.value, now); lfoGain.gain.linearRampToValueAtTime(depth, now+0.25);
        lfoOsc.frequency.cancelScheduledValues(now); lfoOsc.frequency.setValueAtTime(lfoOsc.frequency.value, now); lfoOsc.frequency.linearRampToValueAtTime(rate, now+0.25);
        toneGain.gain.cancelScheduledValues(now); toneGain.gain.setValueAtTime(toneGain.gain.value, now); toneGain.gain.linearRampToValueAtTime(base, now+0.30);
      }catch(_){}
    }

    function smoothSetLoopFreqIfActive(){
      if(!ctx || !toneOsc || !activeKeyPlaying || !loopMode) return;
      var seeds = getSeeds(); var s = seeds[activeKeyPlaying]; if(!s) return;
      var target = effectiveFreq(s.freq, activeKeyPlaying);
      var now = ctx.currentTime;
      try{
        var cur = toneOsc.frequency.value || target;
        toneOsc.frequency.cancelScheduledValues(now);
        toneOsc.frequency.setValueAtTime(cur, now);
        toneOsc.frequency.linearRampToValueAtTime(Math.max(1, target), now + 0.12);
      }catch(_){ try{ toneOsc.frequency.value = target; }catch(__){} }
    }

    function playTone(key){
      ensureCtx();

      // Quiet Walk day disables tone for the active week
      var wkKey = WEEK_KEYS[schedule.week];
      if(schedule.day===6 && key===wkKey) return;

      var seeds = getSeeds();
      var s = seeds[key]; if(!s) return;
      var now = ctx.currentTime;

      if(toneOsc){ killToneFast(now); }
      if(retriggerGuard) return; retriggerGuard = true; setTimeout(function(){ retriggerGuard=false; }, 250);

      toneOsc  = ctx.createOscillator();
      toneGain = ctx.createGain();

      var freq = effectiveFreq(s.freq, key);
      toneOsc.type = "sine";
      toneOsc.frequency.setValueAtTime(freq, now);

      if(!loopMode){
        const atk=0.030, hold=0.25, rel=0.150, peak=0.22, sus=0.16, tail=5.4;
        toneGain.gain.cancelScheduledValues(now); toneGain.gain.setValueAtTime(0.0, now);
        toneGain.gain.linearRampToValueAtTime(peak, now + atk);
        toneGain.gain.linearRampToValueAtTime(sus,  now + atk + hold);
        toneGain.gain.setValueAtTime(sus, now + tail);
        toneGain.gain.linearRampToValueAtTime(0.0005, now + tail + rel);

        toneOsc.connect(toneGain); toneGain.connect(master);
        toneOsc.start(now); toneOsc.stop(now + tail + rel + 0.02);

        activeKeyPlaying = key; pulseOn(key);
        toneOsc.onended = function(){ pulseOff(key); activeKeyPlaying=null; };

        resumeCtx();
        if('mediaSession' in navigator){
          try{
            navigator.mediaSession.metadata = new MediaMetadata({ title:'Froot tone', artist:'PLNT Earth', album:'Illumina' });
            navigator.mediaSession.playbackState='playing';
          }catch(_){}
        }
      } else {
        toneGain.gain.cancelScheduledValues(now);
        toneGain.gain.setValueAtTime(0.0, now);
        toneGain.gain.linearRampToValueAtTime(0.18, now + 0.18);

        lfoOsc = ctx.createOscillator();
        lfoGain = ctx.createGain();
        lfoOsc.type = "sine";
        lfoOsc.frequency.setValueAtTime(0.12, now);
        lfoGain.gain.setValueAtTime(0.03, now);
        lfoOsc.connect(lfoGain); lfoGain.connect(toneGain.gain);

        toneOsc.connect(toneGain); toneGain.connect(master);
        toneOsc.start(now); lfoOsc.start(now);

        activeKeyPlaying = key; pulseOn(key);
        toneOsc.onended = function(){ pulseOff(key); activeKeyPlaying=null; };

        try{ breathDriver.start(); }catch(_){}
        resetLoopCountdown();

        resumeCtx();
        if('mediaSession' in navigator){
          try{
            navigator.mediaSession.metadata = new MediaMetadata({ title:'Froot tone (loop)', artist:'PLNT Earth', album:'Illumina' });
            navigator.mediaSession.playbackState='playing';
            navigator.mediaSession.setActionHandler('play', ()=>{ if(!activeKeyPlaying && wkKey){ playTone(wkKey); } });
            navigator.mediaSession.setActionHandler('pause', ()=>{ stopTone(); });
            navigator.mediaSession.setActionHandler('stop',  ()=>{ stopTone(); });
          }catch(_){}
        }
      }
    }

    function stopTone(){
      if(!ctx){ return; }
      var now = ctx.currentTime;
      killToneFast(now);

      if(lfoOsc || lfoGain){
        try{
          lfoGain.gain.cancelScheduledValues(now);
          lfoGain.gain.setValueAtTime(lfoGain.gain.value, now);
          lfoGain.gain.linearRampToValueAtTime(0.0, now + 0.12);
          lfoOsc.stop(now + 0.14);
        }catch(_){}
        setTimeout(function(){
          try{ lfoOsc.disconnect(); }catch(_){}
          try{ lfoGain.disconnect(); }catch(_){}
          lfoOsc = null; lfoGain = null;
        }, 180);
      }

      try{ breathDriver.stop(); }catch(_){}
      if(loopTimerId){ clearTimeout(loopTimerId); loopTimerId=null; }
      if(loopCountdownTick){ clearInterval(loopCountdownTick); loopCountdownTick=0; }
      var _cd = document.getElementById('loopCountdown'); if(_cd){ _cd.textContent=''; }

      if(activeKeyPlaying){ pulseOff(activeKeyPlaying); activeKeyPlaying=null; }
      if('mediaSession' in navigator){ try{ navigator.mediaSession.playbackState='paused'; }catch(_){ } }
    }

    /* Pulse visuals */
    function pulseOn(key){
      var id="swatch-"+(key==="immortal"?"immortal":key); var el=document.getElementById(id); if(!el) return;
      el.classList.add("pulse"); clearInterval(pulseTimer);
      var t0=performance.now();
      pulseTimer=setInterval(function(){
        if(document.body.classList.contains('saver')) return;
        var t=(performance.now()-t0)/1000.0; var deg=120+Math.sin(t*2.0)*10;
        el.style.background="linear-gradient("+deg+"deg, var(--c1), var(--c2))";
      },60);
    }
    function pulseOff(key){
      var el = key ? document.getElementById("swatch-"+(key==="immortal"?"immortal":key)) : null;
      if(el){ el.classList.remove("pulse"); el.style.background="" }
      clearInterval(pulseTimer); pulseTimer=null;
    }

    /* Muse / Honey / FX toggles */
    function toggleMuse(){ document.body.classList.toggle("muse"); savePrefs() }
    function toggleHoney(){
      var on=document.body.classList.toggle("honey");
      document.getElementById("honey-controls").style.display = on ? "block" : "none";
      if(on){ honeyStart() } else { honeyStop() }
      savePrefs(); refreshQuickbar();
    }
    function toggleButterfly(){
      var on=document.body.classList.toggle("fx-on");
      if(on){ startButterflies() } else { stopButterflies() }
      savePrefs();
    }
    function togglePrincess(){
      var on=!document.body.classList.contains("princess-on");
      document.body.classList.toggle("princess-on", on);
      document.getElementById("princessBanner").style.display = on ? "grid" : "none";
      savePrefs();
    }
    function toggleSaver(){
      document.body.classList.toggle("saver");
      if(document.body.classList.contains('saver')) stopButterflies(); else if(document.body.classList.contains('fx-on')) startButterflies();
      savePrefs();
    }

    /* Honey (128 Hz) */
    function honeyStart(){
      ensureCtx();
      if(honeyOsc){ return }
      honeyOsc  = ctx.createOscillator();
      honeyGain = ctx.createGain();
      honeyOsc.type = "sine";
      honeyOsc.frequency.setValueAtTime(128.0, ctx.currentTime);

      var now = ctx.currentTime;
      honeyGain.gain.setValueAtTime(0.0, now);
      honeyGain.gain.linearRampToValueAtTime(0.12, now + 0.25);

      honeyOsc.connect(honeyGain); honeyGain.connect(master);
      honeyOsc.start(now);

      var vol=document.getElementById("honeyVol"); if(vol){ honeyVolume(vol.value) }
      resumeCtx();
      if('mediaSession' in navigator){ try{ navigator.mediaSession.playbackState='playing'; }catch(_){} }
    }
    function honeyStop(){
      if(!honeyOsc || !honeyGain || !ctx){ return }
      var now=ctx.currentTime;
      try{
        honeyGain.gain.cancelScheduledValues(now);
        honeyGain.gain.setValueAtTime(honeyGain.gain.value, now);
        honeyGain.gain.linearRampToValueAtTime(0.0005, now + 0.25);
        setTimeout(function(){
          try{ honeyOsc.stop() }catch(_){}
          try{ honeyOsc.disconnect(); honeyGain.disconnect() }catch(_){}
          honeyOsc=null; honeyGain=null;
        }, 320);
      }catch(_){
        try{ honeyOsc.stop() }catch(__){}
        honeyOsc=null; honeyGain=null;
      }
      if('mediaSession' in navigator){ try{ navigator.mediaSession.playbackState='paused'; }catch(_){ } }
    }
    function honeyVolume(val){
      if(!honeyGain || !ctx){ return }
      var v = Math.max(0, Math.min(100, Number(val)||0));
      var g = v/100 * 0.30;
      honeyGain.gain.linearRampToValueAtTime(g, ctx.currentTime + 0.05);
    }

    /* Journal persistence */
    var jn=document.getElementById('j_note'), jp=document.getElementById('j_poem');
    if(jn){ jn.addEventListener('input', function(){ var w=schedule.week; journal[w]=journal[w]||{}; journal[w].note=this.value; saveJournal(); }) }
    if(jp){ jp.addEventListener('input', function(){ var w=schedule.week; journal[w]=journal[w]||{}; journal[w].poem=this.value; saveJournal(); }) }

    /* Export + Share (auto-Princess on Week 6) */
    function buildMapBlob(){
      var payload={version:"2.3",
        schedule:schedule,
        variation:variation,
        map:mapData,
        journal:journal[schedule.week]||{},
        prefs:{
          muse:document.body.classList.contains('muse'),
          honey:document.body.classList.contains('honey'),
          butterfly:document.body.classList.contains('fx-on'),
          princess:document.body.classList.contains('princess-on'),
          saver:document.body.classList.contains('saver')
        },
        timestamp:new Date().toISOString()
      };
      return new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    }
    function exportMap(){
      if(schedule.week===6){ document.body.classList.add("princess-on"); var pb=document.getElementById("princessBanner"); if(pb){ pb.style.display="grid"; } }
      var blob=buildMapBlob();
      var url=URL.createObjectURL(blob);
      var a=document.createElement("a"); a.href=url; a.download="froot_marina_synesthesia_map.json";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    async function shareMap(){
      if(schedule.week===6){ document.body.classList.add("princess-on"); var pb=document.getElementById("princessBanner"); if(pb){ pb.style.display="grid"; } }
      var blob=buildMapBlob(); var fileName="froot_marina_synesthesia_map.json";
      var canFiles = !!(navigator.canShare && navigator.canShare({files:[new File([blob], fileName, {type:blob.type})]}));
      if(navigator.share && canFiles){
        var f=new File([blob], fileName, {type:blob.type});
        await navigator.share({files:[f], title:"Froot Synesthesia Map", text:"My Froot color-sense map"}); return;
      }
      if(navigator.share){
        var url=URL.createObjectURL(blob);
        await navigator.share({title:"Froot Synesthesia Map", text:"My Froot color-sense map", url}); URL.revokeObjectURL(url); return;
      }
      exportMap();
    }

    /* Bluetooth (BLE) send ‚Äî Nordic UART Service */
    var BLE={device:null, server:null, svc:null, tx:null};
    async function bleSend(){
      try{
        var svcUUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        var txUUID ="6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        BLE.device = await navigator.bluetooth.requestDevice({filters:[{services:[svcUUID]}]});
        BLE.server = await BLE.device.gatt.connect();
        BLE.svc    = await BLE.server.getPrimaryService(svcUUID);
        BLE.tx     = await BLE.svc.getCharacteristic(txUUID);
        var blob=buildMapBlob(); var text=await blob.text(); var data=new TextEncoder().encode(text);
        var mtu=180; for(var i=0;i<data.length;i+=mtu){ await BLE.tx.writeValueWithoutResponse(data.slice(i, Math.min(i+mtu, data.length))); }
        if(BLE.device && BLE.device.gatt.connected){ BLE.device.gatt.disconnect() }
      }catch(e){ /* silent */ }
    }

    /* Butterfly FX (canvas particles) */
    var fxCanvas = document.getElementById('fx-butterflies');
    var fxCtx = fxCanvas.getContext('2d');
    var fxRAF = null, fxParts = [];
    function resizeFX(){ fxCanvas.width = innerWidth * devicePixelRatio; fxCanvas.height = innerHeight * devicePixelRatio; fxCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
    function spawnButterfly(){ return { x: Math.random()*innerWidth, y: innerHeight + Math.random()*80, vx: (Math.random()*0.6-0.3), vy: - (0.6 + Math.random()*1.2), size: 6 + Math.random()*10, hue: Math.random()*360, life: 0, max: 6 + Math.random()*8 }; }
    function drawButterfly(p,t){
      var s = p.size * (0.9 + 0.1*Math.sin(t*2 + p.hue));
      fxCtx.save(); fxCtx.translate(p.x, p.y); fxCtx.rotate(Math.sin(t*1.5 + p.hue)*0.3);
      var g = fxCtx.createLinearGradient(-s,0,s,0); g.addColorStop(0, "hsla("+(p.hue)+",80%,70%,.85)"); g.addColorStop(1, "hsla("+(p.hue+60)+",80%,60%,.85)");
      fxCtx.fillStyle = g;
      fxCtx.beginPath(); fxCtx.moveTo(0,0); fxCtx.bezierCurveTo(-s,-s, -s*1.6, s*0.2, -s*0.4, s*0.6); fxCtx.bezierCurveTo(-s*0.8, s*0.1, -s, -s*0.6, 0,0); fxCtx.closePath(); fxCtx.fill();
      fxCtx.scale(-1,1);
      fxCtx.beginPath(); fxCtx.moveTo(0,0); fxCtx.bezierCurveTo(-s,-s, -s*1.6, s*0.2, -s*0.4, s*0.6); fxCtx.bezierCurveTo(-s*0.8, s*0.1, -s, -s*0.6, 0,0); fxCtx.closePath(); fxCtx.fill();
      fxCtx.restore();
    }
    function fxStep(){
      if(document.body.classList.contains('saver')) return;
      var now = performance.now()/1000;
      fxCtx.clearRect(0,0,innerWidth,innerHeight);
      if(fxParts.length < 24) fxParts.push(spawnButterfly());
      for(var i=fxParts.length-1;i>=0;i--){
        var p = fxParts[i];
        p.life += 0.016; p.x += p.vx + Math.sin(now*2 + p.hue)*0.2; p.y += p.vy;
        drawButterfly(p, now);
        if(p.life > p.max || p.y < -60) fxParts.splice(i,1);
      }
      fxRAF = requestAnimationFrame(fxStep);
    }
    function startButterflies(){ if(document.body.classList.contains('saver')) return; resizeFX(); fxParts = []; if(!fxRAF) fxRAF = requestAnimationFrame(fxStep); window.addEventListener('resize', resizeFX); }
    function stopButterflies(){ cancelAnimationFrame(fxRAF); fxRAF=null; fxCtx.clearRect(0,0,innerWidth,innerHeight); window.removeEventListener('resize', resizeFX); }

    /* Build Week/Day UI & apply state */
    function initWeekDayUI(){ applyScheduleUI(); hydrateInputs(); renderMap(); hydrateJournal(); }

    /* ===== Loop Auto‚Äëstop Timer ===== */
    function setLoopTimer(minStr){
      loopTimerMin = parseInt(minStr,10) || 0; try{ localStorage.setItem('froot_loop_timer_v1', String(loopTimerMin)); }catch(_){}
      resetLoopCountdown();
    }
    function resetLoopCountdown(){
      if(loopTimerId){ clearTimeout(loopTimerId); loopTimerId=null; }
      if(loopCountdownTick){ clearInterval(loopCountdownTick); loopCountdownTick=0; }
      var cd = document.getElementById('loopCountdown'); if(cd) cd.textContent='';
      if(loopMode && activeKeyPlaying && loopTimerMin>0){
        var ms = loopTimerMin*60000;
        loopStopDeadline = Date.now()+ms;
        loopTimerId = setTimeout(function(){ stopTone(); }, ms);
        loopCountdownTick = setInterval(function(){
          var left = Math.max(0, loopStopDeadline - Date.now());
          var m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
          if(cd){ cd.textContent = (m>0? (m+'m ') : '') + (s+'s left'); }
          if(left<=0){ clearInterval(loopCountdownTick); loopCountdownTick=0; if(cd){ cd.textContent=''; } }
        }, 1000);
      } else { loopStopDeadline = 0; }
    }

    /* ===== Trickster (gentle frequency wander) ===== */
    var TRICK_KEY='froot_trickster_v1'; var tricksterOn=false, trickId=null;
    try{ tricksterOn = JSON.parse(localStorage.getItem(TRICK_KEY)||'false'); }catch(_){}
    function toggleTrickster(){
      ensureCtx();
      tricksterOn = !tricksterOn;
      try{ localStorage.setItem(TRICK_KEY, JSON.stringify(tricksterOn)); }catch(_){}
      if(tricksterOn){ startTrickster(); beeWhisper("We‚Äôll wander a little, safely.", 2800); }
      else { stopTrickster(); beeWhisper("Back to steady.", 2200); }
      refreshQuickbar();
    }
    function startTrickster(){
      if(trickId) return;
      trickId = setInterval(function(){
        if(!ctx || !toneOsc || !activeKeyPlaying || !loopMode) return;
        var seeds = getSeeds(); var s = seeds[activeKeyPlaying]; if(!s) return;
        var cur = Number(variation[activeKeyPlaying]||0);
        var step = (Math.random()*2-1) * 1.2;
        var aim  = Math.max(-6, Math.min(6, cur + step));
        variation[activeKeyPlaying] = aim; saveVar();
        try{
          var slider=document.getElementById('varSlider'); var out=document.getElementById('varOut');
          if(slider && document.getElementById('varGroup')?.style.display!=="none"){ slider.value=aim; if(out) out.textContent=(aim>=0?"+":"")+aim.toFixed(1)+" Hz"; }
        }catch(_){}
        smoothSetLoopFreqIfActive();
      }, 1800);
    }
    function stopTrickster(){ if(trickId){ clearInterval(trickId); trickId=null; } }

    /* ===== Pro/Goddess Mode ===== */
    var MODE_KEY='froot_mode_v1';
    function loadMode(){ try{ return localStorage.getItem(MODE_KEY)||'pro'; }catch(_){ return 'pro'; } }
    function saveMode(m){ try{ localStorage.setItem(MODE_KEY, m); }catch(_){ } }
    var mode = loadMode();

    function ensureState(flag, on){
      var has = document.body.classList.contains(flag);
      if(on && !has){
        if(flag==='honey') toggleHoney();
        else if(flag==='fx-on') toggleButterfly();
        else if(flag==='princess-on') togglePrincess();
        else if(flag==='muse') toggleMuse();
      } else if(!on && has){
        if(flag==='honey') toggleHoney();
        else if(flag==='fx-on') toggleButterfly();
        else if(flag==='princess-on') togglePrincess();
        else if(flag==='muse') toggleMuse();
      }
    }

    function applyMode(m){
      mode = (m==='goddess') ? 'goddess' : 'pro';
      document.body.classList.remove('mode-pro','mode-goddess');
      document.body.classList.add(mode==='goddess' ? 'mode-goddess' : 'mode-pro');

      if(mode==='pro'){
        ensureState('muse', true);
        ensureState('honey', false);
        ensureState('fx-on', false);
        ensureState('princess-on', false);
        if(loopMode) setLoop(false);
        if(typeof tricksterOn!=='undefined' && tricksterOn){ toggleTrickster(); }
        beeWhisper("Pro: steady, light, and fast.", 2600);
      }else{
        ensureState('muse', true);
        ensureState('honey', true);
        ensureState('fx-on', true);
        if(schedule.week===6) ensureState('princess-on', true);
        try{ var hv=document.getElementById('honeyVol'); if(hv){ hv.value='22'; honeyVolume(22);} }catch(_){}
        beeWhisper("Goddess: ceremony engaged. I‚Äôm with you.", 2800);
      }
      saveMode(mode);
      refreshQuickbar();
    }

    /* ===== First Light Guide ===== */
    var FL_KEY='froot_firstlight_seen_v1';
    function flSeen(){ try{ return localStorage.getItem(FL_KEY)==='1'; }catch(_){ return false; } }
    function setFlSeen(on){ try{ localStorage.setItem(FL_KEY, on?'1':'0'); }catch(_){ } }

    function openFirstLight(){ var el=document.getElementById('firstLight'); if(!el) return; el.classList.add('on'); flGo(1); }
    function closeFirstLight(){
      var el=document.getElementById('firstLight'); if(!el) return;
      el.classList.remove('on');
      var remember = document.querySelector('#firstLight input[type=checkbox]:checked');
      if(remember){ setFlSeen(true); }
    }
    function flGo(n){
      ['flStep1','flStep2','flStep3'].forEach(function(id,i){
        var el=document.getElementById(id); if(el){ el.classList.toggle('on', (i===n-1)); }
      });
    }
    function flBegin(){
      var r1=document.getElementById('flRemember1'), r2=document.getElementById('flRemember2'), r3=document.getElementById('flRemember3');
      if((r1&&r1.checked)||(r2&&r2.checked)||(r3&&r3.checked)) setFlSeen(true);
      closeFirstLight();

      schedule.week=1; schedule.day=1; saveSched(); applyScheduleUI();
      try{
        var sw=document.getElementById('swatch-blue');
        if(sw){ sw.scrollIntoView({behavior:'smooth', block:'center'}); sw.classList.add('focus-pulse'); setTimeout(function(){ sw.classList.remove('focus-pulse'); }, 1800); }
      }catch(_){}
      beeWhisper("Start with Blue ‚Äî one word is enough.", 3600);
    }

    // Boot onboarding on first visit or with ?help=1
    (function firstLightBoot(){
      var params=new URLSearchParams(location.search);
      if(params.get('help')==='1'){ openFirstLight(); return; }
      if(!flSeen()){ setTimeout(function(){ openFirstLight(); }, 600); }
    })();

    /* ===== Init ===== */
    if(prefs.honey){ document.getElementById("honey-controls").style.display="block"; }
    if(prefs.princess){ document.getElementById("princessBanner").style.display="grid"; }
    if(prefs.butterfly && !document.body.classList.contains('saver')) startButterflies();

    document.addEventListener("click", function(){ ensureCtx(); resumeCtx(); if(usePipeOutput && bgAudio){ bgAudio.play().catch(function(){}); } }, {once:true});
    document.addEventListener("visibilitychange", function(){ if(document.visibilityState==="visible"){ resumeCtx(); } else { if(usePipeOutput && bgAudio){ bgAudio.play().catch(function(){}); } } });

    initWeekDayUI();

    (function(){
      var box = document.getElementById('loopToggle');
      var sel = document.getElementById('loopTimer');
      if(box){ box.addEventListener('change', function(){ setLoop(this.checked); }); }
      if(sel){ sel.addEventListener('change', function(){ setLoopTimer(this.value); }); }
      try{ var lp = JSON.parse(localStorage.getItem("froot_loop_v1")||"{}"); if(lp.on){ if(box) box.checked = true; loopMode = true; } }catch(_){}
      try{ var tmin = parseInt(localStorage.getItem('froot_loop_timer_v1')||'20',10); if(!isNaN(tmin)){ loopTimerMin=tmin; if(sel){ sel.value = String(tmin); } } }catch(_){}
      setPatternPreset(4,7,8);
      try{ isMuted = JSON.parse(localStorage.getItem(MUTE_KEY)||'false'); }catch(_){}
      applyMode(mode);
      refreshQuickbar();
      if(tricksterOn){ startTrickster(); refreshQuickbar(); }
    })();
  </script>
</body>
</html>
