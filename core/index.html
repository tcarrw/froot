<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Froot · Core v1.9 — editor + notes/info + export/import</title>
<meta name="theme-color" content="#0b0d11">
<style>
  :root{--bg:#0b0d11;--ink:#e8f0ff;--sub:#a9b4c7;--accent:#73ffd9;--line:#1a2030;--card:#121725;--card2:#0f1420}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(180deg,var(--bg),#0a0e1a 40%,#070a14);color:var(--ink);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  header{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0d1220,var(--card2))}
  h1{margin:0;font-size:18px;letter-spacing:.3px}.sub{color:var(--sub);font-size:13px}
  main{max-width:1000px;margin:22px auto;padding:0 16px 24px}
  .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:18px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg,var(--card),#0c1220);border:1px solid var(--line);border-radius:14px;padding:14px}
  .playerbox{aspect-ratio:16/9;border-radius:10px;overflow:hidden;background:#000}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button,.toggle,.chip{border:1px solid var(--line);background:#0f1524;color:#e8f0ff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px}
  button.primary{background:var(--accent);color:#071015;border-color:transparent}
  button:disabled{opacity:.55;cursor:not-allowed}
  .toggle.on{background:#13233a;border-color:#24446e}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0e1422}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .list{margin:10px 0 0;padding:0;list-style:none;max-height:420px;overflow:auto;border-top:1px dashed var(--line)}
  .li{display:grid;grid-template-columns:auto 1fr auto;gap:8px;padding:10px 8px;border-bottom:1px dashed var(--line);align-items:center}
  .badge{font-size:11px;color:#a9b4c7;border:1px solid var(--line);padding:2px 6px;border-radius:999px}
  .titleBtn{border:1px solid var(--line);background:#0f1524;padding:8px 10px;border-radius:10px;text-align:left}
  .now{color:var(--accent);font-weight:700}
  .meta{grid-column:2 / span 2;color:#a9b4c7;font-size:12px;margin:6px 0 0}
  .meta .note{display:block;margin-top:2px;color:#e3e9fb}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"], textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1120;color:#e8f0ff;font-size:14px}
  textarea{min-height:84px;resize:vertical}
  .hint{color:#a9b4c7;font-size:12px;margin-top:6px}
  .qs{font-size:12px;color:#a9b4c7}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .footer{margin-top:14px;color:#a9b4c7;font-size:12px}
  .k{color:#93a4c7}
  details.info{grid-column:2 / span 2;margin-top:6px}
  details.info summary{cursor:pointer;list-style:none}
  details.info summary::-webkit-details-marker{display:none}
  details.info summary{display:inline-flex;align-items:center;gap:8px;border:1px dashed var(--line);padding:6px 10px;border-radius:10px;color:#a9b4c7}
  details.info .ibox{margin-top:8px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0d1526;color:#dfe6ff}

  /* Popover editor */
  .popover{position:fixed;left:0;top:0;min-width:300px;max-width:92vw;z-index:999;border:1px solid var(--line);background:#0e1422;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:12px;display:none}
  .popover.active{display:block}
  .popover .hdr{font-size:12px;color:#a9b4c7;margin-bottom:8px}
  .popover .row{margin-top:6px}
  .pop-actions{display:flex;gap:8px;margin-top:8px}
  .closeMask{position:fixed;inset:0;background:transparent;display:none;z-index:998}
  .closeMask.active{display:block}

  /* Import/Export area */
  details.io{margin-top:12px}
  details.io summary{cursor:pointer;list-style:none;color:#a9b4c7}
  details.io summary::-webkit-details-marker{display:none}
  .ioBox{margin-top:8px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0d1526}
  .ioRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .small{font-size:12px;color:#a9b4c7}
</style>
</head>
<body>
<header>
  <h1>Froot · Core <span class="sub">v1.9 — editor + notes/info + export/import · auto-advance + 128.15 Hz</span></h1>
</header>

<main class="grid">
  <!-- LEFT: Player -->
  <section class="panel">
    <div class="playerbox" id="playerBox"><div id="player"></div></div>
    <div class="controls" aria-label="Player controls">
      <button id="btnPlay" class="primary">Play</button>
      <button id="btnPause">Pause</button>
      <button id="btnPrev">Prev</button>
      <button id="btnNext">Next</button>
      <button id="btnLoop" class="toggle">Loop: Off</button>
      <span class="pill"><span class="k">Track</span>&nbsp;<strong id="sIndex">–</strong>&nbsp;·&nbsp;<span class="k">State</span>&nbsp;<strong id="sState">idle</strong></span>
    </div>
    <div class="controls" style="margin-top:8px" aria-label="Tone controls">
      <button id="btnTone" class="toggle">128.15 Hz Tone: Off</button>
      <label class="pill">Gain <input id="gain" type="range" min="0" max="1" step="0.01" value="0.22" style="vertical-align:middle"></label>
      <label class="pill"><input id="autoImport" type="checkbox" style="vertical-align:middle">&nbsp;Auto-import title on add</label>
    </div>
    <div class="footer">Tap <b>Play</b> once on iPhone to unlock audio. Queue auto-advances; toggle <b>Loop</b>. Titles/notes persist locally.</div>
  </section>

  <!-- RIGHT: Queue + Controls -->
  <aside class="panel">
    <div class="row" style="justify-content:space-between;align-items:baseline">
      <strong>Queue</strong>
      <span class="qs"><span class="k">Origin</span> froot.plnt.earth · <span class="k">Persists</span> local</span>
    </div>
    <ul class="list" id="queueList" aria-live="polite"></ul>

    <div class="sep"></div>
    <div class="row">
      <input id="newId" type="text" placeholder="Paste a YouTube ID or URL">
      <button id="btnAdd">Add</button>
      <button id="btnToday" class="toggle">Reload Today’s Set</button>
      <button id="btnClear">Clear</button>
    </div>
    <div class="hint">Per-item flow: <b>Edit → Import → Play → Remove</b>. Notes show inline; extra details under <b>Info</b>.</div>

    <!-- Import / Export -->
    <details class="io">
      <summary>Import / Export</summary>
      <div class="ioBox">
        <div class="ioRow">
          <button id="btnExportJSON">Export JSON</button>
          <button id="btnCopyJSON">Copy JSON</button>
          <button id="btnExportCSV">Export CSV</button>
          <span class="small">JSON is best for other PLNT sites.</span>
        </div>
        <div class="ioRow">
          <button id="btnExportSnippet" class="primary">Export Site Snippet</button>
          <button id="btnCopySnippet">Copy Site Snippet</button>
          <span class="small">Paste snippet anywhere in a page; it exposes <code>window.FROOT_DATA</code>.</span>
        </div>
        <div class="ioRow">
          <input id="fileJSON" type="file" accept="application/json">
          <span class="small">…or paste JSON below and click <b>Load JSON</b>.</span>
        </div>
        <div class="ioRow" style="width:100%">
          <textarea id="pasteJSON" placeholder='[{"id":"GiOGlYjKgX8","title":"Handmade Heaven","note":"…"}]'></textarea>
        </div>
        <div class="ioRow">
          <button id="btnLoadJSON">Load JSON</button>
          <span id="ioStatus" class="small"></span>
        </div>
      </div>
    </details>
  </aside>
</main>

<!-- Hidden meta player -->
<div style="position:absolute;left:-99999px;top:-99999px;width:1px;height:1px;overflow:hidden">
  <div id="metaPlayer"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
(function(){
  var KEY="froot_core_v1_9";
  function loadState(){ try{return JSON.parse(localStorage.getItem(KEY))||{}}catch(e){return{}} }
  function saveState(){
    localStorage.setItem(KEY, JSON.stringify({
      queue: state.queue, index: state.index, loop: state.loop, toneOn: state.toneOn,
      gain: gainNode ? gainNode.gain.value : 0.22, autoImport: !!autoImport.checked
    }));
  }

  /* Seed set (objects: {id,title?,note?,info?}) */
  var todaysSet = [
    {id:"GiOGlYjKgX8"}, // MARINA — Handmade Heaven
    {id:"1YUBbF24H44"}, // Sabrina — because i liked a boy
    {id:"mkR_Qwix4Ho"}, // Taylor — Lavender Haze
    {id:"Hy9W_mrY_Vk"}, // Solange — Losing You
    {id:"K9_VFxzCuQ0"}, // Sigrid — Strangers
    {id:"k2qgadSvNyU"}, // Dua Lipa — New Rules
    {id:"QtXby3twMmI"}  // Coldplay — Adventure of a Lifetime
  ];

  var state = Object.assign({queue: todaysSet.slice(), index:0, loop:true, toneOn:false}, loadState());
  /* migrate string arrays -> object arrays */
  if(Array.isArray(state.queue) && state.queue.length && typeof state.queue[0]==="string"){
    state.queue = state.queue.map(function(id){ return {id:id}; });
  }
  if(!Array.isArray(state.queue) || !state.queue.length){ state.queue = todaysSet.slice(); state.index=0; }

  var player, metaPlayer, ready=false, metaReady=false;
  var btnPlay = document.getElementById("btnPlay"), btnPause = document.getElementById("btnPause");
  var btnPrev = document.getElementById("btnPrev"), btnNext = document.getElementById("btnNext");
  var btnLoop = document.getElementById("btnLoop"), btnTone = document.getElementById("btnTone");
  var gainSlider = document.getElementById("gain"), sIndex=document.getElementById("sIndex"), sState=document.getElementById("sState");
  var list=document.getElementById("queueList"), newId=document.getElementById("newId");
  var btnAdd=document.getElementById("btnAdd"), btnClear=document.getElementById("btnClear"), btnToday=document.getElementById("btnToday");
  var autoImport=document.getElementById("autoImport");

  /* Import/Export elements */
  var btnExportJSON=document.getElementById("btnExportJSON");
  var btnCopyJSON=document.getElementById("btnCopyJSON");
  var btnExportCSV=document.getElementById("btnExportCSV");
  var btnExportSnippet=document.getElementById("btnExportSnippet");
  var btnCopySnippet=document.getElementById("btnCopySnippet");
  var fileJSON=document.getElementById("fileJSON");
  var pasteJSON=document.getElementById("pasteJSON");
  var btnLoadJSON=document.getElementById("btnLoadJSON");
  var ioStatus=document.getElementById("ioStatus");

  function escapeHTML(s){return String(s).replace(/[&<>"']/g,function(m){return({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])});}
  function parseId(input){
    if(!input) return "";
    var s = input.trim();
    /* handle common formats: v=, youtu.be/, /shorts/ */
    var m = s.match(/[?&]v=([^&]+)/) || s.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/) || s.match(/youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/);
    return m ? m[1] : s;
  }
  function current(){ var i=Math.max(0,Math.min(state.index,state.queue.length-1)); return state.queue[i]; }
  function currentId(){ var c=current(); return c ? c.id : ""; }

  function render(){
    sIndex.textContent = state.queue.length ? (state.index+1)+" / "+state.queue.length : "–";
    btnLoop.classList.toggle("on", !!state.loop); btnLoop.textContent = "Loop: " + (state.loop ? "On" : "Off");
    btnTone.classList.toggle("on", !!state.toneOn); btnTone.textContent = "128.15 Hz Tone: " + (state.toneOn ? "On" : "Off");
    list.innerHTML = "";

    for(var i=0;i<state.queue.length;i++){
      (function(i){
        var item = state.queue[i];
        var li=document.createElement("li"); li.className="li";
        var idx=document.createElement("span"); idx.className="badge"; idx.textContent=(i+1<10?"0":"")+(i+1);

        var titleBtn=document.createElement("button"); titleBtn.className="titleBtn";
        titleBtn.textContent = item.title ? item.title : item.id;
        if(i===state.index){ titleBtn.classList.add("now"); }
        titleBtn.onclick=function(){ state.index=i; saveState(); render(); cueAndPlay(); };

        var actions=document.createElement("div"); actions.className="actions";

        var bEdit=document.createElement("button"); bEdit.className="chip"; bEdit.textContent="Edit";
        bEdit.onclick=function(ev){ openPopover(i, ev.currentTarget); };

        var bImport=document.createElement("button"); bImport.className="chip"; bImport.textContent="Import";
        bImport.onclick=function(ev){ importTitleFor(i, ev.currentTarget); };

        var bPlay=document.createElement("button"); bPlay.className="chip"; bPlay.textContent="Play";
        bPlay.onclick=function(){ state.index=i; saveState(); render(); cueAndPlay(); };

        var bRemove=document.createElement("button"); bRemove.className="chip"; bRemove.textContent="Remove";
        bRemove.onclick=function(){
          state.queue.splice(i,1);
          if(state.index>=state.queue.length) state.index=Math.max(0,state.queue.length-1);
          saveState(); render();
          if(!state.queue.length){ setStateText('queue empty'); }
          closePopover();
        };

        actions.appendChild(bEdit); actions.appendChild(bImport); actions.appendChild(bPlay); actions.appendChild(bRemove);

        li.appendChild(idx); li.appendChild(titleBtn); li.appendChild(actions);

        var meta=document.createElement("div"); meta.className="meta";
        var noteText=item.note ? item.note : "";
        meta.innerHTML = noteText ? ('<span class="note">'+escapeHTML(noteText)+'</span>') : '';
        li.appendChild(meta);

        if(item.info){
          var det=document.createElement("details"); det.className="info";
          var sum=document.createElement("summary"); sum.textContent="Info";
          var ibox=document.createElement("div"); ibox.className="ibox"; ibox.textContent=item.info;
          det.appendChild(sum); det.appendChild(ibox);
          li.appendChild(det);
        }

        list.appendChild(li);
      })(i);
    }
  }

  function setStateText(t){ sState.textContent=t; }

  /* YouTube players */
  window.onYouTubeIframeAPIReady=function(){
    player = new YT.Player('player', {
      videoId: currentId()||undefined, width:'100%', height:'100%',
      playerVars:{autoplay:0,controls:1,rel:0,iv_load_policy:3,modestbranding:1,playsinline:1,origin:location.origin},
      events:{
        onReady:function(){ ready=true; setStateText('ready'); },
        onStateChange:function(e){
          if(e.data===0){
            if(state.index<state.queue.length-1){ state.index+=1; saveState(); render(); cueAndPlay(); }
            else if(state.loop && state.queue.length){ state.index=0; saveState(); render(); cueAndPlay(); }
            else{ setStateText('ended'); }
          }else if(e.data===1){ setStateText('playing'); } else if(e.data===2){ setStateText('paused'); }
        }
      }
    });
    metaPlayer = new YT.Player('metaPlayer', {
      height:'1', width:'1',
      playerVars:{autoplay:0,controls:0,rel:0,iv_load_policy:3,modestbranding:1,playsinline:1,origin:location.origin},
      events:{ onReady:function(){ metaReady=true; } }
    });
  };
  function cueAndPlay(){ var id=currentId(); if(!id||!ready) return; player.loadVideoById(id); }

  /* Title import with optional focus back to the clicked control */
  var lastAnchorBtn = null;
  function importTitleFor(idx, anchor){
    if(anchor){ lastAnchorBtn = anchor; }
    if(!metaReady){ openPopover(idx, lastAnchorBtn); return; }
    var item = state.queue[idx];
    metaPlayer.cueVideoById(item.id);
    var tries=0, maxTries=60; /* ~9s max */
    var iv = setInterval(function(){
      tries++;
      var data = metaPlayer.getVideoData ? metaPlayer.getVideoData() : null;
      var title = data && data.title ? data.title.trim() : "";
      if(title || tries>=maxTries){
        clearInterval(iv);
        if(title){ item.title = title; saveState(); render(); }
        openPopover(idx, lastAnchorBtn || null);
      }
    }, 150);
  }

  /* Popover editor anchored to button */
  var pop = document.createElement("div"); pop.className="popover"; document.body.appendChild(pop);
  var mask = document.createElement("div"); mask.className="closeMask"; document.body.appendChild(mask);
  var editingIndex = -1;

  function openPopover(idx, anchorBtn){
    editingIndex = idx;
    var it = state.queue[idx];
    pop.innerHTML = ''
      + '<div class="hdr">Editing · '+escapeHTML(it.title || it.id)+'</div>'
      + '<div class="row"><input id="pTitle" type="text" placeholder="Title"></div>'
      + '<div class="row"><textarea id="pNote" placeholder="Personal note"></textarea></div>'
      + '<div class="row"><textarea id="pInfo" placeholder="Info (tasks, links, context)"></textarea></div>'
      + '<div class="pop-actions">'
      +   '<button id="pSave" class="primary">Save</button>'
      +   '<button id="pCancel">Cancel</button>'
      + '</div>';
    var pTitle=pop.querySelector("#pTitle"), pNote=pop.querySelector("#pNote"), pInfo=pop.querySelector("#pInfo");
    pTitle.value = it.title || ""; pNote.value = it.note || ""; pInfo.value = it.info || "";

    placePopover(anchorBtn);
    pop.classList.add("active"); mask.classList.add("active");

    pop.querySelector("#pSave").onclick=function(){
      var cur = state.queue[editingIndex];
      cur.title = pTitle.value.trim() || undefined;
      cur.note  = pNote.value.trim()  || undefined;
      cur.info  = pInfo.value.trim()  || undefined;
      saveState(); render(); closePopover();
    };
    pop.querySelector("#pCancel").onclick=function(){ closePopover(); };
  }
  function placePopover(anchorBtn){
    if(anchorBtn){
      var r = anchorBtn.getBoundingClientRect();
      var top = r.bottom + 8 + window.scrollY;
      var left = Math.min(window.scrollX + r.left, window.scrollX + window.innerWidth - 360);
      pop.style.top = top+"px"; pop.style.left = left+"px";
    }else{
      pop.style.top = (80 + window.scrollY) + "px";
      pop.style.left = "16px";
    }
  }
  function closePopover(){ pop.classList.remove("active"); mask.classList.remove("active"); editingIndex=-1; }
  mask.onclick=closePopover; document.addEventListener("keydown",function(e){ if(e.key==="Escape"){ closePopover(); } });

  /* Tone (128.15 Hz) */
  var audioCtx, osc, gainNode, unlocked=false, targetHz=128.15;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      gainNode=audioCtx.createGain();
      gainNode.gain.setValueAtTime(parseFloat(gainSlider.value||"0.22"), audioCtx.currentTime);
      gainNode.connect(audioCtx.destination);
    }
    if(audioCtx.state==="suspended"){ audioCtx.resume(); }
    unlocked=true;
  }
  function startTone(){
    ensureAudio(); if(osc) return;
    osc=audioCtx.createOscillator(); osc.type="sine"; osc.frequency.setValueAtTime(targetHz,audioCtx.currentTime); osc.connect(gainNode);
    var g=gainNode.gain, now=audioCtx.currentTime; g.cancelScheduledValues(now);
    g.setValueAtTime(0.0001,now); g.exponentialRampToValueAtTime(parseFloat(gainSlider.value||"0.22"), now+0.08);
    osc.start(); state.toneOn=true; saveState(); render();
  }
  function stopTone(){
    if(!osc||!audioCtx){ state.toneOn=false; saveState(); render(); return; }
    var now=audioCtx.currentTime, g=gainNode.gain; g.cancelScheduledValues(now);
    g.setValueAtTime(g.value,now); g.exponentialRampToValueAtTime(0.0001, now+0.06);
    var toStop=osc; setTimeout(function(){ try{toStop.stop()}catch(_){ } try{toStop.disconnect()}catch(_){ } }, 90);
    osc=null; state.toneOn=false; saveState(); render();
  }

  /* Controls */
  btnPlay.onclick=function(){ if(!unlocked){ ensureAudio(); } if(!state.queue.length){ setStateText('add videos'); return; } cueAndPlay(); if(state.toneOn){ startTone(); } };
  btnPause.onclick=function(){ if(ready){ player.pauseVideo(); } };
  btnPrev.onclick=function(){ if(!state.queue.length) return; state.index=(state.index-1+state.queue.length)%state.queue.length; saveState(); render(); cueAndPlay(); };
  btnNext.onclick=function(){ if(!state.queue.length) return; state.index=(state.index+1)%state.queue.length; saveState(); render(); cueAndPlay(); };
  btnLoop.onclick=function(){ state.loop=!state.loop; saveState(); render(); };
  btnTone.onclick=function(){ if(state.toneOn){ stopTone(); } else { startTone(); } };
  gainSlider.oninput=function(){ if(gainNode){ var now=audioCtx.currentTime; gainNode.gain.cancelScheduledValues(now); gainNode.gain.setValueAtTime(gainNode.gain.value,now); gainNode.gain.exponentialRampToValueAtTime(Math.max(0.0001, parseFloat(gainSlider.value||"0.22")), now+0.05); saveState(); } };

  /* Queue editing */
  btnAdd.onclick=function(){
    var id=parseId(newId.value); if(!id) return;
    var exists = state.queue.some(function(x){ return x.id===id; });
    if(!exists) state.queue.push({id:id});
    if(state.queue.length===1){ state.index=0; }
    saveState(); render();
    if(autoImport.checked){ importTitleFor(state.queue.length-1, null); }
    newId.value="";
  };
  btnClear.onclick=function(){ state.queue=[]; state.index=0; saveState(); render(); setStateText('queue cleared'); };
  btnToday.onclick=function(){ state.queue = todaysSet.slice(); state.index = 0; saveState(); render(); };

  /* Import/Export */
  function queueJSON(){
    return state.queue.map(function(x){ return { id:x.id, title:x.title, note:x.note, info:x.info }; });
  }
  function todayStamp(){
    var d=new Date(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
    return d.getFullYear()+mm+dd;
  }
  function download(filename, text, mime){
    var blob = new Blob([text], {type: mime});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(function(){ URL.revokeObjectURL(url); }, 1500);
  }
  var btnExportJSON=document.getElementById("btnExportJSON");
  var btnCopyJSON=document.getElementById("btnCopyJSON");
  var btnExportCSV=document.getElementById("btnExportCSV");
  var btnExportSnippet=document.getElementById("btnExportSnippet");
  var btnCopySnippet=document.getElementById("btnCopySnippet");
  var fileJSON=document.getElementById("fileJSON");
  var pasteJSON=document.getElementById("pasteJSON");
  var btnLoadJSON=document.getElementById("btnLoadJSON");
  var ioStatus=document.getElementById("ioStatus");

  btnExportJSON.onclick=function(){ download("froot-queue-"+todayStamp()+".json", JSON.stringify(queueJSON(),null,2), "application/json"); };
  btnCopyJSON.onclick=function(){
    var json=JSON.stringify(queueJSON(),null,2);
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(json).then(function(){ ioStatus.textContent="Copied JSON."; setTimeout(function(){ ioStatus.textContent=""; },1500); });
    }else{ pasteJSON.value=json; ioStatus.textContent="Copied JSON to box."; setTimeout(function(){ ioStatus.textContent=""; },1500); }
  };
  btnExportCSV.onclick=function(){
    var rows=[["id","title","note","info"]];
    for(var i=0;i<state.queue.length;i++){ var x=state.queue[i]; rows.push([x.id||"",x.title||"",x.note||"",x.info||""]); }
    var csv=rows.map(function(r){ return r.map(function(c){ var s=String(c).replace(/"/g,'""'); return '"'+s+'"'; }).join(","); }).join("\n");
    download("froot-queue-"+todayStamp()+".csv", csv, "text/csv");
  };
  function siteSnippet(){
    var json = JSON.stringify(queueJSON());
    return '<!-- Froot queue data -->\\n'
      + '<script type="application/json" id="froot-data">'+json.replace(/</g,"\\u003c")+'</script>\\n'
      + '<script>window.FROOT_DATA=JSON.parse(document.getElementById(\\'froot-data\\').textContent);</script>';
  }
  btnExportSnippet.onclick=function(){ download("froot-data-"+todayStamp()+".html", siteSnippet(), "text/html"); };
  btnCopySnippet.onclick=function(){
    var txt = siteSnippet();
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(function(){ ioStatus.textContent="Copied site snippet."; setTimeout(function(){ ioStatus.textContent=""; },1500); });
    }else{ pasteJSON.value = txt; ioStatus.textContent="Snippet in box below."; setTimeout(function(){ ioStatus.textContent=""; },1500); }
  };

  fileJSON.onchange=function(){
    var f=fileJSON.files[0]; if(!f) return;
    var reader=new FileReader();
    reader.onload=function(){
      try{ mergeQueue(JSON.parse(String(reader.result||"[]"))); ioStatus.textContent="Loaded file."; setTimeout(function(){ ioStatus.textContent=""; },1500); }
      catch(_){ ioStatus.textContent="Invalid JSON file."; setTimeout(function(){ ioStatus.textContent=""; },1500); }
    };
    reader.readAsText(f);
  };
  btnLoadJSON.onclick=function(){
    try{ mergeQueue(JSON.parse(String(pasteJSON.value||"[]"))); ioStatus.textContent="Loaded JSON."; setTimeout(function(){ ioStatus.textContent=""; },1500); }
    catch(_){ ioStatus.textContent="Invalid JSON."; setTimeout(function(){ ioStatus.textContent=""; },1500); }
  };
  function mergeQueue(items){
    if(!Array.isArray(items)) return;
    for(var i=0;i<items.length;i++){
      var it=items[i]; if(!it||!it.id) continue;
      var existing=state.queue.find(function(x){ return x.id===it.id; });
      if(existing){
        if(it.title) existing.title=it.title;
        if(it.note!=null) existing.note=it.note;
        if(it.info!=null) existing.info=it.info;
      }else{
        state.queue.push({id:it.id,title:it.title,note:it.note,info:it.info});
      }
    }
    saveState(); render();
  }

  /* Lifecycle */
  document.addEventListener("touchend", function once(){ document.removeEventListener("touchend", once, {passive:true}); ensureAudio(); if(state.toneOn){ startTone(); } }, {passive:true});
  document.addEventListener("click", function once(){ document.removeEventListener("click", once, true); ensureAudio(); if(state.toneOn){ startTone(); } }, true);
  document.addEventListener("visibilitychange", function(){ if(document.visibilityState!=="hidden" && state.toneOn){ startTone(); } });

  var init = loadState(); if(typeof init.gain==="number"){ gainSlider.value=String(init.gain); }
  autoImport.checked = !!init.autoImport;
  render();
})();
</script>
</body>
</html>
