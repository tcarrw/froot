<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Butterfly ‚Äî Marina (Spectrum Map)</title>
<meta name="theme-color" content="#0b0d11">
<meta name="description" content="Marina ‚Äî Butterfly spectrum map (C‚ÜíB). 7 blocks, tones (128/160 Hz), iPhone-safe audio unlock, self-checks, and YouTube embed.">
<style>
:root{
  --bg:#0b0d11; --ink:#eef0ff; --muted:#a8acc9; --accent:#b7a7ff;
  --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
  --glass:rgba(255,255,255,.06); --glass-strong:rgba(255,255,255,.12);
  --ok:#6ddc9d; --warn:#ffb464; --bad:#ff6d8a;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 700px at 80% -10%,rgba(160,170,255,.12),transparent 60%),linear-gradient(180deg,#0b0d11,#0b0d11 60%);
  color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
.container{max-width:1000px;margin:0 auto;padding:24px 16px 120px}
.card{
  position:relative; border-radius:var(--radius);
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); overflow:hidden;
}
.frost{backdrop-filter:blur(14px) saturate(120%); -webkit-backdrop-filter:blur(14px) saturate(120%)}
.header{padding:18px 18px 10px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
.title{font-weight:800; letter-spacing:.3px}
.badge{font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(183,167,255,.16); border:1px solid rgba(183,167,255,.35)}
.sub{color:var(--muted); font-size:13px}

.player-wrap{padding:14px}
.player{width:100%; aspect-ratio:16/9; border:0; border-radius:14px; filter:drop-shadow(0 10px 24px rgba(0,0,0,.45))}

.controls{display:grid; gap:14px; padding:10px 14px 18px; grid-template-columns:1fr}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.btn{
  appearance:none; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.08));
  color:var(--ink); padding:10px 14px; border-radius:14px; font-weight:700; letter-spacing:.2px; cursor:pointer;
  transition:transform .06s ease, box-shadow .2s ease; box-shadow:0 0 0 3px rgba(183,167,255,.18), 0 0 24px rgba(183,167,255,.14)
}
.btn:active{transform:translateY(1px) scale(.995)}
.slider{appearance:none; width:180px; height:8px; border-radius:999px; background:linear-gradient(90deg,#7ea9ff,#b7a7ff); outline:none; border:1px solid rgba(255,255,255,.22)}
.slider::-webkit-slider-thumb{appearance:none; width:20px; height:20px; border-radius:50%; background:radial-gradient(circle at 40% 35%,#fff,#dcd5ff 70%); border:1px solid rgba(183,167,255,.8)}
.toggle{display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}

.timeline{display:grid; gap:10px; padding:8px 14px 16px; grid-template-columns:repeat(7,1fr)}
.block{
  aspect-ratio:6/5; border-radius:14px; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center;
  text-align:center; color:#05060a; font-weight:800; letter-spacing:.3px; border:1px solid rgba(255,255,255,.18)
}
.block small{position:absolute; bottom:8px; left:10px; right:10px; color:#0b0d11; opacity:.9; font-weight:700}
.bC{background:linear-gradient(180deg,#f24,#b11)}       /* Red */
.bD{background:linear-gradient(180deg,#ffd166,#ffb700)} /* Amber */
.bE{background:linear-gradient(180deg,#ff9966,#ff6d3f)} /* Orange */
.bF{background:linear-gradient(180deg,#79a7ff,#3e7bff)} /* Blue */
.bG{background:linear-gradient(180deg,#fdfdfd,#d9e1ff)} /* White/Ice */
.bA{background:linear-gradient(180deg,#74dfa5,#35c487)} /* Green */
.bB{background:linear-gradient(180deg,#c9a8ff,#9a6dff)} /* Violet */

.status{display:grid; gap:10px; padding:10px 14px 16px; grid-template-columns:1fr 1fr 1fr}
.pill{border-radius:999px; padding:8px 10px; font-size:12px; font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.16); background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06))}
.dot{width:8px; height:8px; border-radius:50%; background:var(--muted)}
.ok .dot{background:var(--ok)} .warn .dot{background:var(--warn)} .bad .dot{background:var(--bad)}

.footer{position:fixed; bottom:10px; left:0; right:0; z-index:99; display:flex; justify-content:center; pointer-events:none}
.footer-inner{pointer-events:auto; max-width:1000px; width:calc(100% - 24px); margin:0 auto; padding:10px 12px; border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18); box-shadow:var(--shadow)}
@media (max-width: 920px){.timeline{grid-template-columns:repeat(4,1fr)}}
@media (max-width: 560px){.timeline{grid-template-columns:repeat(2,1fr)} .status{grid-template-columns:1fr}}
.highlight{outline:3px solid rgba(183,167,255,.45); box-shadow:0 0 0 4px rgba(183,167,255,.25), 0 10px 24px rgba(0,0,0,.35)}
.cycleTag{position:absolute; top:8px; right:10px; font-size:11px; font-weight:800; color:#0b0d11; background:rgba(255,255,255,.7); border-radius:999px; padding:2px 8px}
</style>
</head>
<body>
  <div class="container">
    <div class="card frost" id="card">
      <div class="header">
        <div class="title">ü¶ã Butterfly ‚Äî Marina (Spectrum Map)</div>
        <div class="badge">C‚ÜíD‚ÜíE‚ÜíF‚ÜíG‚ÜíA‚ÜíB</div>
        <div class="sub">7 blocks, Mirror palette UI. Tones 128/160. iPhone-safe audio unlock. Self-checks.</div>
      </div>

      <div class="player-wrap">
        <iframe id="yt" class="player" allow="autoplay; encrypted-media; picture-in-picture; fullscreen" allowfullscreen playsinline src="" title="Marina - Butterfly (YouTube)"></iframe>
      </div>

      <div class="controls">
        <div class="row">
          <button class="btn" id="start">Start ‚Ä¢ Enable Audio</button>
          <button class="btn" id="tone128">128 Hz</button>
          <button class="btn" id="tone160">160 Hz</button>
          <button class="btn" id="toneStop">Stop Tone</button>
          <input class="slider" type="range" min="0" max="1" step="0.01" value="0.35" id="toneVol" aria-label="Tone volume"><span class="sub" id="volLabel">Vol 35%</span>
        </div>
        <div class="row">
          <button class="btn" id="selfCheck">Self-Check</button>
          <button class="btn" id="savePoint">Save</button>
          <button class="btn" id="resetPref">Reset</button>
          <label class="toggle"><input type="checkbox" id="loopSpectrum" checked> Loop spectrum (wrap B‚ÜíC)</label>
        </div>
      </div>

      <div class="timeline" id="timeline">
        <div class="block bC" data-section="C"><div>Intro</div><small>Red ‚Ä¢ Awakening</small></div>
        <div class="block bD" data-section="D"><div>Verse</div><small>Amber ‚Ä¢ Cocoon</small></div>
        <div class="block bE" data-section="E"><div>Pre</div><small>Orange ‚Ä¢ Emergence</small></div>
        <div class="block bF" data-section="F"><div>Chorus I</div><small>Blue ‚Ä¢ Lift</small></div>
        <div class="block bG" data-section="G"><div>Chorus II</div><small>White ‚Ä¢ Air</small></div>
        <div class="block bA" data-section="A"><div>Bridge</div><small>Green ‚Ä¢ Clarity</small></div>
        <div class="block bB" data-section="B"><div>Final</div><small>Violet ‚Ä¢ Flight</small></div>
      </div>

      <div class="status">
        <div class="pill" id="stAudio"><span class="dot"></span><span>Audio Engine</span></div>
        <div class="pill" id="stTone"><span class="dot"></span><span>Tone Output</span></div>
        <div class="pill" id="stVideo"><span class="dot"></span><span>YouTube Embed</span></div>
      </div>

      <div class="notes sub" id="notes">
        Tap <em>Start</em> once on iPhone/iPad to unlock audio. 128 Hz = ground; 160 Hz = flight. ‚ÄúSave‚Äù keeps section + tone/vol in localStorage.
      </div>
    </div>
    <div style="height:40px"></div>
  </div>

  <div class="footer">
    <div class="footer-inner">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="sub">Marina ‚Ä¢ Butterfly ‚Ä¢ Mirror palette</div>
        <div class="row">
          <button class="btn" id="prev">‚óÄ Prev</button>
          <button class="btn" id="next">Next ‚ñ∂</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Config ===== */
const DEFAULT_YT_ID = 'Cr-SqRWImmI';
const STORAGE = { yt:'bfly_yt', section:'bfly_section', toneHz:'bfly_tone_hz', vol:'bfly_tone_vol', loop:'bfly_loop' };
const order = ['C','D','E','F','G','A','B'];

/* ===== State ===== */
let audioCtx=null, gain=null, osc=null, currentHz=null;

/* ===== DOM helpers ===== */
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const setStatus=(el,st)=>{ el.classList.remove('ok','warn','bad'); el.classList.add(st); };
const markSection=(code)=>{
  qsa('.block').forEach(b=>b.classList.remove('highlight'));
  const el = qsa('.block').find(b=>b.dataset.section===code);
  if(el) el.classList.add('highlight');
  // add/remove cycle tag based on how many wraps happened (stored as integer on element dataset)
};

/* ===== YouTube (no external libs, user-gesture friendly) ===== */
function getYT(){ return localStorage.getItem(STORAGE.yt) || DEFAULT_YT_ID; }
function loadYT(mutedAutoplay){
  const id=getYT();
  const params = new URLSearchParams({
    autoplay: mutedAutoplay? '1':'0',
    mute: mutedAutoplay? '1':'0',
    playsinline:'1', rel:'0', modestbranding:'1', enablejsapi:'1'
  });
  qs('#yt').src = `https://www.youtube.com/embed/${id}?${params.toString()}`;
  setStatus(qs('#stVideo'), 'ok');
}

/* ===== Audio / Tone ===== */
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    gain = audioCtx.createGain(); gain.gain.value = Number(qs('#toneVol').value);
    gain.connect(audioCtx.destination);
  }
  return audioCtx;
}
function playTone(hz){
  ensureAudio(); stopTone();
  osc = audioCtx.createOscillator(); osc.type='sine'; osc.frequency.value=hz; osc.connect(gain); osc.start();
  currentHz = hz;
  setStatus(qs('#stAudio'), (audioCtx.state==='running')? 'ok':'warn'); setStatus(qs('#stTone'),'ok');
}
function stopTone(){
  if(osc){ try{osc.stop()}catch{}; try{osc.disconnect()}catch{}; osc=null; currentHz=null; }
  setStatus(qs('#stTone'),'warn');
}
function setVolume(v){ if(gain){ gain.gain.value=v; } qs('#volLabel').textContent = `Vol ${Math.round(v*100)}%`; }

/* ===== Persistence ===== */
function setSection(code){ localStorage.setItem(STORAGE.section, code); markSection(code); }
function getSection(){ return localStorage.getItem(STORAGE.section) || order[0]; }

/* ===== Self-Check ===== */
function selfCheck(){
  // Audio engine check
  try{ ensureAudio(); setStatus(qs('#stAudio'), audioCtx.state==='running' ? 'ok':'warn'); }
  catch(e){ setStatus(qs('#stAudio'),'bad'); }
  // Quick audible blip (very short & quiet)
  const prevVol = Number(qs('#toneVol').value)||0.35; const testVol = Math.max(0.05, prevVol);
  setVolume(testVol); playTone(440); setTimeout(()=>{ stopTone(); setVolume(prevVol); }, 180);
  // Video embed presence
  const ok = !!qs('#yt').src; setStatus(qs('#stVideo'), ok ? 'ok':'warn');
}

/* ===== Navigation ===== */
function jump(dir){
  const loopOn = qs('#loopSpectrum').checked;
  const cur = getSection(); const idx = order.indexOf(cur);
  let ni = idx + (dir==='next'? +1 : -1);
  if(loopOn){ if(ni<0) ni = order.length-1; if(ni>=order.length) ni=0; }
  else{ ni = Math.min(Math.max(ni,0), order.length-1); }
  setSection(order[ni]);
  // Visual Cycle tag on wrap
  const timeline = qs('#timeline');
  const tag = qs('.cycleTag', timeline) || document.createElement('div');
  tag.className='cycleTag';
  if(loopOn && idx===order.length-1 && dir==='next'){ tag.textContent='Cycle 2'; timeline.appendChild(tag); }
  if(!loopOn || (ni!==0)) { if(tag && tag.parentNode===timeline) timeline.removeChild(tag); }
}

/* ===== Events ===== */
qs('#start').addEventListener('click', async ()=>{
  ensureAudio();
  if(audioCtx.state==='suspended'){ try{ await audioCtx.resume(); }catch{} }
  setStatus(qs('#stAudio'), audioCtx.state==='running'? 'ok':'warn');
  loadYT(true); // muted autoplay allowed on iOS after user gesture
});
qs('#tone128').addEventListener('click', ()=>{ playTone(128); localStorage.setItem(STORAGE.toneHz,'128'); });
qs('#tone160').addEventListener('click', ()=>{ playTone(160); localStorage.setItem(STORAGE.toneHz,'160'); });
qs('#toneStop').addEventListener('click', ()=>{ stopTone(); });
qs('#toneVol').addEventListener('input', e=>{ const v=Number(e.target.value); setVolume(v); localStorage.setItem(STORAGE.vol,String(v)); });

qs('#selfCheck').addEventListener('click', selfCheck);
qs('#savePoint').addEventListener('click', ()=>{
  if(currentHz) localStorage.setItem(STORAGE.toneHz,String(currentHz));
  setStatus(qs('#stAudio'),'ok');
});
qs('#resetPref').addEventListener('click', ()=>{
  Object.values(STORAGE).forEach(k=>localStorage.removeItem(k));
  stopTone(); loadYT(false); setSection(order[0]); setVolume(0.35); qs('#toneVol').value=0.35;
  setStatus(qs('#stAudio'),'warn'); setStatus(qs('#stTone'),'warn'); setStatus(qs('#stVideo'),'warn');
});
qsa('.block').forEach(b=> b.addEventListener('click', ()=>{
  setSection(b.dataset.section);
  ensureAudio(); stopTone();
  const hzMap={C:110,D:132,E:148,F:160,G:172,A:176,B:196}; const hz = hzMap[b.dataset.section]||160;
  playTone(hz); setTimeout(()=>stopTone(), 160);
}));
qs('#prev').addEventListener('click', ()=>jump('prev'));
qs('#next').addEventListener('click', ()=>jump('next'));
qs('#loopSpectrum').addEventListener('change', e=> localStorage.setItem(STORAGE.loop, e.target.checked?'1':'0'));

/* ===== Boot ===== */
(function boot(){
  // initial embed without autoplay (until Start)
  loadYT(false);
  // restore section, volume, tone
  markSection(getSection());
  const savedVol = Number(localStorage.getItem(STORAGE.vol) || '0.35'); qs('#toneVol').value=savedVol; setVolume(savedVol);
  const loopSaved = localStorage.getItem(STORAGE.loop); if(loopSaved!==null){ qs('#loopSpectrum').checked = (loopSaved==='1'); }
  setStatus(qs('#stAudio'),'warn'); setStatus(qs('#stTone'),'warn'); setStatus(qs('#stVideo'),'ok');
})();
</script>
</body>
</html>
