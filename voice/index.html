<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Voice & Resonance — FrootX Skill</title>
<meta name="description" content="Three-day Voice & Resonance skill: drills, hum layers, and notes.">
<meta name="theme-color" content="#0B0F19">
<style>
  :root{
    --bg:#0B0F19;--ink:#E6EAF2;--muted:#A7B0C2;--card:#101728;--line:rgba(230,234,242,.14);
    --hi:#A4E8FF;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  a{color:var(--hi);text-decoration:none}
  .wrap{max-width:820px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--ok)}
  .sub{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
  h1{font-size:20px;margin:0}
  h2{font-size:16px;margin:0 0 8px}
  button{appearance:none;border:1px solid var(--line);background:#0E1423;color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2A3550}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .stack{display:grid;gap:10px}
  .k{color:var(--muted);font-size:12px}
  .bullets{margin:0;padding-left:18px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  input[type="range"]{width:100%}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0E1423;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
  textarea{width:100%;min-height:72px;background:#0E1423;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;resize:vertical}
  .small{font-size:12px;color:var(--muted)}
  .tag{font-size:11px;color:#C1C9D8;border:1px solid var(--line);padding:3px 8px;border-radius:999px}
  .sep{height:1px;background:var(--line);margin:8px 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="dot" aria-hidden="true"></div>
      <div>
        <h1>Voice & Resonance <span class="tag">3-Day Skill</span></h1>
        <div class="sub">Froot → Perception & Expression • Hums + Pop Blend • Notes saved locally</div>
      </div>
    </header>

    <section class="card" id="today">
      <h2 id="todayTitle">Today</h2>
      <div class="small" id="windowInfo"></div>
      <div id="drills" class="stack" aria-live="polite"></div>
      <div id="checkpoint" class="stack"></div>
    </section>

    <section class="card">
      <h2>Audio: Pop Track + Hum Layers</h2>
      <div class="row">
        <audio id="pop" controls preload="none" style="width:100%"></audio>
      </div>
      <div class="sep"></div>
      <div class="grid">
        <div>
          <div class="row"><strong>Hum Layers</strong><span class="k" id="humKey">Key: —</span></div>
          <div id="humList" class="stack" aria-live="polite"></div>
        </div>
        <div>
          <div class="row"><strong>Blend</strong><span class="k">0 = only hums, 100 = only pop</span></div>
          <input type="range" id="blend" min="0" max="100" value="70" aria-label="Blend slider">
          <div class="small" id="blendVal">Blend: 70</div>
          <div class="sep"></div>
          <div class="stack">
            <label class="small">Track: <span id="trackTitle">—</span></label>
            <div class="row">
              <button id="prevTrack" aria-label="Previous track">Prev</button>
              <button id="nextTrack" aria-label="Next track">Next</button>
              <button id="restart" aria-label="Restart pop track">Restart</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>One-Line Note</h2>
      <textarea id="note" placeholder="One clear line (sensation + improvement)"></textarea>
      <div class="row">
        <button id="saveNote">Save Note</button>
        <span id="noteStatus" class="small"></span>
      </div>
    </section>

    <section class="card">
      <h2>About</h2>
      <ul class="bullets">
        <li>Loads drills from <code>data/plan.json</code> and the playlist from <code>data/playlist.json</code>.</li>
        <li>Use <strong>Ask GPT</strong> to copy a coaching prompt for each drill.</li>
        <li>Hums are looped mono WAVs; adjust <em>Blend</em> to mix with a pop track in the same key.</li>
        <li>Notes save locally (<code>localStorage</code>), keyed by date.</li>
      </ul>
    </section>
  </div>

<script>
(function(){
  var state = {
    plan:null, list:null, dayIndex:0, humNodes:[], humGains:[], ctx:null, srcs:[], gainMaster:null,
    blend:70, trackIdx:0, ready:false,
    sequencedStarted:false,
    seqDelay:1.0
  };

  function q(id){return document.getElementById(id)}
  function setText(id, t){var el=q(id); if(el) el.textContent=t}

  function copyText(text, statusEl){
    function ok(){ if(statusEl){ statusEl.textContent="Prompt copied"; statusEl.className="small ok"} }
    function fail(){ if(statusEl){ statusEl.textContent="Copy failed — select manually"; statusEl.className="small warn"} }
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(text).then(ok, fail);
    }else{
      var ta=document.createElement("textarea"); ta.value=text; ta.style.position="fixed"; ta.style.opacity="0";
      document.body.appendChild(ta); ta.focus(); ta.select();
      try{ document.execCommand("copy"); ok(); }catch(e){ fail(); }
      document.body.removeChild(ta);
    }
  }

  function todayKey(d){ return d.toISOString().slice(0,10); }
  function parseISO(s){ try{ return new Date(s); }catch(e){ return new Date(); } }

  function ensureAudioCtx(){
    if(state.ctx) return;
    var AC = window.AudioContext || window.webkitAudioContext;
    state.ctx = new AC();
    state.gainMaster = state.ctx.createGain();
    state.gainMaster.gain.value = 0.6;
    state.gainMaster.connect(state.ctx.destination);
  }

  function loadHum(url, idx, gain){
    return fetch(url).then(function(r){return r.arrayBuffer()})
    .then(function(buf){ return state.ctx.decodeAudioData(buf) })
    .then(function(audioBuf){
      var src = state.ctx.createBufferSource();
      src.buffer = audioBuf; src.loop = true;
      var g = state.ctx.createGain(); g.gain.value = gain;
      src.connect(g); g.connect(state.gainMaster);
      state.srcs[idx] = src; state.humGains[idx] = g;
    }).catch(function(){});
  }

  function startHums(sequential){
    if(!state.ctx) return;
    if(!state.srcs.length) return;
    if(sequential && !state.sequencedStarted){
      var now = state.ctx.currentTime;
      for(var i=0;i<state.srcs.length;i++){
        var s = state.srcs[i];
        if(s && !s.started){
          try{ s.start(now + (i * state.seqDelay)); s.started = true; }catch(e){}
        }
      }
      state.sequencedStarted = true;
      return;
    }
    for(var j=0;j<state.srcs.length;j++){
      var sj = state.srcs[j];
      if(sj && !sj.started){
        try{ sj.start(0); sj.started = true; }catch(e){}
      }
    }
  }

  function stopHums(){
    for(var i=0;i<state.srcs.length;i++){
      var s=state.srcs[i];
      if(s && s.started){ try{ s.stop(0); }catch(e){} }
    }
    state.srcs = [];
  }

  function setBlend(v){
    var pop = q("pop");
    var popVol = Math.min(1, Math.max(0, v/100));
    var humVol = 1 - popVol;
    if(state.gainMaster) state.gainMaster.gain.value = humVol;
    if(pop) pop.volume = popVol;
    state.blend = v;
    setText("blendVal","Blend: "+v);
  }

  function renderDrills(){
    var drillsEl = q("drills"); drillsEl.innerHTML = "";
    var checkpointEl = q("checkpoint"); checkpointEl.innerHTML = "";

    var day = state.plan.days[state.dayIndex] || {};
    setText("todayTitle", day.label || "Today");
    var windowInfo = "Window: " + state.plan.window.start + " → +" + state.plan.window.days + " days";
    setText("windowInfo", windowInfo);

    (day.drills||[]).forEach(function(step, i){
      var card = document.createElement("div");
      card.className = "card";
      var title = document.createElement("div");
      title.innerHTML = "<strong>Drill " + (i+1) + ":</strong> " + step.text;
      var row = document.createElement("div"); row.className="row";
      var btn = document.createElement("button"); btn.textContent="Ask GPT";
      var stat = document.createElement("span"); stat.className="small"; stat.textContent="";
      btn.addEventListener("click", function(){ copyText(step.prompt||"", stat); });
      row.appendChild(btn); row.appendChild(stat);
      card.appendChild(title); card.appendChild(row);
      drillsEl.appendChild(card);
    });

    if(day.checkpoint_prompt){
      var ck = document.createElement("div"); ck.className="card";
      var t = document.createElement("div"); t.innerHTML = "<strong>Checkpoint:</strong> day readiness test";
      var row = document.createElement("div"); row.className="row";
      var b = document.createElement("button"); b.textContent="Ask GPT (Checkpoint)";
      var s = document.createElement("span"); s.className="small"; s.textContent="";
      b.addEventListener("click", function(){ copyText(day.checkpoint_prompt, s); });
      row.appendChild(b); row.appendChild(s);
      ck.appendChild(t); ck.appendChild(row);
      checkpointEl.appendChild(ck);
    }
  }

  function loadPlaylist(){
    fetch("data/playlist.json").then(function(r){return r.json()}).then(function(j){
      state.list = j;
      setText("humKey", "Key: " + (j.key||"—"));
      state.trackIdx = 0;
      setPopTrack(0, true);

      var humList = q("humList"); humList.innerHTML = "";
      (j.layers && j.layers.hums ? j.layers.hums : []).forEach(function(h, idx){
        var row = document.createElement("div"); row.className="row pill"; row.setAttribute("data-idx", idx);
        var chk = document.createElement("input"); chk.type="checkbox"; chk.checked=true; chk.setAttribute("aria-label","Toggle hum "+h.name);
        var lab = document.createElement("span"); lab.textContent = h.name + " ("+h.freq+" Hz)";
        var rng = document.createElement("input"); rng.type="range"; rng.min="0"; rng.max="100";
        var startGain = Math.round(((h.gain!=null?h.gain:0.2))*100);
        rng.value = startGain; rng.setAttribute("aria-label","Gain for "+h.name);
        row.appendChild(chk); row.appendChild(lab); row.appendChild(rng);
        humList.appendChild(row);

        function ensureAndLoad(){
          ensureAudioCtx();
          if(!state.srcs[idx]){
            loadHum(h.file, idx, startGain/100).then(function(){});
          }
        }

        chk.addEventListener("change", function(){
          ensureAndLoad();
          var g = state.humGains[idx]; if(!g) return;
          g.gain.value = chk.checked ? (rng.value/100) : 0;
        });

        rng.addEventListener("input", function(){
          ensureAndLoad();
          var g = state.humGains[idx]; if(!g) return;
          var on = chk.checked ? 1 : 0;
          g.gain.value = (rng.value/100) * on;
        });

        row.addEventListener("pointerdown", function(){
          ensureAndLoad();
          startHums(true);
        }, {passive:true});
      });

      var blend = q("blend");
      blend.addEventListener("input", function(){ setBlend(parseInt(blend.value,10)); });

      q("restart").addEventListener("click", function(){
        var pop = q("pop"); try{ pop.currentTime = 0; pop.play(); }catch(e){}
        ensureAudioCtx();
        startHums(false);
      });
      q("prevTrack").addEventListener("click", function(){ setPopTrack(state.trackIdx-1, true); });
      q("nextTrack").addEventListener("click", function(){ setPopTrack(state.trackIdx+1, true); });

      setBlend(state.blend);
    }).catch(function(){});
  }

  function setPopTrack(i, autoplay){
    if(!state.list || !state.list.tracks || !state.list.tracks.length) return;
    var n = state.list.tracks.length;
    state.trackIdx = ( (i % n) + n ) % n;
    var t = state.list.tracks[state.trackIdx];
    setText("trackTitle", t.title || "—");
    var el = q("pop");
    if(t.url){ el.src = t.url; } else { el.removeAttribute("src"); }
    try{ if(autoplay){ el.play().catch(function(){}); } }catch(e){}
  }

  function loadPlan(){
    fetch("data/plan.json").then(function(r){return r.json()}).then(function(j){
      state.plan = j;
      var start = parseISO(j.window && j.window.start ? j.window.start : new Date().toISOString());
      var now = new Date();
      var ms = now - start;
      var idx = Math.floor(ms / (24*60*60*1000));
      if(idx < 0) idx = 0;
      if(idx > (j.days.length-1)) idx = j.days.length - 1;
      state.dayIndex = idx;
      renderDrills();
    }).catch(function(){});
  }

  function initNotes(){
    var key = "voice-" + todayKey(new Date());
    var note = q("note");
    var saved = localStorage.getItem(key);
    if(saved) note.value = saved;
    q("saveNote").addEventListener("click", function(){
      try{
        localStorage.setItem(key, note.value || "");
        var ns = q("noteStatus"); ns.textContent = "Saved"; ns.className="small ok";
        setTimeout(function(){ ns.textContent=""; }, 1500);
      }catch(e){
        var ns2 = q("noteStatus"); ns2.textContent = "Save failed"; ns2.className="small err";
      }
    });
  }

  loadPlan();
  loadPlaylist();
  initNotes();
})();
</script>
</body>
</html>
